var monica = monica || {};
(function () {

var example_config = {
 "sim": {
  "time": {
   "startDate": "1991-01-01",
   "endDate": "1992-12-31"
  },
  "switch": {
   "useSecondaryYieldOn": false,
   "nitrogenResponseOn": true,
   "waterDeficitResponseOn": true,
   "emergenceMoistureControlOn": false,
   "emergenceFloodingControlOn": false
  },
  "init": {
   "percentageFC": 1,
   "soilNitrate": 0.001,
   "soilAmmonium": 0.0001
  }
 },
 "site": {
  "latitude": 52.2,
  "slope": 0,
  "heightNN": 38,
  "atmosphericCO2": 380,
  "windSpeedHeight": 2.5,
  "leachingDepth": 1.5,
  "NDeposition": 20,
  "groundwaterDepthMin": 5,
  "groundwaterDepthMax": 5,
  "groundwaterDepthMinMonth": "April",
  "horizons": [
   {
    "thickness": 0.2,
    "Corg": 0.05,
    "textureClass": "Ls2",
    "sand": 0.15,
    "clay": 0.24,
    "sceleton": 0.02,
    "poreVolume": 0.45,
    "fieldCapacity": 0.33,
    "permanentWiltingPoint": 0.2,
    "pH": 6.9,
    "CN": 10,
    "bulkDensity": 1400
   },
   {
    "thickness": 0.5,
    "Corg": 0.05,
    "textureClass": "Ls2",
    "sand": 0.15,
    "clay": 0.24,
    "sceleton": 0.02,
    "poreVolume": 0.45,
    "fieldCapacity": 0.33,
    "permanentWiltingPoint": 0.2,
    "pH": 6.9,
    "CN": 10,
    "bulkDensity": 1400
   },
   {
    "thickness": 2,
    "Corg": 0.05,
    "textureClass": "Ls2",
    "sand": 0.15,
    "clay": 0.24,
    "sceleton": 0.02,
    "poreVolume": 0.45,
    "fieldCapacity": 0.33,
    "permanentWiltingPoint": 0.2,
    "pH": 6.9,
    "CN": 10,
    "bulkDensity": 1400
   }
  ]
 },
 "crop": {
  "crops": [
   {
    "name": {
     "id": 3,
     "name": "winter rye",
     "gen_type": ""
    },
    "sowingDate": "1991-10-01",
    "rowWidth": 5,
    "plantSpace": 5,
    "plantDryWeight": 225,
    "percNTRansplant": 0.07,
    "finalHarvestDate": "1992-08-01",
    "residuesRemoval": 0.85,
    "tillageOperations": [
     {
      "date": "1991-09-01",
      "method": "Plough",
      "depth": 30
     }
    ],
    "irrigations": [
     {
      "date": "1992-06-01",
      "method": "Sprinkler",
      "eventType": "Fixed",
      "threshold": 0.2,
      "area": 1,
      "amount": 5,
      "NConc": 0
     }
    ],
    "organicFertilisers": [
     {
      "date": "1992-05-01",
      "method": "Fixed",
      "type": {
       "id": 3,
       "om_type": "cattle slurry"
      },
      "amount": 30
     }
    ],
    "mineralFertilisers": [
     {
      "date": "1992-04-01",
      "method": "Fixed",
      "type": {
       "id": 1,
       "name": "Ammonium Nitrate"
      },
      "amount": 40
     }
    ]
   }
  ]
 }
};
var ENVIRONMENT_IS_NODE="object"==typeof process&&"function"==typeof require,ENVIRONMENT_IS_WEB="object"==typeof window,ENVIRONMENT_IS_WORKER="function"==typeof importScripts,DEBUG=!1,VERBOSE=!0,MSG={INFO:0,WARN:1,ERROR:2,DEBUG:3},UNDEFINED=-9999.9,UNDEFINED_INT=-9999,ROOT=0,LEAF=1,SHOOT=2,STORAGE_ORGAN=3,abs=Math.abs,acos=Math.acos,asin=Math.asin,atan=Math.atan,ceil=Math.ceil,cos=Math.cos,exp=Math.exp,floor=Math.floor,int=function(o){return 0|o},log=Math.log,log10=function(o){return Math.log(o)/Math.LN10},max=Math.max,min=Math.min,pow=Math.pow,round=Math.round,fixed=function(o,t){return t.toFixed(o)},roundN=function(o,t){return parseFloat(t.toFixed(o))},sin=Math.sin,sqrt=Math.sqrt,tan=Math.tan,PI=Math.PI,ResultId=["primaryYield","secondaryYield","sumFertiliser","sumIrrigation","sumMineralisation","avg10cmMonthlyAvgCorg","avg30cmMonthlyAvgCorg","mean90cmMonthlyAvgWaterContent","sum90cmYearlyNatDay","monthlySumGroundWaterRecharge","monthlySumNLeaching","cropHeight","sum90cmYearlyNO3AtDay","sum90cmYearlyNH4AtDay","maxSnowDepth","sumSnowDepth","sumFrostDepth","avg30cmSoilTemperature","sum30cmSoilTemperature","avg0_30cmSoilMoisture","avg30_60cmSoilMoisture","avg60_90cmSoilMoisture","waterFluxAtLowerBoundary","avg0_30cmCapillaryRise","avg30_60cmCapillaryRise","avg60_90cmCapillaryRise","avg0_30cmPercolationRate","avg30_60cmPercolationRate","avg60_90cmPercolationRate","sumSurfaceRunOff","evapotranspiration","transpiration","evaporation","biomassNContent","aboveBiomassNContent","sumTotalNUptake","sum30cmSMB_CO2EvolutionRate","NH3Volatilised","sumNH3Volatilised","sum30cmActDenitrificationRate","leachingNAtBoundary","yearlySumNLeaching","yearlySumGroundWaterRecharge","sumETaPerCrop","cropname","primaryYieldTM","secondaryYieldTM","monthlySurfaceRunoff","monthlyPrecip","monthlyETa","monthlySoilMoistureL0","monthlySoilMoistureL1","monthlySoilMoistureL2","monthlySoilMoistureL3","monthlySoilMoistureL4","monthlySoilMoistureL5","monthlySoilMoistureL6","monthlySoilMoistureL7","monthlySoilMoistureL8","monthlySoilMoistureL9","monthlySoilMoistureL10","monthlySoilMoistureL11","monthlySoilMoistureL12","monthlySoilMoistureL13","monthlySoilMoistureL14","monthlySoilMoistureL15","monthlySoilMoistureL16","monthlySoilMoistureL17","monthlySoilMoistureL18","daysWithCrop","NStress","WaterStress","HeatStress","OxygenStress","dev_stage"],perCropResults=["primaryYield","secondaryYield","primaryYieldTM","secondaryYieldTM","sumIrrigation","biomassNContent","aboveBiomassNContent","daysWithCrop","sumTotalNUptake","cropHeight","sumETaPerCrop","cropname","id","NStress","WaterStress","HeatStress","OxygenStress"],organicConstants={po_UreaMolecularWeight:.06006,po_Urea_to_N:.46667,po_NH3MolecularWeight:.01401,po_NH4MolecularWeight:.01401,po_H2OIonConcentration:1,po_pKaHNO2:3.29,po_pKaNH3:6.5,po_SOM_to_C:.57,po_AOM_to_C:.45},Climate={tmin:0,tmax:1,tavg:2,globrad:3,wind:4,precip:5,sunhours:6,relhumid:7};Date.prototype.isValid=function(){return"Invalid Date"!==this.toDateString()},Date.prototype.isLeapYear=function(){return 366===ceil((new Date(this.getFullYear()+1,0,1)-new Date(this.getFullYear(),0,1))/864e5)};var logger=function(o,t){if(ENVIRONMENT_IS_WORKER){if(o!==MSG.INFO||VERBOSE)switch(o){case MSG.INFO:postMessage({info:t});break;case MSG.WARN:postMessage({warn:t});break;case MSG.ERROR:postMessage({error:t});break;case MSG.DEBUG:postMessage({debug:t});break;default:postMessage({msg:t})}}else if(o!==MSG.INFO||VERBOSE)switch(o){case MSG.INFO:console.log("info: "+t);break;case MSG.WARN:console.log("warn: "+t);break;case MSG.ERROR:console.log("error: "+t);break;case MSG.DEBUG:console.log("debug: "+t);break;default:console.log(t)}};

var debugArgs=function(r,n){if(DEBUG)for(var t=Array.prototype.slice.call(r),e=function(r){return r instanceof Function?!1:"object"==typeof r?null===r||void 0===r:"string"==typeof r||"boolean"===r?null===r||void 0===r:isNaN(r)||null===r||void 0===r||1/0===r},a=function(r){logger(MSG.DEBUG,"args: "+JSON.stringify(r,null,2))},o=0,i=t.length;i>o;o++){var s=t[o];if(s&&"object"==typeof s){if(Array.isArray(s))s.forEach(function(r){if(r&&"object"==typeof r){if(isTypedArray(r)){for(var n=0,t=s.length;t>n;n++)if(e(s[n]))throw a(s),s}else if(Array.isArray(r))r.forEach(function(n){if(e(n))throw a(r),n});else for(var o in r)if(r.hasOwnProperty(o)&&e(r[o]))throw a(r),o}else if(e(r))throw a(s),r});else if(isTypedArray(s)){for(var o=0,i=s.length;i>o;o++)if(e(s[o]))throw a(s),s}else for(var f in s)if(s.hasOwnProperty(f)&&e(s[f]))throw a(s),s}else if(e(s))throw a(t),s}},isTypedArray=function(r){return r instanceof Int8Array||r instanceof Uint8Array||r instanceof Uint8ClampedArray||r instanceof Int16Array||r instanceof Uint16Array||r instanceof Int32Array||r instanceof Uint32Array||r instanceof Float64Array||r instanceof Float64Array},debug=function(){return DEBUG?"object"!=typeof arguments[0]||void 0==arguments[0].length||Array.isArray(arguments[0])||isTypedArray(arguments[0])?void(2===arguments.length?("string"==typeof arguments[1]&&logger(MSG.DEBUG,arguments[1]+" = "+("object"==typeof arguments[0]?JSON.stringify(arguments[0],null,1):arguments[0])),"string"==typeof arguments[0]&&logger(MSG.DEBUG,arguments[0]+" = "+("object"==typeof arguments[1]?JSON.stringify(arguments[1],null,1):arguments[1]))):"string"==typeof arguments[0]?logger(MSG.DEBUG,arguments[0]):logger(MSG.DEBUG,arguments[0])):debugArgs(arguments[0]):void 0};

var Tools={texture2KA5:function(s,t){var S="",u=100-(100*s+100*t);if(s+t+u!=100)throw"(sand + clay + silt) != 100: "+(s+t+u);return S=5>=t?10>=u?"Ss":25>=u?"Su2":40>=u?"Su3":50>=u?"Su4":80>=u?"Us":"Uu":8>=t?10>=u?"St2":25>=u?"Sl2":40>=u?"Su3":50>=u?"Su4":80>=u?"Us":"Uu":12>=t?10>=u?"St2":40>=u?"Sl3":50>=u?"Slu":65>=u?"Uls":"Ut2":17>=t?10>=u?"St2":40>=u?"Sl4":50>=u?"Slu":65>=u?"Uls":"Ut3":25>=t?15>=u?"St3":30>=u?"Ls4":40>=u?"Ls3":50>=u?"Ls2":65>=u?"Lu":"Ut4":30>=t?15>=u?"Ts4":30>=u?"Lts":50>=u?"Lt2":65>=u?"Lu":"Tu4":35>=t?15>=u?"Ts4":30>=u?"Lts":50>=u?"Lt2":65>=u?"Tu3":"Tu4":45>=t?15>=u?"Ts3":30>=u?"Lts":50>=u?"Lt3":"Tu3":65>=t?15>=u?"Ts2":30>=u?"Tl":"Tu2":"Tt"},KA52sand:function(s){var t=0;return t="fS"==s?.84:"fSms"==s?.86:"fSgs"==s?.88:"gS"==s?.93:"mSgs"==s?.96:"mSfs"==s?.93:"mS"==s?.96:"Ss"==s?.93:"Sl2"==s?.76:"Sl3"==s?.65:"Sl4"==s?.6:"Slu"==s?.43:"St2"==s?.84:"St3"==s?.71:"Su2"==s?.8:"Su3"==s?.63:"Su4"==s?.56:"Ls2"==s?.34:"Ls3"==s?.44:"Ls4"==s?.56:"Lt2"==s?.3:"Lt3"==s?.2:"LtS"==s?.42:"Lu"==s?.19:"Uu"==s?.1:"Uls"==s?.3:"Us"==s?.31:"Ut2"==s?.13:"Ut3"==s?.11:"Ut4"==s?.09:"Utl"==s?.19:"Tt"==s?.17:"Tl"==s?.17:"Tu2"==s?.12:"Tu3"==s?.1:"Ts3"==s?.52:"Ts2"==s?.37:"Ts4"==s?.62:"Tu4"==s?.05:"L"==s?.35:"S"==s?.93:"U"==s?.1:"T"==s?.17:"HZ1"==s?.3:"HZ2"==s?.3:"HZ3"==s?.3:"Hh"==s?.15:"Hn"==s?.15:.66},KA52clay:function(s){var t=0;return"fS"==s?t=.02:"fSms"==s?t=.02:"fSgs"==s?t=.02:"gS"==s?t=.02:"mSgs"==s?t=.02:"mSfs"==s?t=.02:"mS"==s?t=.02:"Ss"==s?t=.02:"Sl2"==s?t=.06:"Sl3"==s?t=.1:"Sl4"==s?t=.14:"Slu"==s?t=.12:"St2"==s?t=.11:"St3"==s?t=.21:"Su2"==s?t=.02:"Su3"==s?t=.04:"Su4"==s?t=.04:"Ls2"==s?t=.21:"Ls3"==s?t=.21:"Ls4"==s?t=.21:"Lt2"==s?t=.3:"Lt3"==s?t=.4:"Lts"==s?t=.35:"Lu"==s?t=.23:"Uu"==s?t=.04:"Uls"==s?t=.12:"Us"==s?t=.04:"Ut2"==s?t=.1:"Ut3"==s?t=.14:"Ut4"==s?t=.21:"Utl"==s?t=.23:"Tt"==s?t=.82:"Tl"==s?t=.55:"Tu2"==s?t=.55:"Tu3"==s?t=.37:"Ts3"==s?t=.4:"Ts2"==s?t=.55:"Ts4"==s?t=.3:"Tu4"==s?t=.3:"L"==s?t=.31:"S"==s?t=.02:"U"==s?t=.04:"T"==s?t=.82:"HZ1"==s?t=.15:"HZ2"==s?t=.15:"HZ3"==s?t=.15:"Hh"==s?t=.1:"Hn"==s&&(t=.1),t},ld_eff2trd:function(s,t){var S=0;switch(s){case 1:S=1.3;break;case 2:S=1.5;break;case 3:S=1.7;break;case 4:S=1.9;break;case 5:S=2.1;break;default:S=1.7}return S-.9*t},texture2lambda:function(s,t){return 2*s*s*.575+.1*t+.35*(1-s-t)},sunshine2globalRadiation:function(s,t,S,u){var l=4*atan(1),n=-23.4*cos(2*l*(s+10)/365),a=sin(n*l/180)*sin(S*l/180),T=cos(n*l/180)*cos(S*l/180),r=12*(l+2*asin(a/T))/l,L=12*(l+2*asin((-sin(8*l/180)+a)/T))/l,e=3600*(a*r+24/l*T*sqrt(1-a/T*(a/T))),U=1300*e*exp(-.14/(e/(3600*r))),f=.2*U,c=t/L*U+(1-t/L)*f,i=c/1e4;return u?i/100:i}};

var YieldComponent=function(t,i,e){var a=arguments[0]instanceof YieldComponent?arguments[0]:null;this.organId=a?a.organId:t,this.yieldPercentage=a?a.yieldPercentage:i,this.yieldDryMatter=a?a.yieldDryMatter:e},NMinCropParameters=function(t,i,e){this.samplingDepth=t||0,this.nTarget=i||0,this.nTarget30=e||0,this.toString=function(){return"samplingDepth: "+this.samplingDepth+" nTarget: "+this.nTarget+" nTarget40: "+this.nTarget30}},NMinUserParameters=function(t,i,e){this.min=t||0,this.max=i||0,this.delayInDays=e||0,this.toString=function(){return"min: "+t+" max: "+i+" delay: "+e+" days"}},IrrigationParameters=function(t,i){this.nitrateConcentration=t||0,this.sulfateConcentration=i||0,this.toString=function(){return"nitrateConcentration: "+this.nitrateConcentration+" sulfateConcentration: "+this.sulfateConcentration}},AutomaticIrrigationParameters=function(t,i,e,a){this.amount=t||17,this.threshold=i||.35,this.nitrateConcentration=e||0,this.sulfateConcentration=a||0,this.toString=function(){return"amount: "+this.amount+" treshold: "+this.treshold+" "+this.prototype.toString()}};AutomaticIrrigationParameters.prototype=new IrrigationParameters;var ResidueParameters=function(){this.vo_AOM_DryMatterContent=.289,this.vo_AOM_NH4Content=.007,this.vo_AOM_NO3Content=0,this.vo_AOM_CarbamidContent=0,this.vo_AOM_SlowDecCoeffStandard=2e-4,this.vo_AOM_FastDecCoeffStandard=.002,this.vo_PartAOM_to_AOM_Slow=.72,this.vo_PartAOM_to_AOM_Fast=.18,this.vo_CN_Ratio_AOM_Slow=100,this.vo_CN_Ratio_AOM_Fast=7.3,this.vo_PartAOM_Slow_to_SMB_Slow=0,this.vo_PartAOM_Slow_to_SMB_Fast=1},AOM_Properties=function(){this.vo_AOM_Slow=0,this.vo_AOM_Fast=0,this.vo_AOM_SlowDecRate=0,this.vo_AOM_FastDecRate=0,this.vo_AOM_SlowDecCoeff=0,this.vo_AOM_FastDecCoeff=0,this.vo_AOM_SlowDecCoeffStandard=1,this.vo_AOM_FastDecCoeffStandard=1,this.vo_PartAOM_Slow_to_SMB_Slow=0,this.vo_PartAOM_Slow_to_SMB_Fast=0,this.vo_CN_Ratio_AOM_Slow=1,this.vo_CN_Ratio_AOM_Fast=1,this.vo_DaysAfterApplication=0,this.vo_AOM_DryMatterContent=0,this.vo_AOM_NH4Content=0,this.vo_AOM_SlowDelta=0,this.vo_AOM_FastDelta=0,this.incorporation=!1},CropParameters=function(){this.pc_NumberOfDevelopmentalStages=0,this.pc_CropName,this.pc_NumberOfOrgans=0,this.pc_CarboxylationPathway,this.pc_DefaultRadiationUseEfficiency,this.pc_FixingN,this.pc_InitialKcFactor,this.pc_LuxuryNCoeff,this.pc_MaxAssimilationRate,this.pc_MaxCropDiameter,this.pc_MaxCropHeight,this.pc_CropHeightP1,this.pc_CropHeightP2,this.pc_StageAtMaxHeight,this.pc_StageAtMaxDiameter,this.pc_MinimumNConcentration,this.pc_MinimumTemperatureForAssimilation,this.pc_NConcentrationAbovegroundBiomass,this.pc_NConcentrationB0,this.pc_NConcentrationPN,this.pc_NConcentrationRoot,this.pc_ResidueNRatio,this.pc_DevelopmentAccelerationByNitrogenStress,this.pc_AssimilatePartitioningCoeff=[],this.pc_OrganSenescenceRate=[],this.pc_BaseDaylength=[],this.pc_BaseTemperature=[],this.pc_OptimumTemperature=[],this.pc_DaylengthRequirement=[],this.pc_DroughtStressThreshold=[],this.pc_OrganMaintenanceRespiration=[],this.pc_OrganGrowthRespiration=[],this.pc_SpecificLeafArea=[],this.pc_StageMaxRootNConcentration=[],this.pc_StageKcFactor=[],this.pc_StageTemperatureSum=[],this.pc_VernalisationRequirement=[],this.pc_InitialOrganBiomass=[],this.pc_CriticalOxygenContent=[],this.pc_CropSpecificMaxRootingDepth,this.pc_AbovegroundOrgan=[],this.pc_StorageOrgan=[],this.pc_SamplingDepth,this.pc_TargetNSamplingDepth,this.pc_TargetN30,this.pc_HeatSumIrrigationStart,this.pc_HeatSumIrrigationEnd,this.pc_MaxNUptakeParam,this.pc_RootDistributionParam,this.pc_PlantDensity,this.pc_RootGrowthLag,this.pc_MinimumTemperatureRootGrowth,this.pc_InitialRootingDepth,this.pc_RootPenetrationRate,this.pc_RootFormFactor,this.pc_SpecificRootLength,this.pc_StageAfterCut,this.pc_CriticalTemperatureHeatStress,this.pc_LimitingTemperatureHeatStress,this.pc_BeginSensitivePhaseHeatStress,this.pc_EndSensitivePhaseHeatStress,this.pc_CuttingDelayDays,this.pc_FieldConditionModifier,this.pc_DroughtImpactOnFertilityFactor,this.organIdsForPrimaryYield=[],this.organIdsForSecondaryYield=[],this.organIdsForCutting=[],this.resizeStageOrganVectors=function(){for(var t=this.pc_NumberOfDevelopmentalStages-this.pc_AssimilatePartitioningCoeff.length,i=0;t>i;i++){var e=new Array(this.pc_NumberOfOrgans);this.pc_AssimilatePartitioningCoeff.push(e)}for(var t=this.pc_NumberOfDevelopmentalStages-this.pc_OrganSenescenceRate.length,i=0;t>i;i++){var e=new Array(this.pc_NumberOfOrgans);this.pc_OrganSenescenceRate.push(e)}},this.toString=function(){var t="",i="\n";t+="pc_CropName:	"+this.pc_CropName+i,t+="------------------------------------------------"+i,t+="pc_NumberOfDevelopmentalStages:	"+this.pc_NumberOfDevelopmentalStages+i,t+="pc_NumberOfOrgans:				"+this.pc_NumberOfOrgans+i,t+="------------------------------------------------"+i,t+="pc_AssimilatePartitioningCoeff:	"+i;for(var e=0;e<this.pc_AssimilatePartitioningCoeff.length;e++){for(var a=0;a<this.pc_AssimilatePartitioningCoeff[e].length;a++)t+=this.pc_AssimilatePartitioningCoeff[e][a]+" ";t+=i}t+="------------------------------------------------"+i,t+="pc_CarboxylationPathway:				"+this.pc_CarboxylationPathway+i,t+="pc_MaxAssimilationRate:					"+this.pc_MaxAssimilationRate+i,t+="pc_MinimumTemperatureForAssimilation:	"+this.pc_MinimumTemperatureForAssimilation+i,t+="pc_CropSpecificMaxRootingDepth:			"+this.pc_CropSpecificMaxRootingDepth+i,t+="pc_InitialKcFactor:						"+this.pc_InitialKcFactor+i,t+="pc_MaxCropDiameter:						"+this.pc_MaxCropDiameter+i,t+="pc_StageAtMaxDiameter:					"+this.pc_StageAtMaxDiameter+i,t+="pc_PlantDensity:						"+this.pc_PlantDensity+i,t+="pc_DefaultRadiationUseEfficiency:		"+this.pc_DefaultRadiationUseEfficiency+i,t+="pc_StageAfterCut:						"+this.pc_StageAfterCut+i,t+="pc_CuttingDelayDays:					"+this.pc_CuttingDelayDays+i,t+="------------------------------------------------"+i,t+="pc_RootDistributionParam:			"+this.pc_RootDistributionParam+i,t+="pc_RootGrowthLag:					"+this.pc_RootGrowthLag+i,t+="pc_MinimumTemperatureRootGrowth:	"+this.pc_MinimumTemperatureRootGrowth+i,t+="pc_InitialRootingDepth:				"+this.pc_InitialRootingDepth+i,t+="pc_RootPenetrationRate:				"+this.pc_RootPenetrationRate+i,t+="pc_RootFormFactor:					"+this.pc_RootFormFactor+i,t+="pc_SpecificRootLength:				"+this.pc_SpecificRootLength+i,t+="------------------------------------------------"+i,t+="pc_MaxCropHeight:		"+this.pc_MaxCropHeight+i,t+="pc_CropHeightP1:		"+this.pc_CropHeightP1+i,t+="pc_CropHeightP2:		"+this.pc_CropHeightP2+i,t+="pc_StageAtMaxHeight:	"+this.pc_StageAtMaxHeight+i,t+="------------------------------------------------"+i,t+="pc_FixingN:					"+this.pc_FixingN+i,t+="pc_MinimumNConcentration:	"+this.pc_MinimumNConcentration+i,t+="pc_LuxuryNCoeff:			"+this.pc_LuxuryNCoeff+i,t+="pc_NConcentrationB0:		"+this.pc_NConcentrationB0+i,t+="pc_NConcentrationPN:		"+this.pc_NConcentrationPN+i,t+="pc_NConcentrationRoot:		"+this.pc_NConcentrationRoot+i,t+="pc_ResidueNRatio:			"+this.pc_ResidueNRatio+i,t+="pc_MaxNUptakeParam:			"+this.pc_MaxNUptakeParam+i,t+="------------------------------------------------"+i,t+="pc_DevelopmentAccelerationByNitrogenStress:	"+this.pc_DevelopmentAccelerationByNitrogenStress+i,t+="pc_NConcentrationAbovegroundBiomass:		"+this.pc_NConcentrationAbovegroundBiomass+i,t+="pc_DroughtImpactOnFertilityFactor:			"+this.pc_DroughtImpactOnFertilityFactor+i,t+="------------------------------------------------"+i,t+="pc_SamplingDepth:					"+this.pc_SamplingDepth+i,t+="pc_TargetNSamplingDepth:			"+this.pc_TargetNSamplingDepth+i,t+="pc_TargetN30:						"+this.pc_TargetN30+i,t+="pc_HeatSumIrrigationStart:			"+this.pc_HeatSumIrrigationStart+i,t+="pc_HeatSumIrrigationEnd:			"+this.pc_HeatSumIrrigationEnd+i,t+="pc_CriticalTemperatureHeatStress:	"+this.pc_CriticalTemperatureHeatStress+i,t+="pc_LimitingTemperatureHeatStress:	"+this.pc_LimitingTemperatureHeatStress+i,t+="pc_BeginSensitivePhaseHeatStress:	"+this.pc_BeginSensitivePhaseHeatStress+i,t+="pc_EndSensitivePhaseHeatStress:		"+this.pc_EndSensitivePhaseHeatStress+i,t+="------------------------------------------------"+i,t+="pc_AbovegroundOrgan:"+i;for(var e=0;e<this.pc_AbovegroundOrgan.length;e++)t+=(1==this.pc_AbovegroundOrgan[e])+" ";t+=i,t+=i,t+="pc_InitialOrganBiomass:"+i;for(var e=0;e<this.pc_InitialOrganBiomass.length;e++)t+=this.pc_InitialOrganBiomass[e]+" ";t+=i,t+=i,t+="pc_OrganMaintenanceRespiration:"+i;for(var e=0;e<this.pc_OrganMaintenanceRespiration.length;e++)t+=this.pc_OrganMaintenanceRespiration[e]+" ";t+=i,t+=i,t+="pc_OrganGrowthRespiration:"+i;for(var e=0;e<this.pc_OrganGrowthRespiration.length;e++)t+=this.pc_OrganGrowthRespiration[e]+" ";t+=i,t+=i,t+="pc_OrganSenescenceRate:"+i;for(var e=0;e<this.pc_OrganSenescenceRate.length;e++){for(var a=0;a<this.pc_OrganSenescenceRate[e].length;a++)t+=this.pc_OrganSenescenceRate[e][a]+" ";t+=i}t+="------------------------------------------------"+i,t+="pc_StageTemperatureSum:"+i;for(var e=0;e<this.pc_StageTemperatureSum.length;e++)t+=this.pc_StageTemperatureSum[e]+" ";t+=i,t+=i,t+="pc_BaseDaylength: "+i;for(var e=0;e<this.pc_BaseDaylength.length;e++)t+=this.pc_BaseDaylength[e]+" ";t+=i,t+=i,t+="pc_BaseTemperature: "+i;for(var e=0;e<this.pc_BaseTemperature.length;e++)t+=this.pc_BaseTemperature[e]+" ";t+=i,t+=i,t+="pc_OptimumTemperature: "+i;for(var e=0;e<this.pc_OptimumTemperature.length;e++)t+=this.pc_OptimumTemperature[e]+" ";t+=i,t+=i,t+="pc_DaylengthRequirement: "+i;for(var e=0;e<this.pc_DaylengthRequirement.length;e++)t+=this.pc_DaylengthRequirement[e]+" ";t+=i,t+=i,t+="pc_SpecificLeafArea:"+i;for(var e=0;e<this.pc_SpecificLeafArea.length;e++)t+=this.pc_SpecificLeafArea[e]+" ";t+=i,t+=i,t+="pc_StageMaxRootNConcentration:"+i;for(var e=0;e<this.pc_StageMaxRootNConcentration.length;e++)t+=this.pc_StageMaxRootNConcentration[e]+" ";t+=i,t+=i,t+="pc_StageKcFactor:"+i;for(var e=0;e<this.pc_StageKcFactor.length;e++)t+=this.pc_StageKcFactor[e]+" ";t+=i,t+=i,t+="pc_DroughtStressThreshold:"+i;for(var e=0;e<this.pc_DroughtStressThreshold.length;e++)t+=this.pc_DroughtStressThreshold[e]+" ";t+=i,t+=i,t+="pc_VernalisationRequirement:"+i;for(var e=0;e<this.pc_VernalisationRequirement.length;e++)t+=this.pc_VernalisationRequirement[e]+" ";t+=i,t+=i,t+="pc_CriticalOxygenContent:"+i;for(var e=0;e<this.pc_CriticalOxygenContent.length;e++)t+=this.pc_CriticalOxygenContent[e]+" ";return t+=i}},GeneralParameters=function(t,i,e,a,s,o,n){this._ps_LayerThickness=t||.1,this.ps_ProfileDepth=i||2,this.ps_LayerThickness=new Float64Array(int(this.ps_ProfileDepth/this._ps_LayerThickness)),this.ps_MaxMineralisationDepth=e||.4,this.pc_NitrogenResponseOn=a||!0,this.pc_WaterDeficitResponseOn=s||!0,this.pc_EmergenceFloodingControlOn=o||!0,this.pc_EmergenceMoistureControlOn=n||!0;for(var r=0;r<this.ps_LayerThickness.length;r++)this.ps_LayerThickness[r]=this._ps_LayerThickness;this.ps_NumberOfLayers=function(){return this.ps_LayerThickness.length}},SiteParameters=function(){this.vs_Latitude=60,this.vs_Slope=.01,this.vs_HeightNN=50,this.vs_GroundwaterDepth=70,this.vs_Soil_CN_Ratio=10,this.vs_DrainageCoeff=1,this.vq_NDeposition=30,this.vs_MaxEffectiveRootingDepth=2},SoilParameters=function(){this.vs_SoilSandContent=.4,this.vs_SoilClayContent=.05,this.vs_SoilpH=6.9,this.vs_SoilStoneContent=-1,this.vs_Lambda=-1,this.vs_FieldCapacity=-1,this.vs_Saturation=-1,this.vs_PermanentWiltingPoint=-1,this.vs_SoilTexture="",this.vs_SoilAmmonium=-1,this.vs_SoilNitrate=-1,this._vs_SoilRawDensity=-1,this._vs_SoilBulkDensity=-1,this._vs_SoilOrganicCarbon=-1,this._vs_SoilOrganicMatter=-1,this.isValid=function(){var t=!0;return this.vs_FieldCapacity<=0&&(logger(MSG.WARN,"SoilParameters::Error: No field capacity defined in database for "+this.vs_SoilTexture+" , RawDensity: "+this._vs_SoilRawDensity),t=!1),this.vs_Saturation<=0&&(logger(MSG.WARN,"SoilParameters::Error: No saturation defined in database for "+this.vs_SoilTexture+" , RawDensity: "+this._vs_SoilRawDensity),t=!1),this.vs_PermanentWiltingPoint<=0&&(logger(MSG.WARN,"SoilParameters::Error: No saturation defined in database for "+this.vs_SoilTexture+" , RawDensity: "+this._vs_SoilRawDensity),t=!1),this.vs_SoilSandContent<0&&(logger(MSG.WARN,"SoilParameters::Error: Invalid soil sand content: "+this.vs_SoilSandContent),t=!1),this.vs_SoilClayContent<0&&(logger(MSG.WARN,"SoilParameters::Error: Invalid soil clay content: "+this.vs_SoilClayContent),t=!1),this.vs_SoilpH<0&&(logger(MSG.WARN,"SoilParameters::Error: Invalid soil ph value: "+this.vs_SoilpH),t=!1),this.vs_SoilStoneContent<0&&(logger(MSG.WARN,"SoilParameters::Error: Invalid soil stone content: "+this.vs_SoilStoneContent),t=!1),this.vs_Saturation<0&&(logger(MSG.WARN,"SoilParameters::Error: Invalid value for saturation: "+this.vs_Saturation),t=!1),this.vs_PermanentWiltingPoint<0&&(logger(MSG.WARN,"SoilParameters::Error: Invalid value for permanent wilting point: "+this.vs_PermanentWiltingPoint),t=!1),t},this.vs_SoilRawDensity=function(){return 1e3*this._vs_SoilRawDensity},this.set_vs_SoilRawDensity=function(t){this._vs_SoilRawDensity=t},this.vs_SoilOrganicCarbon=function(){return this._vs_SoilOrganicMatter<0?this._vs_SoilOrganicCarbon:this._vs_SoilOrganicMatter*organicConstants.po_SOM_to_C},this.set_vs_SoilOrganicCarbon=function(t){this._vs_SoilOrganicCarbon=t},this.vs_SoilOrganicMatter=function(){return this._vs_SoilOrganicCarbon<0?this._vs_SoilOrganicMatter:this._vs_SoilOrganicCarbon/organicConstants.po_SOM_to_C},this.set_vs_SoilOrganicMatter=function(t){this._vs_SoilOrganicMatter=t},this.vs_SoilSiltContent=function(){return this.vs_SoilSandContent-.001<0&&this.vs_SoilClayContent-.001<0?0:1-this.vs_SoilSandContent-this.s_SoilClayContent},this.vs_SoilBulkDensity=function(){return this._vs_SoilRawDensity<0?this._vs_SoilBulkDensity:1e3*(this._vs_SoilRawDensity+.009*100*this.vs_SoilClayContent)},this.set_vs_SoilBulkDensity=function(t){this._vs_SoilBulkDensity=t},this.texture2lambda=function(t,i){return Tools.texture2lambda(t,i)},this.toString=function(){var t="",i="\n";return t+="vs_Soilph: "+vs_SoilpH+i+"vs_SoilOrganicCarbon: "+vs_SoilOrganicCarbon()+i+"vs_SoilOrganicMatter: "+vs_SoilOrganicMatter()+i+"vs_SoilRawDensity: "+vs_SoilRawDensity()+i+"vs_SoilBulkDensity: "+vs_SoilBulkDensity()+i+"vs_SoilSandContent: "+vs_SoilSandContent+i+"vs_SoilClayContent: "+vs_SoilClayContent+i+"vs_SoilSiltContent: "+vs_SoilSiltContent()+i+"vs_SoilStoneContent: "+vs_SoilStoneContent+i}},MineralFertiliserParameters=function(t,i,e,a){var t=t,s=i,o=a,n=e;return{getName:function(){return t},getCarbamid:function(){return s},getNH4:function(){return o},getNO3:function(){return n},setName:function(){t=name_},setCarbamid:function(t){s=t},setNH4:function(t){o=t},setNO3:function(t){n=t}}},OrganicMatterParameters=function(t){this.name="",this.vo_AOM_DryMatterContent=t?t.vo_AOM_DryMatterContent:0,this.vo_AOM_NH4Content=t?t.vo_AOM_NH4Content:0,this.vo_AOM_NO3Content=t?t.vo_AOM_NO3Content:0,this.vo_AOM_CarbamidContent=t?t.vo_AOM_CarbamidContent:0,this.vo_AOM_SlowDecCoeffStandard=t?t.vo_AOM_SlowDecCoeffStandard:0,this.vo_AOM_FastDecCoeffStandard=t?t.vo_AOM_FastDecCoeffStandard:0,this.vo_PartAOM_to_AOM_Slow=t?t.vo_PartAOM_to_AOM_Slow:0,this.vo_PartAOM_to_AOM_Fast=t?t.vo_PartAOM_to_AOM_Fast:0,this.vo_CN_Ratio_AOM_Slow=t?t.vo_CN_Ratio_AOM_Slow:0,this.vo_CN_Ratio_AOM_Fast=t?t.vo_CN_Ratio_AOM_Fast:0,this.vo_PartAOM_Slow_to_SMB_Slow=t?t.vo_PartAOM_Slow_to_SMB_Slow:0,this.vo_PartAOM_Slow_to_SMB_Fast=t?t.vo_PartAOM_Slow_to_SMB_Fast:0,this.vo_NConcentration=0,this.toString=function(){var t="",i="\n";return t+="Name: "+this.name+i+"vo_NConcentration: "+this.vo_NConcentration+i+"vo_DryMatter: "+this.vo_AOM_DryMatterContent+i+"vo_NH4: "+this.vo_AOM_NH4Content+i+"vo_NO3: "+this.vo_AOM_NO3Content+i+"vo_NH2: "+this.vo_AOM_CarbamidContent+i+"vo_kSlow: "+this.vo_AOM_SlowDecCoeffStandard+i+"vo_kFast: "+this.vo_AOM_FastDecCoeffStandard+i+"vo_PartSlow: "+this.vo_PartAOM_to_AOM_Slow+i+"vo_PartFast: "+this.vo_PartAOM_to_AOM_Fast+i+"vo_CNSlow: "+this.vo_CN_Ratio_AOM_Slow+i+"vo_CNFast: "+this.vo_CN_Ratio_AOM_Fast+i+"vo_SMBSlow: "+this.vo_PartAOM_Slow_to_SMB_Slow+i+"vo_SMBFast: "+this.vo_PartAOM_Slow_to_SMB_Fast+i}},UserCropParameters=function(){this.pc_ReferenceMaxAssimilationRate,this.pc_ReferenceLeafAreaIndex,this.pc_MaintenanceRespirationParameter1,this.pc_MaintenanceRespirationParameter2,this.pc_MinimumNConcentrationRoot,this.pc_MinimumAvailableN,this.pc_ReferenceAlbedo,this.pc_StomataConductanceAlpha,this.pc_SaturationBeta,this.pc_GrowthRespirationRedux,this.pc_MaxCropNDemand,this.pc_GrowthRespirationParameter1,this.pc_GrowthRespirationParameter2,this.pc_Tortuosity},UserEnvironmentParameters=function(){this.p_UseNMinMineralFertilisingMethod,this.p_UseSecondaryYields,this.p_LayerThickness,this.p_Albedo,this.p_AthmosphericCO2,this.p_WindSpeedHeight,this.p_LeachingDepth,this.p_timeStep,this.p_MaxGroundwaterDepth=20,this.p_MinGroundwaterDepth=20,this.p_NumberOfLayers,this.p_StartPVIndex,this.p_JulianDayAutomaticFertilising,this.p_MinGroundwaterDepthMonth},UserInitialValues=function(){this.p_initPercentageFC=.8,this.p_initSoilNitrate=1e-4,this.p_initSoilAmmonium=1e-4},UserSoilMoistureParameters=function(){this.pm_CriticalMoistureDepth,this.pm_SaturatedHydraulicConductivity,this.pm_SurfaceRoughness,this.pm_GroundwaterDischarge,this.pm_HydraulicConductivityRedux,this.pm_SnowAccumulationTresholdTemperature,this.pm_KcFactor,this.pm_TemperatureLimitForLiquidWater,this.pm_CorrectionSnow,this.pm_CorrectionRain,this.pm_SnowMaxAdditionalDensity,this.pm_NewSnowDensityMin,this.pm_SnowRetentionCapacityMin,this.pm_RefreezeParameter1,this.pm_RefreezeParameter2,this.pm_RefreezeTemperature,this.pm_SnowMeltTemperature,this.pm_SnowPacking,this.pm_SnowRetentionCapacityMax,this.pm_EvaporationZeta,this.pm_XSACriticalSoilMoisture,this.pm_MaximumEvaporationImpactDepth,this.pm_MaxPercolationRate,this.pm_MoistureInitValue},UserSoilTemperatureParameters=function(){this.pt_NTau,this.pt_InitialSurfaceTemperature,this.pt_BaseTemperature,this.pt_QuartzRawDensity,this.pt_DensityAir,this.pt_DensityWater,this.pt_DensityHumus,this.pt_SpecificHeatCapacityAir,this.pt_SpecificHeatCapacityQuartz,this.pt_SpecificHeatCapacityWater,this.pt_SpecificHeatCapacityHumus,this.pt_SoilAlbedo,this.pt_SoilMoisture=.25},UserSoilTransportParameters=function(){this.pq_AD,this.pq_DiffusionCoefficientStandard,this.pq_NDeposition},UserSoilOrganicParameters=function(){this.po_SOM_FastDecCoeffStandard,this.po_SMB_SlowMaintRateStandard,this.po_SMB_FastMaintRateStandard,this.po_SMB_SlowDeathRateStandard,this.po_SMB_FastDeathRateStandard,this.po_SMB_UtilizationEfficiency,this.po_SOM_SlowUtilizationEfficiency,this.po_SOM_FastUtilizationEfficiency,this.po_AOM_SlowUtilizationEfficiency,this.po_AOM_FastUtilizationEfficiency,this.po_AOM_FastMaxC_to_N,this.po_PartSOM_Fast_to_SOM_Slow,this.po_PartSMB_Slow_to_SOM_Fast,this.po_PartSMB_Fast_to_SOM_Fast,this.po_PartSOM_to_SMB_Slow,this.po_PartSOM_to_SMB_Fast,this.po_CN_Ratio_SMB,this.po_LimitClayEffect,this.po_AmmoniaOxidationRateCoeffStandard,this.po_NitriteOxidationRateCoeffStandard,this.po_TransportRateCoeff,this.po_SpecAnaerobDenitrification,this.po_ImmobilisationRateCoeffNO3,this.po_ImmobilisationRateCoeffNH4,this.po_Denit1,this.po_Denit2,this.po_Denit3,this.po_HydrolysisKM,this.po_ActivationEnergy,this.po_HydrolysisP1,this.po_HydrolysisP2,this.po_AtmosphericResistance,this.po_N2OProductionRate,this.po_Inhibitor_NH3},CapillaryRiseRates=function(){this.cap_rates_map={},this.addRate=function(t,i,e){void 0===this.cap_rates_map[t]&&(this.cap_rates_map[t]={}),this.cap_rates_map[t][i]=e},this.getRate=function(t,i){var e=getMap(t),a=0;for(var s in e)e.hasOwnProperty(s)&&a++;return 0>=a&&logger(MSG.WARN,"No capillary rise rates in data structure available."),void 0===this.cap_rates_map[t][i]?0:this.cap_rates_map[t][i]},this.getMap=function(t){return this.cap_rates_map[t]},this.size=function(){var t=0;for(var i in this.cap_rates_map)this.cap_rates_map.hasOwnProperty(i)&&t++;return t}},RPSCDRes=function(t){this.sat=0,this.fc=0,this.pwp=0,this.initialized=void 0===t?!1:t},CentralParameterProvider=function(){this.userCropParameters=new UserCropParameters,this.userEnvironmentParameters=new UserEnvironmentParameters,this.userSoilMoistureParameters=new UserSoilMoistureParameters,this.userSoilTemperatureParameters=new UserSoilTemperatureParameters,this.userSoilTransportParameters=new UserSoilTransportParameters,this.userSoilOrganicParameters=new UserSoilOrganicParameters,this.capillaryRiseRates=null,this.userInitValues=new UserInitialValues};

var WorkStep=function(t){this._date=t,this.date=function(){return this._date},this.setDate=function(t){this._date=t},this.apply=function(){},this.clone=function(){},this.toString=function(){return"date: "+this.date().toString()}},Seed=function(t,i){WorkStep.call(this,t),this._date=t,this._crop=i,this.setDate=function(t){this._date=t,this._crop.setSeedAndHarvestDate(this.date(),this._crop.harvestDate())},this.apply=function(t){logger(MSG.INFO,"seeding crop: "+this._crop.name()+" at: "+this.date().toString()),t.seedCrop(this._crop)},this.clone=function(){return JSON.parse(JSON.stringify(this))},this.toString=function(){return"seeding at: "+this.date().toString()+" crop: "+this._crop.toString()}};Seed.prototype=Object.create(WorkStep),Seed.prototype.constructor=Seed;var Harvest=function(t,i,r){WorkStep.call(this,t),this._date=t,this._crop=i,this._cropResult=r,this.setDate=function(t){this._date=t,this._crop.setSeedAndHarvestDate(this._crop.seedDate(),this.date())},this.apply=function(t){t.cropGrowth()&&(logger(MSG.INFO,"harvesting crop: "+this._crop.name()+" at: "+this.date().toString()),t.currentCrop()==this._crop?(t.cropGrowth()&&(this._crop.setHarvestYields(t.cropGrowth().get_FreshPrimaryCropYield()/100,t.cropGrowth().get_FreshSecondaryCropYield()/100),this._crop.setHarvestYieldsTM(t.cropGrowth().get_PrimaryCropYield()/100,t.cropGrowth().get_SecondaryCropYield()/100),this._crop.setYieldNContent(t.cropGrowth().get_PrimaryYieldNContent(),t.cropGrowth().get_SecondaryYieldNContent()),this._crop.setSumTotalNUptake(t.cropGrowth().get_SumTotalNUptake()),this._crop.setCropHeight(t.cropGrowth().get_CropHeight()),this._crop.setAccumulatedETa(t.cropGrowth().get_AccumulatedETa())),this._cropResult.id=this._crop.id(),this._cropResult.name=this._crop.name(),this._cropResult.primaryYield=roundN(2,this._crop.primaryYield()),this._cropResult.secondaryYield=roundN(2,this._crop.secondaryYield()),this._cropResult.primaryYieldTM=roundN(2,this._crop.primaryYieldTM()),this._cropResult.secondaryYieldTM=roundN(2,this._crop.secondaryYieldTM()),this._cropResult.sumIrrigation=roundN(2,this._crop.appliedIrrigationWater()),this._cropResult.biomassNContent=roundN(2,this._crop.primaryYieldN()),this._cropResult.aboveBiomassNContent=roundN(2,this._crop.aboveGroundBiomasseN()),this._cropResult.daysWithCrop=roundN(2,t.daysWithCrop()),this._cropResult.sumTotalNUptake=roundN(2,this._crop.sumTotalNUptake()),this._cropResult.cropHeight=roundN(2,this._crop.cropHeight()),this._cropResult.sumETaPerCrop=roundN(2,this._crop.get_AccumulatedETa()),this._cropResult.NStress=roundN(2,t.getAccumulatedNStress()),this._cropResult.WaterStress=roundN(2,t.getAccumulatedWaterStress()),this._cropResult.HeatStress=roundN(2,t.getAccumulatedHeatStress()),this._cropResult.OxygenStress=roundN(2,t.getAccumulatedOxygenStress()),this._cropResult.sumFertiliser=roundN(2,t.sumFertiliser()),t.harvestCurrentCrop()):logger(MSG.INFO,"Crop: "+t.currentCrop().toString()+" to be harvested isn't actual crop of this Harvesting action: "+this._crop.toString()))},this.clone=function(){return JSON.parse(JSON.stringify(this))},this.toString=function(){return"harvesting at: "+this.date().toString()+" crop: "+this._crop.toString()}};Harvest.prototype=Object.create(WorkStep),Harvest.prototype.constructor=Harvest;var Cutting=function(t,i,r){WorkStep.call(this,t),this._date=t,this._crop=i,this._cropResult=r,this.apply=function(t){if(logger(MSG.INFO,"Cutting crop: "+this._crop.name()+" at: "+this.date().toString()),t.currentCrop()==this._crop){var i={id:this._crop.id(),name:this._crop.name(),date:this._date,primaryYieldTM:t.cropGrowth().get_PrimaryCropYield()/100};if(fs){var r="";r+=this._date.getFullYear()+";"+round(i.primaryYieldTM)+"\n",fs.appendFileSync("./out/cutting_yields.csv",r,{encoding:"utf8"})}this._cropResult.cuts||(this._cropResult.cuts=[]),this._cropResult.cuts.push(i),t.cropGrowth()&&t.cropGrowth().applyCutting()}},this.clone=function(){return JSON.parse(JSON.stringify(this))},this.toString=function(){return"Cutting at: "+this.date().toString()+" crop: "+this._crop.toString()}};Cutting.prototype=Object.create(WorkStep),Cutting.prototype.constructor=Cutting;var MineralFertiliserApplication=function(t,i,r){WorkStep.call(this,t),this._date=t,this._partition=i,this._amount=r,this.apply=function(t){t.applyMineralFertiliser(this._partition,this._amount)},this.partition=function(){return this._partition},this.amount=function(){return this._amount},this.toString=function(){return"applying mineral fertiliser at: "+this._date.toString()+" amount: "+this._amount+" partition: "+this.partition().toString()},this.clone=function(){return JSON.parse(JSON.stringify(this))}};MineralFertiliserApplication.prototype=Object.create(WorkStep),MineralFertiliserApplication.prototype.constructor=MineralFertiliserApplication;var OrganicFertiliserApplication=function(t,i,r,e){WorkStep.call(this,t),this._date=t,this._parameters=i,this._amount=r,this._incrop=void 0===e?!0:e,this.apply=function(t){t.applyOrganicFertiliser(this._parameters,this._amount,this._incrop)},this.parameters=function(){return this._parameters},this.amount=function(){return this._amount},this.incorporation=function(){return this._incorporation},this.toString=function(){return"applying organic fertiliser at: "+this.date().toString()+" amount: "+this.amount()+"	N percentage: "+this._parameters().vo_NConcentration+"	N amount: "+this.amount()*this._parameters().vo_NConcentration},this.clone=function(){return JSON.parse(JSON.stringify(this))}};OrganicFertiliserApplication.prototype=Object.create(WorkStep),OrganicFertiliserApplication.prototype.constructor=OrganicFertiliserApplication;var TillageApplication=function(t,i){WorkStep.call(this,t),this._date=t,this._depth=i,this.apply=function(t){t.applyTillage(this._depth)},this.toString=function(){return"applying tillage at: "+this.date().toString()+" depth: "+this.depth()},this.clone=function(){return JSON.parse(JSON.stringify(this))}};TillageApplication.prototype=Object.create(WorkStep),TillageApplication.prototype.constructor=TillageApplication;var IrrigationApplication=function(t,i,r){WorkStep.call(this,t),this._date=t,this._amount=i,this._parameters=r,this.apply=function(t){t.applyIrrigation(this.amount(),this.nitrateConcentration())},this.amount=function(){return this._amount},this.nitrateConcentration=function(){return this._parameters.nitrateConcentration},this.sulfateConcentration=function(){return this._parameters.sulfateConcentration},this.toString=function(){return"applying irrigation at: "+this.date().toString()+" amount: "+this.amount()+" nitrateConcentration: "+this.nitrateConcentration()+" sulfateConcentration: "+this.sulfateConcentration()},this.clone=function(){return JSON.parse(JSON.stringify(this))}};IrrigationApplication.prototype=Object.create(WorkStep),IrrigationApplication.prototype.constructor=IrrigationApplication;

var ProductionProcess=function(t,e){var n=t,r=e,u=[],o=[];u.equal_range=function(t){var e=[];return this.forEach(function(n){n.date().setHours(0,0,0,0)===t.setHours(0,0,0,0)&&e.push(n)}),e},u.upper_bound=function(t){for(var e=0,n=this.length;n>e;e++)if(this[e].date().setHours(0,0,0,0)>t.setHours(0,0,0,0))return this[e];return null},debug("ProductionProcess: "+t);var a=function(t){u.push(t),u.sort(function(t,e){var n=t.date(),r=e.date();return r>n?-1:n>r?1:0})};e.seedDate().setHours(0,0,0,0)!=new Date(1951,0,1).setHours(0,0,0,0)&&e.seedDate().setHours(0,0,0,0)!=new Date(0,0,0).setHours(0,0,0,0)&&a(new Seed(e.seedDate(),e)),e.harvestDate().setHours(0,0,0,0)!=new Date(1951,0,1).setHours(0,0,0,0)&&e.harvestDate().setHours(0,0,0,0)!=new Date(0,0,0).setHours(0,0,0,0)&&a(new Harvest(e.harvestDate(),e,o));for(var s=e.getCuttingDates(),i=s.length,c=0;i>c;c++)debug("Add cutting date: "+Date(s[c].toString())),a(new Cutting(Date(s.at(c)),e));var d=function(){},f=function(t,e){var n=u.equal_range(t);n.forEach(function(t){t.apply(e)})},g=function(t){var e=u.upper_bound(t);return e?e.date():new Date(1/0)},l=function(t){var e=null;return u.forEach(function(n){n.date().setHours(0,0,0,0)===t.setHours(0,0,0,0)&&(e=n)}),e},p=function(){return 0===u.length?new Date(1/0):u[0].date()},h=function(){return 0===u.length?new Date(1/0):u[u.length-1]},v=function(){var t="";t+="name: "+n+" start: "+p().toString()+" end: "+h().toString()+"\n",t+="worksteps:\n";var e=u.equal_range(date);return e.forEach(function(e){t+="at: "+e.date().toString()+" what: "+e.toString()+"\n"}),t};return{getWorkstep:l,deepCloneAndClearWorksteps:d,addApplication:a,apply:f,nextDate:g,name:function(){return n},crop:function(){return r},isFallow:function(){return!r.isValid()},start:p,end:h,getWorksteps:function(){return u},clearWorksteps:function(){u=[]},toString:v,setCustomId:function(t){_customId=t},cropResult:function(){return o}}};

var DataAccessor=function(t,a){this._startDate=t,this._endDate=a,this._data=[],this._fromStep=0,this._numberOfSteps,this._acd2dataIndex=[],this.isValid=function(){return this.noOfStepsPossible()>0},this.dataForTimestep=function(t,a){var e=this._acd2dataIndex[t];return 0>e||void 0===e?0:this._data[e][this._fromStep+a]},this.dataAsVector=function(t){var a=this._acd2dataIndex[t];return 0>a||void 0===a?[]:this._data[a].slice(this._fromStep,this._fromStep+this.noOfStepsPossible())},this.cloneForRange=function(){},this.noOfStepsPossible=function(){return this._numberOfSteps},this.startDate=function(){return this._startDate},this.endDate=function(){return this._endDate},this.julianDayForStep=function(t){var a=new Date(this._startDate.getFullYear(),this._startDate.getMonth(),this._startDate.getDate()+t);return ceil((a-new Date(a.getFullYear(),0,1))/864e5)+1},this.addClimateData=function(t,a){!this._data.length>0&&this._numberOfSteps===a.length&&logger(MSG.WARN,"this._numberOfSteps === data.length"),this._data.push(a),this._acd2dataIndex[t]=this._data.length-1,this._numberOfSteps=0===this._data.length?0:a.length},this.addOrReplaceClimateData=function(){},this.hasAvailableClimateData=function(t){return this._acd2dataIndex[t]>=0}};

var Crop=function(t,n){var e=arguments[0]instanceof Crop?arguments[0]:null,r=0,i=e?e._appliedAmountIrrigation:0,u=e?e._cropHeight:0,a=e?e._cropParams:null,o=e?e._crossCropAdaptionFactor:1,c=[],s=e?e._harvestDate:new Date(1/0),d=e?e._id:t,f=e?e._name:n,l=e?e._primaryYield:0,p=e?e._primaryYieldN:0,m=e?e._primaryYieldTM:0,g=e?e._residueParams:null,_=e?e._secondaryYield:0,Y=e?e._secondaryYieldN:0,y=e?e._secondaryYieldTM:0,C=e?e._seedDate:new Date(1/0),D=e?e._sumTotalNUptake:0,T=[];return{id:function(){return d},name:function(){return f},isValid:function(){return d>-1},cropParameters:function(){return a},setCropParameters:function(t){a=t},residueParameters:function(){return g},setResidueParameters:function(t){g=t},seedDate:function(){return C},harvestDate:function(){return s},getCuttingDates:function(){return c},setSeedAndHarvestDate:function(t,n){C=t,s=n},addCuttingDate:function(t){c.push(t)},toString:toString,setHarvestYields:function(t,n){l+=t,_+=n},setHarvestYieldsTM:function(t,n){m+=t,y+=n},addCuttingYieldDM:function(t){T.push(t)},getCuttingYieldsDM:function(){return T},setYieldNContent:function(t,n){p+=t,Y+=n},addAppliedIrrigationWater:function(t){i+=t},setSumTotalNUptake:function(t){D=t},setCropHeight:function(t){u=t},setAccumulatedETa:function(t){r=t},appliedIrrigationWater:function(){return i},sumTotalNUptake:function(){return D},primaryYield:function(){return l*o},secondaryYield:function(){return _*o},primaryYieldTM:function(){return m*o},secondaryYieldTM:function(){return y*o},primaryYieldN:function(){return p},aboveGroundBiomasseN:function(){return p+Y},secondaryYieldN:function(){return Y},cropHeight:function(){return u},reset:function(){l=_=i=0,p=Y=r=0,m=_=0},get_AccumulatedETa:function(){return r},writeCropParameters:function(t){null!=t&&fs&&fs.writeFileSync(t+"/crop_parameters_"+f+".txt",a.toString(),{encoding:"utf8"})}}};

var CropGrowth=function(e,t,r,n,o){DEBUG&&debug(arguments);for(var a=e,i=t,c=r,u=o,g=e.vs_NumberOfLayers(),s=n.vs_Latitude,_=0,p=0,f=c.pc_AbovegroundOrgan,l=0,m=c.pc_AssimilatePartitioningCoeff,v=0,d=0,S=0,C=c.pc_BaseDaylength,P=c.pc_BaseTemperature,y=c.pc_BeginSensitivePhaseHeatStress,N=0,h=0,R=3,F=c.pc_CarboxylationPathway,I=0,O=0,b=c.pc_CriticalOxygenContent,x=c.pc_CriticalTemperatureHeatStress,D=0,A=1,M=0,w=c.pc_CropHeightP1,G=c.pc_CropHeightP2,B=0,E=1,T=c.pc_CropName,U=c.pc_CropSpecificMaxRootingDepth,H=new Float64Array(c.pc_NumberOfDevelopmentalStages),L=0,V=0,Y=0,k=c.pc_DaylengthRequirement,W=0,q=0,K=c.pc_DefaultRadiationUseEfficiency,z=c.pc_DevelopmentAccelerationByNitrogenStress,j=0,J=1,Q=c.pc_DroughtImpactOnFertilityFactor,X=c.pc_DroughtStressThreshold,Z=0,$=i.pc_EmergenceFloodingControlOn,et=i.pc_EmergenceMoistureControlOn,tt=c.pc_EndSensitivePhaseHeatStress,rt=0,nt=0,ot=0,at=0,it=c.pc_FixingN,ct=new Float64Array(g),ut=0,gt=0,st=0,_t=0,pt=0,ft=0,lt=0,mt=0,vt=n.vs_HeightNN,dt=c.pc_InitialKcFactor,St=c.pc_InitialOrganBiomass,Ct=c.pc_InitialRootingDepth,Pt=0,yt=.6,Nt=0,ht=c.pc_LimitingTemperatureHeatStress,Rt=c.pc_LuxuryNCoeff,Ft=0,It=c.pc_MaxAssimilationRate,Ot=c.pc_MaxCropDiameter,bt=c.pc_MaxCropHeight,xt=n.vs_MaxEffectiveRootingDepth,Dt=0,At=c.pc_MaxNUptakeParam,Mt=0,wt=c.pc_MinimumNConcentration,Gt=c.pc_MinimumTemperatureForAssimilation,Bt=c.pc_MinimumTemperatureRootGrowth,Et=c.pc_NConcentrationAbovegroundBiomass,Tt=0,Ut=0,Ht=c.pc_NConcentrationB0,Lt=c.pc_NConcentrationPN,Vt=c.pc_NConcentrationRoot,Yt=0,kt=0,Wt=new Float64Array(g),qt=0,Kt=0,zt=0,jt=0,Jt=i.pc_NitrogenResponseOn,Qt=c.pc_NumberOfDevelopmentalStages,Xt=c.pc_NumberOfOrgans,Zt=c.pc_OptimumTemperature,$t=new Float64Array(c.pc_NumberOfOrgans),er=new Float64Array(c.pc_NumberOfOrgans),tr=new Float64Array(c.pc_NumberOfOrgans),rr=new Float64Array(c.pc_NumberOfOrgans),nr=c.pc_OrganGrowthRespiration,or=c.pc_OrganMaintenanceRespiration,ar=new Float64Array(c.pc_NumberOfOrgans),ir=c.pc_OrganSenescenceRate,cr=0,ur=0,gr=0,sr=0,_r=c.pc_PlantDensity,pr=0,fr=0,lr=0,mr=0,vr=0,dr=c.pc_ResidueNRatio,Sr=0,Cr=0,Pr=0,yr=new Float64Array(g),Nr=new Float64Array(g),hr=(c.pc_RootDistributionParam,new Float64Array(g)),Rr=c.pc_RootFormFactor,Fr=c.pc_RootGrowthLag,Ir=c.pc_RootPenetrationRate,Or=0,br=0,xr=0,Dr=0,Ar=new Float64Array(g),Mr=0,wr=0,Gr=c.pc_SpecificLeafArea,Br=c.pc_SpecificRootLength,Er=c.pc_StageAtMaxDiameter,Tr=c.pc_StageAtMaxHeight,Ur=c.pc_StageKcFactor,Hr=c.pc_StageMaxRootNConcentration,Lr=c.pc_StageTemperatureSum,Vr=0,Yr=c.pc_StorageOrgan,kr=4,Wr=0,qr=0,Kr=1,zr=0,jr=0,Jr=0,Qr=0,Xr=0,Zr=0,$r=0,en=0,tn=0,rn=new Float64Array(g),nn=1,on=new Float64Array(g),an=0,cn=0,un=c.pc_VernalisationRequirement,gn=i.pc_WaterDeficitResponseOn,sn=0,_n=0,pn=!1,fn=0;g>fn;fn++)on[fn]=1;jr=u.userCropParameters.pc_Tortuosity;for(var ln=1;Qt-1>ln;ln++)tn+=Lr[ln];ot=Qt-1;for(var mn=0;Xt>mn;mn++)$t[mn]=St[mn],1==f[mn]&&(_+=St[mn]),Jr+=St[mn],1==Yr[mn]&&(kr=mn),1==Yr[mn]&&(kr=mn);Cr=St[0],Nt=$t[1]*Gr[j],0>=Nt&&(Nt=.001),Cr=$t[0],en=1e5*Cr*100/7/(225e-6*PI),Qr=_*Et+Cr*Vt,Tt=Et,Yt=Vt;var vn=a[0].vs_SoilSandContent,dn=a[0].vs_SoilBulkDensity();.55>vn&&(vn=.55),Mr=wr>0?wr:vn*((1.1-vn)/.275)*(1.4/(dn/1e3)+dn*dn/4e7),Mt=(Mr+2*U)/3,debug("vc_SoilSpecificMaxRootingDepth",Mr),debug("pc_CropSpecificMaxRootingDepth",U);var Sn=function(e,t,r,n,o,i,c,u,_,p,f){debug("vw_AtmosphericCO2Concentration",p),DEBUG&&debug(arguments),_n>0&&_n--,Cn(i,s,n,o),ur=Nn(b[j]),hn(e,P,Zt,Lr,Kr,a[0].get_Vs_SoilMoisture_m3(),a[0].get_FieldCapacity(),a[0].get_PermanentWiltingPoint(),Qt,cn,Y,E),Y=Pn(k[j],Z,sr,C[j]);var l=yn(e,Kr,un[j],an);cn=l[0],an=l[1],lr=L/tn,yt=0==j?.4:Rn(j,Lr[j],H[j],dt,Ur[j],Ur[j-1]),j>0&&(Fn(bt,Ot,Tr,Er,Lr,L,w,G),In(rr[1],ar[1],M,D,Gr[j-1],Gr[j],Gr[1],Lr[j],H[j],_r,Kr),Dr=On(Nt),bn(e,t,r,ut,p,s,Nt,K,It,Gt,S,q,I,Z,cr),xn(t,r,L),Dn(nn),An(),Mn(g,a.vs_LayerThickness(),j,v,e),fr=wn(vt,t,r,c,e,u,_,ut,p,pt),Gn(g,a.vs_LayerThickness(),Dr,xr,a.vm_GroundwaterTable,fr,f,L,tn),Bn(g,a.vs_LayerThickness(),xr,a.vm_GroundwaterTable,L,tn),lt=En(st),jt=Tn(lt,$r))},Cn=function(e,t,r,n){var o=0,a=0;q=-23.4*cos(2*PI*((e+10)/365)),o=sin(q*PI/180)*sin(t*PI/180),a=cos(q*PI/180)*cos(t*PI/180),S=12*(PI+2*asin(o/a))/PI;var i=(-sin(8*PI/180)+o)/a;Z=-1>i||i>1?.01:12*(PI+2*asin(i))/PI,sr=12*(PI+2*asin((-sin(-6*PI/180)+o)/a))/PI,gr=3600*(o*S+24/PI*a*sqrt(1-o/a*(o/a))),I=650*gr*exp(-.14/(gr/(3600*S))),cr=.2*I;var c=.082,u=1440/PI*c*(1+.033*cos(2*PI*e/365)),g=acos(-tan(t*PI/180)*tan(q*PI/180));nt=u*(g*o+a*sin(g)),ut=r>0?r:nt*(.19+.55*n/S)},Pn=function(e,t,r,n){if(DEBUG&&debug(arguments),e>0)Y=(sr-n)/(e-n);else if(0>e){var o=-e,a=-n;Y=o>=Z?1:(Z-a)/(o-a)}else Y=1;return Y>1&&(Y=1),0>Y&&(Y=0),Y},yn=function(e,t,r,n){DEBUG&&debug(arguments);var o;if(0==r)cn=1;else{o=e>-4&&0>=e?(e+4)/4:e>0&&3>=e?1:e>3&&7>=e?1-.2*(e-3)/4:e>7&&9>=e?.8-.4*(e-7)/2:e>9&&18>=e?.4-.4*(e-9)/9:-4>=e||e>18?0:1,n+=o*t;var a=min(r,9)-1;a>=1?(cn=(n-a)/(r-a),0>cn&&(cn=0)):cn=1}return[cn,n]},Nn=function(e,t,r){DEBUG&&debug(arguments);var t=t||0,r=r||0;return t=(a[0].get_Saturation()+a[1].get_Saturation()+a[2].get_Saturation()-(a[0].get_Vs_SoilMoisture_m3()+a[1].get_Vs_SoilMoisture_m3()+a[2].get_Vs_SoilMoisture_m3()))/3,e>t?(zr+=int(Kr),zr>4&&(zr=4),0>t&&(t=0),r=t/e,ur=1-int(zr/4)*(1-r)):(zr=0,ur=1),ur>1&&(ur=1),ur},hn=function(e,t,r,n,o,i,c,u,g,s,_,p){DEBUG&&debug(arguments);var f,l=0,v=0,d=0,S=a[0].get_Vs_SoilTemperature();0==j?S>t[j]&&(f=c-u,1==et&&1==$?i>.2*f+u&&a.vs_SurfaceWaterStorage<.001&&(H[j]+=(S-t[j])*o,H[j]>=n[j]&&j++):1==et&&0==$?i>.2*f+u&&(H[j]+=(S-t[j])*o,H[j]>=n[j]&&j++):0==et&&1==$?a.vs_SurfaceWaterStorage<.001&&(H[j]+=(S-t[j])*o,H[j]>=n[j]&&j++):(H[j]+=(S-t[j])*o,H[j]>=n[j]&&j++)):j>0?(l=1==z&&m[j][kr]>.9?1+(1-p)*(1-p):1,v=nn<X[j]&&m[j][kr]>.9?1>ur?1:1+(1-nn)*(1-nn):1,d=max(l,v),e>t[j]&&(e>r[j]&&(e=r[j]),H[j]+=(e-t[j])*s*_*d*o,L+=(e-t[j])*s*_*d*o),H[j]>=n[j]&&g-1>j&&j++):logger(MSG.WARN,"irregular developmental stage")},Rn=function(e,t,r,n,o,a){DEBUG&&debug(arguments);var i,c=r/t;return c>1&&(c=1),i=0==e?n+(o-n)*c:a+(o-a)*c},Fn=function(e,t,r,n,o,a,i,c){DEBUG&&debug(arguments);for(var u=0,g=1;r+1>g;g++)u+=o[g];for(var s=0,g=1;n+1>g;g++)s+=o[g];var _=a/u;_>1&&(_=1);var p=a/s;p>1&&(p=1),M=_>0?e/(1+exp(-i*(_-c))):0,D=p>0?t*p:0},In=function(e,t,r,n,o,a,i,c,u,g,s){DEBUG&&debug(arguments),Nt+=e*(o+u/c*(a-o))*s-t*i*s,0>=Nt&&(Nt=.001),gt=Nt+r*PI*n*g},On=function(e){return Dr=1-exp(-.5*e)},bn=function(e,t,r,n,o,a,i,g,s,_,p,f,l,m,S){DEBUG&&debug(arguments);var C=0,P=0,y=0,N=0,h=0,I=0,O=0,b=0,x=0,D=0,A=0,M=0,w=0,G=0,B=0,E=0,T=0,U=0,H=0,L=0,V=0,Y=0,k=0,W=0,q=0,K=0,z=0,J=0,Q=0,Z=0,$=0,et=0,tt=0,rt=0,nt=0,ot=0,at=0,it=0,ct=0,ut=0,gt=0,lt=0,vt=0,dt=0,St=0,Ct=0,Pt=0,yt=0,Nt=0,ht=0,Rt=0,It=0,Ot=0,bt=0,xt=0,Dt=0,At=0,Mt=0,wt=0,Gt=0,Bt=0,Et=u.userCropParameters,Tt=Et.pc_ReferenceLeafAreaIndex,Ut=Et.pc_ReferenceMaxAssimilationRate,Ht=Et.pc_MaintenanceRespirationParameter1,Lt=Et.pc_MaintenanceRespirationParameter2,Vt=Et.pc_GrowthRespirationParameter1,Yt=Et.pc_GrowthRespirationParameter2,kt=Et.pc_CanopyReflectionCoefficient;3==R?(h=exp(68800*(e+273-298)/(298*(e+273)*8.314))*pow((e+273)/298,.5),I=exp(65800*(e+273-298)/(298*(e+273)*8.314))*pow((e+273)/298,.5),O=exp(1400*(e+273-298)/(298*(e+273)*8.314))*pow((e+273)/298,.5),b=s/34.668,x=Ut/34.668,D=98*b*h,A=98*x*h,M=460*I,w=330*O,G=210+(.047-.0013087*e+25603e-9*e*e-2.1441e-7*e*e*e)/.026934,B=.7*o*(1.674-.061294*e+.0011688*e*e-88741e-10*e*e*e)/.73547,C=.105*D*G/(D*w),P=.105*A*G/(A*w),y=min(.77/2.1*(B-C)/(4.5*B+10.5*C)*8.3769,.5),N=min(.77/2.1*(B-P)/(4.5*B+10.5*P)*8.3769,.5)):(y=g,N=g),1==F?2==R?(_>e?(d=0,E=0):10>e?(d=s*e/10*.4,E=Ut*e/10*.4):15>e?(d=s*(.4+(e-10)/5*.5),E=Ut*(.4+(e-10)/5*.5)):25>e?(d=s*(.9+(e-15)/10*.1),E=Ut*(.9+(e-15)/10*.1)):35>e?(d=s*(1-(e-25)/10),E=Ut*(1-(e-25)/10)):(d=0,E=0),T=220+.158*(86400*n/1e6),U=80-.036*(86400*n/1e6),H=(o-U)/(T+o-U)/((350-U)/(T+350-U)),d*=H,E*=H):3==R&&(d=(B-C)*D/(B+M*(1+G/w))*1.656,E=(B-P)*A/(B+M*(1+G/w))*1.656,_>e&&(d=0,E=0)):_>e?(d=0,E=0):9>e?(d=s*e/10*.08,E=Ut*e/10*.08):14>e?(d=s*(.071+.03*(e-9)),E=Ut*(.071+.03*(e-9))):20>e?(d=s*(.221+.09*(e-14)),E=Ut*(.221+.09*(e-14))):24>e?(d=s*(.761+.04*(e-20)),E=Ut*(.761+.04*(e-20))):32>e?(d=s*(.921+.01*(e-24)),E=Ut*(.921+.01*(e-24))):38>e?(d=s,E=Ut):42>e?(d=s*(1-.01*(e-38)),E=Ut*(1-.01*(e-38))):45>e?(d=s*(.96-.04*(e-42)),E=Ut*(.96-.04*(e-42))):54>e?(d=s*(.84-.09*(e-45)),E=Ut*(.84-.09*(e-45))):(d=0,E=0),_n>0&&(d=0,E=0),.1>d&&(d=.1),.1>E&&(E=.1),L=(1-kt)*y,V=(1-kt)*N,Y=sin((90+f-a)*PI/180),k=log(1+.45*l/(3600*m)*L/(Y*d)),W=log(1+.45*l/(3600*m)*V/(Y*E)),q=Y*d*m*k/(1+k),K=Y*E*m*W/(1+W),z=log(1+.55*l/(3600*m)*L/((5-Y)*d)),J=log(1+.55*l/(3600*m)*L/((5-Y)*E)),Q=(5-Y)*d*m*z/(1+z),Z=(5-Y)*E*m*J/(1+J),$=.95*(q+Q)+20.5,et=.95*(K+Z)+20.5,tt=$*(1-exp(-.8*i)),rt=et*(1-exp(-.8*Tt)),nt=p*i*d,ot=p*Tt*E,at=nt>tt?tt*(1-exp(-nt/tt)):nt*(1-exp(-tt/nt)),it=ot>rt?rt*(1-exp(-ot/rt)):ot*(1-exp(-rt/ot)),ct=S/(3600*m)*L/(5*d),ut=5*d*m*ct/(1+ct),gt=.9935*ut+1.1,lt=gt*(1-exp(-.8*i)),vt=gt*(1-exp(-.8*Tt)),dt=nt>lt?lt*(1-exp(-nt/lt)):nt*(1-exp(-lt/nt)),St=ot>vt?vt*(1-exp(-ot/vt)):ot*(1-exp(-vt/ot)),5>i?(yt=at,Nt=dt):(yt=$,Nt=gt),Ct=it,Pt=St,It=(l-1e6*n*.5)/(.8*l),It>1&&(It=1),0>It&&(It=0),ht=It*Nt+(1-It)*yt,Rt=It*Pt+(1-It)*Ct,xt=1>ur?0:X[j],xt>nn&&(ht=ht),_t=30*ht/44,ft=22414*ht/38016e3,pt=22414*Rt/38016e3,v=30*ht/44,v*=c.pc_FieldConditionModifier,xt>nn&&(v*=nn),st=v,Dt=t-(t-r)/4,At=r+(t-r)/4;for(var Wt=0,Kt=0;Xt>Kt;Kt++)Wt+=($t[Kt]-er[Kt])*or[Kt];var zt=2-sr/12;Mt=Wt*pow(2,Ht*(Dt-Lt))*(2-zt),wt=Wt*pow(2,Ht*(At-Lt))*zt,Ft=Mt+wt,v-=Mt+wt;for(var jt=0,Kt=0;Xt>Kt;Kt++)jt+=($t[Kt]-er[Kt])*nr[Kt];v>0&&(Gt=jt*pow(2,Vt*(Dt-Yt))*(2-zt),v>Gt?v-=Gt:(Gt=v,v=0)),v>0&&(Bt=jt*pow(2,Vt*(Dt-Yt))*zt,v>Bt?v-=Bt:(Bt=v,v=0)),mt=Gt+Bt,$r=st-v,Ot=pow(2,.1*e-2.5),bt=0;for(var Kt=0;Xt>Kt;Kt++)bt+=($t[Kt]-er[Kt])*or[Kt];qt=bt*Ot>_t?_t:bt*Ot,_>e&&(_t=qt)},xn=function(e,t,r){var n=e-(e-t)/4,o=0,a=0;if(0==y&&0==tt&&(Xr=1),r>=y&&tt>r){var i=1-(n-x)/(ht-x);i>1&&(i=1),0>i&&(i=0),o=1/(1+(1/.015-1)*exp(-1.4*W)),a=W>0?1/(1+(1/.015-1)*exp(-1.4*(W-1))):0;var c=o-a;Xr+=i*c,W+=1}r>=tt&&A>Xr&&(A=Xr)},Dn=function(e){if(DEBUG&&debug(arguments),0>e&&(e=0),e<Q*X[j]&&m[j][kr]>0){var t=e/(Q*X[j]);J=1>ur?1:1-(1-t)*(1-t)}else J=1},An=function(){var e=0,t=0,r=0;O=Lt*(1+Ht*exp(-.26*(_+N)/1e3))/100,qr=O*Rt,Ut=Tt,kt=Yt,.01>Yt?.005>=Yt?e=0:(t=(Yt-.005)/.005,e=1-sqrt(1-t*t)):e=1,0==it?O>Tt?wt>=Tt?E=0:(r=(Tt-wt)/(O-wt),E=1-exp(wt-5*r)):E=1:1==it?O>Tt&&(at=O-Tt,Tt=O,E=1):E=1,0==Jt&&(E=1)},Mn=function(e,t,r,n,o){DEBUG&&debug(arguments);var i=0,c=0,g=0,s=0,l=0,v=u.userCropParameters,d=v.pc_MaxCropNDemand;Kt=n,vr=0,p=_,_=0,h=N,N=0,Jr=0,Qr+=1e4*a.vq_CropNUptake;for(var S=.3,C=0;Xt>C;C++){if(s=m[r-1][C],l=m[r][C],1==Yr[C]&&(s=s*A*J,l=l*A*J),H[r]/Lr[r]>1)rr[C]=0,ar[C]=0;else{if(0>Kt)if($t[C],C==LEAF){var P=S*Kt;abs(P)<=$t[C]?(logger(MSG.INFO,"LEAF - Reducing organ biomass - default case ("+($t[C]+rr[C])+")"),rr[C]=P):(logger(MSG.INFO,"LEAF - Not enough biomass for reduction - Reducing only what is available "),rr[C]=-1*$t[C])}else if(C==SHOOT){var P=S*Kt;abs(P)<=$t[C]?(rr[C]=P,logger(MSG.INFO,"SHOOT - Reducing organ biomass - default case ("+($t[C]+rr[C])+")")):(logger(MSG.INFO,"SHOOT - Not enough biomass for reduction - Reducing only what is available"),rr[C]=-1*$t[C])}else rr[C]=0;else rr[C]=Kt*(s+(l-s)*(H[r]/Lr[r]))*E;ar[C]=($t[C]-er[C])*(ir[r-1][C]+(ir[r][C]-ir[r-1][C])*(H[r]/Lr[r]))}C!=kr?($t[C]+=rr[C]*Kr-ar[C]*Kr,$t[kr]+=.35*ar[C]):$t[C]+=Qt>r?rr[C]*Kr-ar[C]*Kr+.3*(ar[C-1]*Kr+ar[C-2]*Kr+ar[C-3]*Kr):rr[C]*Kr-ar[C]*Kr,er[C]+=ar[C]*Kr,tr[C]=$t[C]-er[C],tr[C]<0&&(er[C]=$t[C],tr[C]=0),1==f[C]?_+=$t[C]:0==f[C]&&C>0&&(N+=$t[C]),Jr+=$t[C]}vr=0,Pr=Cr,Cr=$t[0],i=r>0?Hr[r-1]-(Hr[r-1]-Hr[r])*H[r]/Lr[r]:Hr[r],B=(qr*_+Cr*i+qr*N/dr-Qr)*Kr,c=((qr-.15*(qr-O))*_+(qr-.15*(qr-O))*N/dr+Cr*i-Qr)*Kr,B>d*Kr&&(B=d*Kr),0>B&&(B=0),g=Pr>Cr?(Pr-Cr)*Yt:0,nn<.95*X[r]&&br>.95*Mt&&Qt-1>r&&(Mt+=.005),Mt>e*t&&(Mt=e*t);var y=Bt+20,R=0;R=o>=y?y-Bt:o-Bt,0>R&&(R=0),V+=R;var F=0;F=a[Or].vs_SoilClayContent<=.02?.5*Ir:a[Or].vs_SoilClayContent<=.08?(1/3+.5/.06*a[Or].vs_SoilClayContent)*Ir:Ir,Fr>=V?br=Ct:br+=R*F,Ct>=br&&(br=Ct),br>Mt&&(br=Mt),br>xt&&(br=xt),Or=int(floor(.5+br/t)),Or>e&&(Or=e),xr=int(floor(.5+1.3*br/t)),xr>e&&(xr=e),en=Cr*Br;for(var I=new Array(e),b=0;e>b;b++)I[b]=Or>b?exp(-Rr*b*t):xr>b?exp(-Rr*b*t)*(1-int((b-Or)/(xr-Or))):0;for(var x=0,b=0;xr>b;b++)x+=I[b];for(var b=0;xr>b;b++)yr[b]=I[b]/x*en;for(var b=0;xr>b;b++)Nr[b]=0==f[3]?1e-4:2e-4-1e-5*(b+1),ct[b]+=g*yr[b]*10/en;Dt=At-L/tn,B/1e4>en*Dt*Kr?B=en*Dt*Kr:B/=1e4},wn=function(e,t,r,n,o,a,i,c,g,s){DEBUG&&debug(arguments);var _,p,f,l,m,v,d,S,C,P,y,N,h,R=u.userCropParameters,F=R.pc_SaturationBeta,I=R.pc_StomataConductanceAlpha,O=R.pc_ReferenceAlbedo;_=101.3*pow((293-.0065*e)/293,5.26),p=665e-6*_,f=.6108*exp(17.27*t/(237.3+t)),l=.6108*exp(17.27*r/(237.3+r)),m=(f+l)/2,v=0>=n?l:n*m,d=m-v,S=2503.0584*exp(17.27*o/(o+237.3))/((o+237.3)*(o+237.3)),C=a*(4.87/log(67.8*i-5.42)),P=208/C,Vr=0>=s?999999.9:g*(1+d/F)/(I*s),y=Vr/1.44;var b=(.75+2e-5*e)*nt,x=c/b,D=(1-O)*c,A=4.9e-9;return h=D-A*(pow(r+273.16,4)+pow(t+273.16,4))/2*(1.35*x-.35)*(.34-.14*sqrt(v)),N=(.408*S*h+p*(900/(o+273))*C*d)/(S+p*(1+y/P))},Gn=function(e,t,r,n,o,i,c){DEBUG&&debug(arguments),n=int(n),o=int(o);var u=0;pr=0;var g=0,s=0;l=0;var _=0,p=0,f=0,m=0,v=0;mr=0;for(var d=0;e>d;d++)rn[d]=0,on[d]=0,hr[d]=0;var S=Pt;if(v=2.5*M*r-Pt,0>v&&(v=0),0>=c&&(v=0),v>=c?(v=c,zt=0):zt=c-v,Pt=S+v,g=i*yt,g>6.5&&(g=6.5),mr=g,Pt>0?mr>=Pt?(mr-=Pt,rt=Pt,Pt=0):(Pt-=mr,rt=mr,mr=0):rt=0,ot>j){pr=mr*r;for(var d=0;n>d;d++){var C=a[d].get_FieldCapacity()-a[d].get_PermanentWiltingPoint(),P=(a[d].get_Vs_SoilMoisture_m3()-a[d].get_PermanentWiltingPoint())/C;0>P&&(P=0),.15>P?(on[d]=3*P,hr[d]=.15+.45*P/.15):.3>P?(on[d]=.45+.25*(P-.15)/.15,hr[d]=.6+.2*(P-.15)/.15):.5>P?(on[d]=.7+.275*(P-.3)/.2,hr[d]=.8+.2*(P-.3)/.2):.75>P?(on[d]=.975+.025*(P-.5)/.25,hr[d]=1):(on[d]=1,hr[d]=1),on[d]<0&&(on[d]=0),hr[d]<0&&(hr[d]=0),d==o&&(hr[d]=.5),d>o&&(hr[d]=0),(d+1)*t>=xt&&(hr[d]=0),f+=hr[d]*yr[d],_=f}for(var d=0;e>d;d++)rn[d]=d>min(n,o+1)?0:pr*(hr[d]*yr[d]/f)*ur;for(var d=0;d<min(n,o+1);d++){if(_-=hr[d]*yr[d],0>=_&&(_=1e-5),rn[d]/1e3/t>a[d].get_Vs_SoilMoisture_m3()-a[d].get_PermanentWiltingPoint()?(u=(rn[d]/1e3/t-(a[d].get_Vs_SoilMoisture_m3()-a[d].get_PermanentWiltingPoint()))*t*1e3,0>u&&(u=0),u>rn[d]&&(u=rn[d])):u=0,s=rn[d]*(1-on[d]),m=max(s,u),m>0&&d<min(n,o+1))for(var y=d+1;y<min(n,o+1);y++)rn[y]+=m*(hr[y]*yr[y]/_);rn[d]=rn[d]-m,rn[d]<0&&(rn[d]=0),l+=rn[d],d==o&&(p=rn[d]/1e3/t)}nn=pr>0?l/pr:1;var N=int(o-Or);1>=N&&(nn=1),0==gn&&(nn=1)}},Bn=function(e,t,r,n){DEBUG&&debug(arguments),r=int(r),n=int(n);for(var o=0,i=0,c=[],g=[],s=[],f=0;e>f;f++)c[f]=0,g[f]=0,s[f]=0;var l=0,m=0,v=u.userCropParameters,d=v.pc_MinimumAvailableN,S=v.pc_MinimumNConcentrationRoot,C=v.pc_MaxCropNDemand;Zr=0;for(var P=0;e>P;P++)Wt[P]=0;if(ot>j){for(var P=0;P<min(r,n);P++)Ar[P]=a[P].vs_SoilNO3,c[P]=rn[P]/1e3*(Ar[P]/a[P].get_Vs_SoilMoisture_m3())*Kr,o+=c[P],g[P]=214e-6*jr*exp(10*a[P].get_Vs_SoilMoisture_m3())/a[P].get_Vs_SoilMoisture_m3(),s[P]=g[P]*a[P].get_Vs_SoilMoisture_m3()*2*PI*Nr[P]*(Ar[P]/1e3/a[P].get_Vs_SoilMoisture_m3()-14e-6)*sqrt(PI*yr[P])*yr[P]*1e3*Kr,s[P]<0&&(s[P]=0),i+=s[P];for(var P=0;P<min(r,n);P++)B>0?(Wt[P]=o>=B?B*c[P]/o:i>B-o?c[P]+(B-o)*s[P]/i:c[P]+s[P],l+=c[P],m+=s[P],Wt[P]>Ar[P]*t-d&&(Wt[P]=Ar[P]*t-d),Wt[P]>C/1e4*.75&&(Wt[P]=C/1e4*.75),Wt[P]<0&&(Wt[P]=0)):Wt[P]=0,Zr+=1e4*Wt[P]}Wr+=Zr,Cr>Pr&&(Yt=(Pr*Yt+(Cr-Pr)/(_-p+N-h+Cr-Pr)*Zr)/Cr,Yt=min(Yt,Hr[j]),S>Yt&&(Yt=S)),Tt=(Qr+Zr-Cr*Yt)/(_+N/dr),p*Ut>Tt*_&&(Tt=p*Ut/_,Yt=(Qr+Zr-_*Tt-Tt/dr*N)/Cr)},En=function(e){var t=0;return t=e/30*12},Tn=function(e,t){var r=0;return Sr=t/30*12,r=e-Sr},Un=function(){for(var e=0,t=0,r=f.length;r>t;t++)f[t]&&e++;return e},Hn=function(e){return rr[e]},Ln=function(e){return rn[e]},Vn=function(e){return $t[e]},Yn=function(e){return Wt[e]},kn=function(){return _*Tt},Un=function(){for(var e=0,t=0,r=f.length;r>t;t++)f[t]&&e++;return e},Wn=function(e,t){DEBUG&&0===e.length&&debug("organIdsForPrimaryYield",e);for(var r=0,n=0,o=e.length;o>n;n++)r+=t[e[n].organId-1]*e[n].yieldPercentage;return r},qn=function(e,t){DEBUG&&0===e.length&&debug("organIdsForPrimaryYield",e);for(var r=0,n=0,o=e.length;o>n;n++)r+=t[e[n].organId-1]*e[n].yieldPercentage/e[n].yieldDryMatter;return r},Kn=function(){return 0===c.organIdsForPrimaryYield.length?Wn(c.organIdsForCutting,$t):Wn(c.organIdsForPrimaryYield,$t)},zn=function(){return Wn(c.organIdsForSecondaryYield,$t)},jn=function(){return 0===c.organIdsForPrimaryYield.length?qn(c.organIdsForCutting,$t):qn(c.organIdsForPrimaryYield,$t)},Jn=function(){return qn(c.organIdsForSecondaryYield,$t)},Qn=function(e){return Jr-Vn(0)-Kn()-(e?zn():0)},Xn=function(){return(Qr-Vn(0)*go())/(Kn()/dr+(Jr-Vn(0)-Kn()))},Zn=function(){return(Qr-Vn(0)*go())/(Kn()+dr*(Jr-Vn(0)-Kn()))},$n=function(e){return Qn(e)*Xn()},eo=function(){return Kn()*Zn()},to=function(){return 6.25*Zn()},ro=function(){return zn()*Xn()},no=function(){return 1e4*B},oo=function(){return $r/30*12},ao=function(e){var t=ra(),r=Vn(e)/t;return oo()*r},io=function(e){var t=ra(),r=Vn(e)/t;return Zo()*r},co=function(){var e=_,t=0;logger(MSG.INFO,"apply cutting");for(var r=[],n=1;Xt+1>n;n++){var o=c.organIdsForCutting.length,a=$t[n-1];logger(MSG.INFO,"old biomass: "+a+"	Organ: "+n);for(var i=0;o>i;i++){var u=new YieldComponent(c.organIdsForCutting[i]);n==u.organId&&(a=$t[n-1]*(1-u.yieldPercentage),_-=a,t+=a)}r.push(a),logger(MSG.INFO,"new biomass: "+a)}Qr=t/e*Qr,$t=new Float64Array(r);for(var g=c.pc_StageAfterCut-1,s=g;Qt>s;s++)H[s]=0;L=0,j=g,_n=c.pc_CuttingDelayDays,It=.9*It,Nt=$t[1]*Gr[j]},uo=function(e){sn+=e},go=function(){return Yt},so=function(){for(var e=0;g>e;e++)if(0==hr[e])return(e+1)/10;return(g+1)/10},_o=function(){return T},po=function(){return ft},fo=function(){return _t},lo=function(){return d},mo=function(){return v},vo=function(){return qt},So=function(){return Ft},Co=function(){return mt},Po=function(){return cn},yo=function(){return Y},No=function(){return Kt},ho=function(){return fr},Ro=function(){return mr},Fo=function(){return rt},Io=function(){return zt},Oo=function(){return Nt},bo=function(){return M},xo=function(){return Or},Do=function(){return Dr},Ao=function(){return yt},Mo=function(){return Vr},wo=function(){return pr},Go=function(){return l},Bo=function(){return nn},Eo=function(){return ur},To=function(){return E},Uo=function(){return A},Ho=function(){return L},Lo=function(){return j},Vo=function(){return lr},Yo=function(){return _},ko=function(){return Qr},Wo=function(){return qr},qo=function(){return O},Ko=function(){return Tt},zo=function(){return c.pc_HeatSumIrrigationStart},jo=function(){return c.pc_HeatSumIrrigationEnd},Jo=function(){return Wr},Qo=function(){return Zr},Xo=function(){return lt},Zo=function(){return jt},$o=function(){return sn},ea=function(){return pn},ta=function(){return Xt},ra=function(){return Jr};return{accumulateEvapotranspiration:uo,applyCutting:co,fc_CropDevelopmentalStage:hn,fc_CropDryMatter:Mn,fc_CropGreenArea:In,fc_CropNUptake:Bn,fc_CropNitrogen:An,fc_CropPhotosynthesis:bn,fc_CropSize:Fn,fc_CropWaterUptake:Gn,fc_DaylengthFactor:Pn,fc_DroughtImpactOnFertility:Dn,fc_GrossPrimaryProduction:En,fc_HeatStressImpact:xn,fc_KcFactor:Rn,fc_NetPrimaryProduction:Tn,fc_OxygenDeficiency:Nn,fc_Radiation:Cn,fc_ReferenceEvapotranspiration:wn,fc_SoilCoverage:On,fc_VernalisationFactor:yn,getEffectiveRootingDepth:so,get_AbovegroundBiomass:Yo,get_AbovegroundBiomassNConcentration:Ko,get_AbovegroundBiomassNContent:kn,get_AbovegroundBiomassNContent:kn,get_AccumulatedETa:$o,get_ActNUptake:Qo,get_ActualTranspiration:Go,get_Assimilates:mo,get_AssimilationRate:lo,get_AutotrophicRespiration:oo,get_CriticalNConcentration:qo,get_CropHeight:bo,get_CropNRedux:To,get_CropName:_o,get_CurrentTemperatureSum:Ho,get_DaylengthFactor:yo,get_DevelopmentalStage:Lo,get_EvaporatedFromIntercept:Fo,get_FreshPrimaryCropYield:jn,get_FreshSecondaryCropYield:Jn,get_GrossPhotosynthesisHaRate:fo,get_GrossPhotosynthesisRate:po,get_GrossPrimaryProduction:Xo,get_GrowthRespirationAS:Co,get_HeatStressRedux:Uo,get_HeatSumIrrigationEnd:jo,get_HeatSumIrrigationStart:zo,get_KcFactor:Ao,get_LeafAreaIndex:Oo,get_MaintenanceRespirationAS:So,get_NUptakeFromLayer:Yn,get_NUptakeFromLayer:Yn,get_NetMaintenanceRespiration:vo,get_NetPhotosynthesis:No,get_NetPrecipitation:Io,get_NetPrimaryProduction:Zo,get_NumberOfOrgans:ta,get_OrganBiomass:Vn,get_OrganBiomass:Vn,get_OrganGrowthIncrement:Hn,get_OrganGrowthIncrement:Hn,get_OrganSpecificNPP:io,get_OrganSpecificTotalRespired:ao,get_OxygenDeficit:Eo,get_PotNUptake:no,get_PotentialTranspiration:wo,get_PrimaryCropYield:Kn,get_PrimaryYieldNConcentration:Zn,get_PrimaryYieldNContent:eo,get_RawProteinConcentration:to,get_ReferenceEvapotranspiration:ho,get_RelativeTotalDevelopment:Vo,get_RemainingEvapotranspiration:Ro,get_ResidueBiomass:Qn,get_ResiduesNConcentration:Xn,get_ResiduesNContent:$n,get_RootNConcentration:go,get_RootNConcentration:go,get_RootingDepth:xo,get_SecondaryCropYield:zn,get_SecondaryYieldNContent:ro,get_SoilCoverage:Do,get_StomataResistance:Mo,get_SumTotalNUptake:Jo,get_TargetNConcentration:Wo,get_TotalBiomassNContent:ko,get_Transpiration:Ln,get_Transpiration:Ln,get_TranspirationDeficit:Bo,get_VernalisationFactor:Po,isDying:ea,pc_NumberOfAbovegroundOrgans:Un,step:Sn,totalBiomass:ra}};

var Environment=function(e,i){this.mode="MyMode",arguments[0]instanceof Environment?(debug("Copy constructor: Env	soil param size: "+env.soilParams.length),this.env=arguments[0],this.customId=env.customId,this.soilParams=env.soilParams,this.noOfLayers=env.noOfLayers,this.layerThickness=env.layerThickness,this.useNMinMineralFertilisingMethod=env.useNMinMineralFertilisingMethod,this.useAutomaticIrrigation=env.useAutomaticIrrigation,this.useSecondaryYields=env.useSecondaryYields,this.windSpeedHeight=env.windSpeedHeight,this.atmosphericCO2=env.atmosphericCO2,this.albedo=env.albedo,this.da=env.da,this.cropRotation=env.cropRotation,this.site=env.site,this.general=env.general,this.organic=env.organic,this.nMinFertiliserPartition=env.nMinFertiliserPartition,this.nMinUserParams=env.nMinUserParams,this.autoIrrigationParams=env.autoIrrigationParams,this.centralParameterProvider=env.centralParameterProvider,this.pathToOutputDir=env.pathToOutputDir,this.mode=env.mode):(this.soilParams=e,this.customId=-1,this.centralParameterProvider=i,this.pathToOutputDir=null,this.user_env=this.centralParameterProvider.userEnvironmentParameters,this.windSpeedHeight=this.user_env.p_WindSpeedHeight,this.atmosphericCO2=this.user_env.p_AthmosphericCO2,this.albedo=this.user_env.p_Albedo,this.noOfLayers=this.user_env.p_NumberOfLayers,this.layerThickness=this.user_env.p_LayerThickness,this.useNMinMineralFertilisingMethod=this.user_env.p_UseNMinMineralFertilisingMethod,this.useAutomaticIrrigation=this.user_env.p_UseAutomaticIrrigation,this.useSecondaryYields=this.user_env.p_UseSecondaryYields,this.cropRotation=null);this.getMode=function(){return mode},this.setCropRotation=function(e){this.cropRotation=e}};

var Model=function(r,t){var e=this;this._currentCropGrowth=null,this.cropGrowth=function(){return e._currentCropGrowth};var n=r,o=new SoilColumn(n.general,n.soilParams,n.centralParameterProvider),i=new SoilTemperature(o,this,n.centralParameterProvider),a=new SoilMoisture(o,n.site,this,n.centralParameterProvider),u=new SoilOrganic(o,n.general,n.site,n.centralParameterProvider),s=new SoilTransport(o,n.site,n.centralParameterProvider),c=0,l=0,p=0,m=t,g=n.centralParameterProvider,d=0,C=0,_=0,h=0,f=0;this.vw_AtmosphericCO2Concentration,this.vs_GroundwaterDepth;var v=null,w=function(r){debug("seedCrop"),e._currentCropGrowth=null,d=0,C=0,_=0,h=0,f=0;var t=null;if(v=r,v.isValid()){if(t=v.cropParameters(),e._currentCropGrowth=new CropGrowth(o,n.general,t,n.site,n.centralParameterProvider),s.put_Crop(e._currentCropGrowth),o.put_Crop(e._currentCropGrowth),a.put_Crop(e._currentCropGrowth),u.put_Crop(e._currentCropGrowth),logger(MSG.INFO,"seedDate: "+v.seedDate().toString()+" harvestDate: "+v.harvestDate().toString()),n.useNMinMineralFertilisingMethod&&v.seedDate().dayOfYear()<=v.harvestDate().dayOfYear()){logger(MSG.INFO,"nMin fertilising summer crop");var i=O(n.nMinFertiliserPartition,NMinCropParameters(t.pc_SamplingDepth,t.pc_TargetNSamplingDepth,t.pc_TargetN30));nt(i)}v.writeCropParameters(n.pathToOutputDir)}},S=function(){if(v&&v.isValid()){var r=e._currentCropGrowth.get_OrganBiomass(0),t=e._currentCropGrowth.get_RootNConcentration();logger(MSG.INFO,"adding organic matter from root to soilOrganic"),logger(MSG.INFO,"root biomass: "+r+" Root N concentration: "+t),u.addOrganicMatter(v.residueParameters(),r,t);var i=e._currentCropGrowth.get_ResidueBiomass(n.useSecondaryYields),c=e._currentCropGrowth.get_ResiduesNConcentration();logger(MSG.INFO,"adding organic matter from residues to soilOrganic"),logger(MSG.INFO,"residue biomass: "+i+" Residue N concentration: "+c),logger(MSG.INFO,"primary yield biomass: "+e._currentCropGrowth.get_PrimaryCropYield()+" Primary yield N concentration: "+e._currentCropGrowth.get_PrimaryYieldNConcentration()),logger(MSG.INFO,"secondary yield biomass: "+e._currentCropGrowth.get_SecondaryCropYield()+" Secondary yield N concentration: "+e._currentCropGrowth.get_PrimaryYieldNConcentration()),logger(MSG.INFO,"Residues N content: "+e._currentCropGrowth.get_ResiduesNContent()+" Primary yield N content: "+e._currentCropGrowth.get_PrimaryYieldNContent()+" Secondary yield N content: "+e._currentCropGrowth.get_SecondaryYieldNContent()),u.addOrganicMatter(v.residueParameters(),i,c)}e._currentCropGrowth=null,v=null,s.remove_Crop(),o.remove_Crop(),a.remove_Crop()},G=function(){if(v&&v.isValid()){var r=e._currentCropGrowth.totalBiomass(),t=e._currentCropGrowth.get_AbovegroundBiomassNConcentration()+e._currentCropGrowth.get_RootNConcentration();logger(MSG.INFO,"Adding organic matter from total biomass of crop to soilOrganic"),logger(MSG.INFO,"Total biomass: "+r+" Total N concentration: "+t),u.addOrganicMatter(v.residueParameters(),r,t)}e._currentCropGrowth=null,v=null,s.remove_Crop(),o.remove_Crop(),a.remove_Crop()},y=function(r,t){n.useNMinMineralFertilisingMethod||(o.applyMineralFertiliser(r,t),nt(t))},M=function(r,t,e){logger(MSG.INFO,"MONICA model: applyOrganicFertiliser:	"+t+"	"+r.vo_NConcentration),u.setIncorporation(e),u.addOrganicMatter(r,t,r.vo_NConcentration),nt(t*r.vo_NConcentration)},O=function(r,t){var e=n.nMinUserParams,i=o.applyMineralFertiliserViaNMinMethod(r,t.samplingDepth,t.nTarget,t.nTarget30,e.min,e.max,e.delayInDays);return i},F=function(r,t){n.useAutomaticIrrigation||(u.addIrrigationWater(r),o.applyIrrigation(r,t),v&&(v.addAppliedIrrigationWater(r),this.addDailySumIrrigationWater(r)))},N=function(r){o.applyTillage(r)},D=function(r){var t=m.startDate(),c=new Date(t.getFullYear(),t.getMonth(),t.getDate()+r),l=m.julianDayForStep(r),p=c.getFullYear(),d=c.isLeapYear(),C=m.dataForTimestep(Climate.tmin,r),_=m.dataForTimestep(Climate.tavg,r),h=m.dataForTimestep(Climate.tmax,r),f=m.dataForTimestep(Climate.precip,r),w=m.dataForTimestep(Climate.wind,r),S=m.dataForTimestep(Climate.globrad,r);debug("-------- generalStep "+r+" ---------"),debug(c.toLocaleDateString());var G=m.hasAvailableClimateData(Climate.relhumid)?m.dataForTimestep(Climate.relhumid,r):-1,y=g.userEnvironmentParameters;e.vw_AtmosphericCO2Concentration=-1==n.atmosphericCO2?y.p_AthmosphericCO2:n.atmosphericCO2,e.vs_GroundwaterDepth=A(y.p_MaxGroundwaterDepth,y.p_MinGroundwaterDepth,y.p_MinGroundwaterDepthMonth,l,d),0==int(e.vw_AtmosphericCO2Concentration)&&(e.vw_AtmosphericCO2Concentration=P(p,l,d));var M=y.p_JulianDayAutomaticFertilising;o.deleteAOMPool(),o.applyPossibleDelayedFerilizer();var F=o.applyPossibleTopDressing();if(nt(F),v&&v.isValid()&&n.useNMinMineralFertilisingMethod&&v.seedDate().dayOfYear()>v.harvestDate().dayOfYear()&&m.julianDayForStep(r)==M){logger(MSG.INFO,"nMin fertilising winter crop");var N=v.cropParameters(),D=O(n.nMinFertiliserPartition,NMinCropParameters(N.pc_SamplingDepth,N.pc_TargetNSamplingDepth,N.pc_TargetN30));nt(D)}i.step(C,h,S),a.step(e.vs_GroundwaterDepth,f,h,C,G/100,_,w,n.windSpeedHeight,S,l),u.step(_,f,w),s.step()},T=function(r){if(e._currentCropGrowth){d++;var t=m.julianDayForStep(r),i=m.dataForTimestep(Climate.tavg,r),a=m.dataForTimestep(Climate.tmax,r),s=m.dataForTimestep(Climate.tmin,r),c=m.dataForTimestep(Climate.globrad,r),l=m.hasAvailableClimateData(Climate.sunhours)?m.dataForTimestep(Climate.sunhours,r):-1,w=m.hasAvailableClimateData(Climate.relhumid)?m.dataForTimestep(Climate.relhumid,r):-1,S=m.dataForTimestep(Climate.wind,r),G=m.dataForTimestep(Climate.precip,r),y=g.userEnvironmentParameters.p_WindSpeedHeight;if(e._currentCropGrowth.step(i,a,s,c,l,t,w/100,S,y,e.vw_AtmosphericCO2Concentration,G),n.useAutomaticIrrigation){var M=n.autoIrrigationParams;o.applyIrrigationViaTrigger(M.treshold,M.amount,M.nitrateConcentration)&&(u.addIrrigationWater(M.amount),v.addAppliedIrrigationWater(M.amount),p+=M.amount)}C+=e._currentCropGrowth.get_CropNRedux(),_+=e._currentCropGrowth.get_TranspirationDeficit(),h+=e._currentCropGrowth.get_HeatStressRedux(),f+=e._currentCropGrowth.get_OxygenDeficit()}},P=function(r,t,e){var n,o;return o=e?r+t/366:r+t/365,n=222+exp(.0119*(o-1580))+2.5*sin((o-.5)/.1592)},A=function(r,t,e,n,o){var i,a,u,s;a=o?366:365,u=(r+t)/2,s=(r-t)/2;var c=sin(3.14159265358979*(n/a*360-90-(30*e-15))/180);return i=u+c*s,0>i&&(i=20),i},I=function(r){for(var t=0,e=0,i=0,a=0,u=n.noOfLayers;u>a&&(i++,e+=o[a].vs_SoilOrganicCarbon(),t+=o[a].vs_LayerThickness,!(t>=r));a++);return e/i*100},R=function(){return a.meanWaterContent(.9)},b=function(r,t){return a.meanWaterContent(r,t)},W=function(r){for(var t=0,e=0,i=0,a=0,u=n.noOfLayers;u>a&&(i++,e+=o[a].get_SoilNmin(),t+=o[a].vs_LayerThickness,!(t>=r));a++);return e/i*t*1e4},V=function(r){for(var t=0,e=0,i=0,a=0,u=n.noOfLayers;u>a&&(i++,e+=o[a].get_SoilNO3(),t+=o[a].vs_LayerThickness,!(t>=r));a++);return e},Y=function(){return a.get_GroundwaterRecharge()},L=function(){return s.get_NLeaching()},x=function(r){return o.sumSoilTemperature(r)},E=function(){return a.getMaxSnowDepth()},H=function(){return a.accumulatedSnowDepth()},B=function(){return a.getAccumulatedFrostDepth()},j=function(){for(var r=3,t=0,e=0;r>e;e++)t+=o.soilLayer(e).get_Vs_SoilTemperature();return t/r},k=function(r,t){for(var e=0,n=0,i=r;t>i;i++)n+=o.soilLayer(i).get_Vs_SoilMoisture_m3(),e++;return n/e},z=function(r,t){for(var e=0,n=0,o=r;t>o;o++)n+=a.get_CapillaryRise(o),e++;return n/e},J=function(r,t){for(var e=0,n=0,o=r;t>o;o++)n+=a.get_PercolationRate(o),e++;return n/e},U=function(){return a.get_SumSurfaceRunOff()},q=function(){return a.get_SurfaceRunOff()},K=function(){return 0!=e._currentCropGrowth?e._currentCropGrowth.get_RemainingEvapotranspiration():0},Q=function(){return 0!=e._currentCropGrowth?e._currentCropGrowth.get_ActualTranspiration():0},X=function(){return 0!=e._currentCropGrowth?e._currentCropGrowth.get_EvaporatedFromIntercept():0},Z=function(){return a.get_Evapotranspiration()},$=function(){for(var r=0,t=0;3>t;t++)r+=u.get_SMB_CO2EvolutionRate(t);return r},rt=function(){return u.get_NH3_Volatilised()},tt=function(){return u.get_SumNH3_Volatilised()},et=function(){for(var r=0,t=0;3>t;t++)r+=u.get_ActDenitrificationRate(t);return r},nt=function(r){l+=r,c+=r};return{cropGrowth:this.cropGrowth,generalStep:D,cropStep:T,CO2ForDate:P,GroundwaterDepthForDate:A,seedCrop:w,currentCrop:function(){return v},isCropPlanted:function(){return v&&v.isValid()},harvestCurrentCrop:S,incorporateCurrentCrop:G,applyMineralFertiliser:y,applyOrganicFertiliser:M,useNMinMineralFertilisingMethod:function(){return n.useNMinMineralFertilisingMethod},applyMineralFertiliserViaNMinMethod:O,dailySumFertiliser:function(){return l},addDailySumFertiliser:nt,dailySumIrrigationWater:function(){return p},addDailySumIrrigationWater:function(r){p+=r},sumFertiliser:function(){return c},resetFertiliserCounter:function(){c=0},resetDailyCounter:function(){p=0,l=0},applyIrrigation:F,applyTillage:N,get_AtmosphericCO2Concentration:function(){return e.vw_AtmosphericCO2Concentration},get_GroundwaterDepth:function(){return e.vs_GroundwaterDepth},writeOutputFiles:function(){return g.writeOutputFiles},avgCorg:I,mean90cmWaterContent:R,meanWaterContent:b,sumNmin:W,groundWaterRecharge:Y,nLeaching:L,sumSoilTemperature:x,sumNO3AtDay:V,maxSnowDepth:E,accumulatedSnowDepth:H,accumulatedFrostDepth:B,avg30cmSoilTemperature:j,avgSoilMoisture:k,avgCapillaryRise:z,avgPercolationRate:J,sumSurfaceRunOff:U,surfaceRunoff:q,getEvapotranspiration:K,getTranspiration:Q,getEvaporation:X,get_sum30cmSMB_CO2EvolutionRate:$,getNH3Volatilised:rt,getSumNH3Volatilised:tt,getsum30cmActDenitrificationRate:et,getETa:Z,vw_AtmosphericCO2Concentration:this.vw_AtmosphericCO2Concentration,vs_GroundwaterDepth:this.vs_GroundwaterDepth,soilTemperature:function(){return i},soilMoisture:function(){return a},soilOrganic:function(){return u},soilTransport:function(){return s},soilColumn:function(){return o},soilColumnNC:function(){return o},netRadiation:function(r){return r*(1-n.albedo)},daysWithCrop:function(){return d},getAccumulatedNStress:function(){return C},getAccumulatedWaterStress:function(){return _},getAccumulatedHeatStress:function(){return h},getAccumulatedOxygenStress:function(){return f}}};

var getCropParameters=function(e){var a=new CropParameters,t=db.exec("SELECT id, name, perennial, max_assimilation_rate,     carboxylation_pathway, minimum_temperature_for_assimilation,     crop_specific_max_rooting_depth, min_n_content,     n_content_pn, n_content_b0,     n_content_above_ground_biomass, n_content_root, initial_kc_factor,     development_acceleration_by_nitrogen_stress, fixing_n,     luxury_n_coeff, max_crop_height, residue_n_ratio,     sampling_depth, target_n_sampling_depth, target_n30,     default_radiation_use_efficiency, crop_height_P1, crop_height_P2,     stage_at_max_height, max_stem_diameter, stage_at_max_diameter,     heat_sum_irrigation_start, heat_sum_irrigation_end,     max_N_uptake_p, root_distribution_p, plant_density,     root_growth_lag, min_temperature_root_growth, initial_rooting_depth,     root_penetration_rate, root_form_factor, specific_root_length,     stage_after_cut, crit_temperature_heat_stress,     lim_temperature_heat_stress, begin_sensitive_phase_heat_stress,     end_sensitive_phase_heat_stress, drought_impact_on_fertility_factor,     cutting_delay_days, field_condition_modifier, assimilate_reallocation     FROM crop     WHERE id = "+e);if(1!=t[0].values.length)throw"cropId ("+e+") not available in table crop";var i=t[0].columns,r=t[0].values[0];a.pc_CropName=r[i.indexOf("name")],a.pc_MaxAssimilationRate=r[i.indexOf("max_assimilation_rate")],a.pc_CarboxylationPathway=r[i.indexOf("carboxylation_pathway")],a.pc_MinimumTemperatureForAssimilation=r[i.indexOf("minimum_temperature_for_assimilation")],a.pc_CropSpecificMaxRootingDepth=r[i.indexOf("crop_specific_max_rooting_depth")],a.pc_MinimumNConcentration=r[i.indexOf("min_n_content")],a.pc_NConcentrationPN=r[i.indexOf("n_content_pn")],a.pc_NConcentrationB0=r[i.indexOf("n_content_b0")],a.pc_NConcentrationAbovegroundBiomass=r[i.indexOf("n_content_above_ground_biomass")],a.pc_NConcentrationRoot=r[i.indexOf("n_content_root")],a.pc_InitialKcFactor=r[i.indexOf("initial_kc_factor")],a.pc_DevelopmentAccelerationByNitrogenStress=r[i.indexOf("development_acceleration_by_nitrogen_stress")],a.pc_FixingN=r[i.indexOf("fixing_n")],a.pc_LuxuryNCoeff=r[i.indexOf("luxury_n_coeff")],a.pc_MaxCropHeight=r[i.indexOf("max_crop_height")],a.pc_ResidueNRatio=r[i.indexOf("residue_n_ratio")],a.pc_SamplingDepth=r[i.indexOf("sampling_depth")],a.pc_TargetNSamplingDepth=r[i.indexOf("target_n_sampling_depth")],a.pc_TargetN30=r[i.indexOf("target_n30")],a.pc_DefaultRadiationUseEfficiency=r[i.indexOf("default_radiation_use_efficiency")],a.pc_CropHeightP1=r[i.indexOf("crop_height_P1")],a.pc_CropHeightP2=r[i.indexOf("crop_height_P2")],a.pc_StageAtMaxHeight=r[i.indexOf("stage_at_max_height")],a.pc_MaxCropDiameter=r[i.indexOf("max_stem_diameter")],a.pc_StageAtMaxDiameter=r[i.indexOf("stage_at_max_diameter")],a.pc_HeatSumIrrigationStart=r[i.indexOf("heat_sum_irrigation_start")],a.pc_HeatSumIrrigationEnd=r[i.indexOf("heat_sum_irrigation_end")],a.pc_MaxNUptakeParam=r[i.indexOf("max_N_uptake_p")],a.pc_RootDistributionParam=r[i.indexOf("root_distribution_p")],a.pc_PlantDensity=r[i.indexOf("plant_density")],a.pc_RootGrowthLag=r[i.indexOf("root_growth_lag")],a.pc_MinimumTemperatureRootGrowth=r[i.indexOf("min_temperature_root_growth")],a.pc_InitialRootingDepth=r[i.indexOf("initial_rooting_depth")],a.pc_RootPenetrationRate=r[i.indexOf("root_penetration_rate")],a.pc_RootFormFactor=r[i.indexOf("root_form_factor")],a.pc_SpecificRootLength=r[i.indexOf("specific_root_length")],a.pc_StageAfterCut=r[i.indexOf("stage_after_cut")],a.pc_CriticalTemperatureHeatStress=r[i.indexOf("crit_temperature_heat_stress")],a.pc_LimitingTemperatureHeatStress=r[i.indexOf("lim_temperature_heat_stress")],a.pc_BeginSensitivePhaseHeatStress=r[i.indexOf("begin_sensitive_phase_heat_stress")],a.pc_EndSensitivePhaseHeatStress=r[i.indexOf("end_sensitive_phase_heat_stress")],a.pc_DroughtImpactOnFertilityFactor=r[i.indexOf("drought_impact_on_fertility_factor")],a.pc_CuttingDelayDays=r[i.indexOf("cutting_delay_days")],a.pc_FieldConditionModifier=r[i.indexOf("field_condition_modifier")];var t=db.exec("SELECT o.crop_id, o.id, o.initial_organ_biomass,     o.organ_maintainance_respiration, o.is_above_ground,     o.organ_growth_respiration, o.is_storage_organ     FROM organ as o inner join crop as c on c.id = o.crop_id     WHERE crop_id = "+e+"     ORDER BY o.crop_id, c.id");if(0===t[0].values.length)throw"cropId ("+e+") not available in table organ";for(var i=t[0].columns,o=t[0].values,n=0,_=o.length;_>n;n++){var r=o[n];a.pc_NumberOfOrgans++,a.pc_InitialOrganBiomass.push(r[i.indexOf("initial_organ_biomass")]),a.pc_OrganMaintenanceRespiration.push(r[i.indexOf("organ_maintainance_respiration")]),a.pc_AbovegroundOrgan.push(1==r[i.indexOf("is_above_ground")]),a.pc_OrganGrowthRespiration.push(r[i.indexOf("organ_growth_respiration")]),a.pc_StorageOrgan.push(1==r[i.indexOf("is_storage_organ")])}var t=db.exec("SELECT id, stage_temperature_sum,     base_temperature, opt_temperature, vernalisation_requirement,     day_length_requirement, base_day_length,     drought_stress_threshold, critical_oxygen_content,     specific_leaf_area, stage_max_root_n_content,     stage_kc_factor     FROM dev_stage     WHERE crop_id = "+e+"     order by id");if(0===t[0].values.length)throw"cropId ("+e+") not available in table dev_stage";for(var i=t[0].columns,o=t[0].values,n=0,_=o.length;_>n;n++){var r=o[n];a.pc_NumberOfDevelopmentalStages++,a.pc_StageTemperatureSum.push(r[i.indexOf("stage_temperature_sum")]),a.pc_BaseTemperature.push(r[i.indexOf("base_temperature")]),a.pc_OptimumTemperature.push(r[i.indexOf("opt_temperature")]),a.pc_VernalisationRequirement.push(r[i.indexOf("vernalisation_requirement")]),a.pc_DaylengthRequirement.push(r[i.indexOf("day_length_requirement")]),a.pc_BaseDaylength.push(r[i.indexOf("base_day_length")]),a.pc_DroughtStressThreshold.push(r[i.indexOf("drought_stress_threshold")]),a.pc_CriticalOxygenContent.push(r[i.indexOf("critical_oxygen_content")]),a.pc_SpecificLeafArea.push(r[i.indexOf("specific_leaf_area")]),a.pc_StageMaxRootNConcentration.push(r[i.indexOf("stage_max_root_n_content")]),a.pc_StageKcFactor.push(r[i.indexOf("stage_kc_factor")])}a.resizeStageOrganVectors();for(var t=db.exec("SELECT crop_id, organ_id, dev_stage_id,     ods_dependent_param_id, value     FROM crop2ods_dependent_param     WHERE crop_id = "+e+"     ORDER BY crop_id, ods_dependent_param_id, dev_stage_id, organ_id"),i=t[0].columns,o=t[0].values,n=0,_=o.length;_>n;n++){var r=o[n],s=r[i.indexOf("ods_dependent_param_id")],l=r[i.indexOf("dev_stage_id")],d=r[i.indexOf("organ_id")],c=1===s?a.pc_AssimilatePartitioningCoeff:a.pc_OrganSenescenceRate;c[l-1][d-1]=r[i.indexOf("value")]}for(var t=db.exec("SELECT crop_id, organ_id, is_primary, percentage, dry_matter     FROM yield_parts     WHERE crop_id = "+e),i=t[0].columns,o=t[0].values,n=0,_=o.length;_>n;n++){var r=o[n],p=r[i.indexOf("organ_id")],f=r[i.indexOf("percentage")]/100,g=r[i.indexOf("dry_matter")];1==r[i.indexOf("is_primary")]?a.organIdsForPrimaryYield.push(new YieldComponent(p,f,g)):a.organIdsForSecondaryYield.push(new YieldComponent(p,f,g))}var t=db.exec("SELECT crop_id, organ_id, is_primary, percentage, dry_matter     FROM cutting_parts     WHERE crop_id = "+e);if(t.length>0)for(var i=t[0].columns,o=t[0].values,n=0,_=o.length;_>n;n++){var r=o[n],p=r[i.indexOf("organ_id")],f=r[i.indexOf("percentage")]/100,g=r[i.indexOf("dry_matter")];18===e?a.organIdsForPrimaryYield.push(new YieldComponent(p,f,g)):a.organIdsForCutting.push(new YieldComponent(p,f,g))}return a},getMineralFertiliserParameters=function(e){var a=db.exec("SELECT id, name, no3, nh4, carbamid     FROM mineral_fertilisers     WHERE id = "+e);if(1!=a[0].values.length)throw"mineral fertiliser id ("+e+") not available in table mineral_fertilisers";var t=a[0].columns,i=a[0].values[0],r=i[t.indexOf("name")],o=i[t.indexOf("carbamid")],n=i[t.indexOf("no3")],_=i[t.indexOf("nh4")];return new MineralFertiliserParameters(r,o,n,_)},getOrganicFertiliserParameters=function(e){var a=db.exec("SELECT om_type, dm, nh4_n, no3_n, nh2_n, k_slow, k_fast, part_s, part_f, cn_s, cn_f, smb_s, smb_f, id     FROM organic_fertiliser     WHERE id = "+e);if(1!=a[0].values.length)throw"organic fertiliser id ("+e+") not available in table organic_fertiliser";var t=a[0].columns,i=a[0].values[0],r=new OrganicMatterParameters;return r.name=i[t.indexOf("om_type")],r.vo_AOM_DryMatterContent=i[t.indexOf("dm")],r.vo_AOM_NH4Content=i[t.indexOf("nh4_n")],r.vo_AOM_NO3Content=i[t.indexOf("no3_n")],r.vo_AOM_CarbamidContent=i[t.indexOf("nh2_n")],r.vo_AOM_SlowDecCoeffStandard=i[t.indexOf("k_slow")],r.vo_AOM_FastDecCoeffStandard=i[t.indexOf("k_fast")],r.vo_PartAOM_to_AOM_Slow=i[t.indexOf("part_s")],r.vo_PartAOM_to_AOM_Fast=i[t.indexOf("part_f")],r.vo_CN_Ratio_AOM_Slow=i[t.indexOf("cn_s")],r.vo_CN_Ratio_AOM_Fast=i[t.indexOf("cn_f")],r.vo_PartAOM_Slow_to_SMB_Slow=i[t.indexOf("smb_s")],r.vo_PartAOM_Slow_to_SMB_Fast=i[t.indexOf("smb_f")],r},getResidueParameters=function(e){var a=db.exec("SELECT residue_type, dm, nh4, no3, nh2, k_slow, k_fast, part_s, part_f, cn_s, cn_f, smb_s, smb_f, crop_id     FROM residue_table     WHERE crop_id = "+e),t=a[0].columns,i=a[0].values[0],r=new OrganicMatterParameters;return i&&(r.name=i[t.indexOf("residue_type")],r.vo_AOM_DryMatterContent=i[t.indexOf("dm")],r.vo_AOM_NH4Content=i[t.indexOf("nh4")],r.vo_AOM_NO3Content=i[t.indexOf("no3")],r.vo_AOM_CarbamidContent=i[t.indexOf("nh2")],r.vo_AOM_SlowDecCoeffStandard=i[t.indexOf("k_slow")],r.vo_AOM_FastDecCoeffStandard=i[t.indexOf("k_fast")],r.vo_PartAOM_to_AOM_Slow=i[t.indexOf("part_s")],r.vo_PartAOM_to_AOM_Fast=i[t.indexOf("part_f")],r.vo_CN_Ratio_AOM_Slow=i[t.indexOf("cn_s")],r.vo_CN_Ratio_AOM_Fast=i[t.indexOf("cn_f")],r.vo_PartAOM_Slow_to_SMB_Slow=i[t.indexOf("smb_s")],r.vo_PartAOM_Slow_to_SMB_Fast=i[t.indexOf("smb_f")]),r},readCapillaryRiseRates=function(){for(var e=db.exec("SELECT soil_type, distance, capillary_rate FROM capillary_rise_rate"),a=e[0].columns,t=e[0].values,i=new CapillaryRiseRates,r=0,o=t.length;o>r;r++){var n=t[r],_=n[a.indexOf("soil_type")],s=n[a.indexOf("distance")],l=n[a.indexOf("capillary_rate")];i.addRate(_,s,l)}return i},readUserParameterFromDatabase=function(){for(var e=db.exec("SELECT name, value_hermes FROM user_parameter"),a=e[0].columns,t=e[0].values,i=new CentralParameterProvider,r=i.userCropParameters,o=i.userEnvironmentParameters,n=i.userSoilMoistureParameters,_=i.userSoilTemperatureParameters,s=i.userSoilTransportParameters,l=i.userSoilOrganicParameters,d=(i.userInitValues,0),c=t.length;c>d;d++){var p=t[d],f=p[a.indexOf("NAME")],g=p[a.indexOf("VALUE_HERMES")];"tortuosity"==f?r.pc_Tortuosity=g:"canopy_reflection_coefficient"==f?r.pc_CanopyReflectionCoefficient=g:"reference_max_assimilation_rate"==f?r.pc_ReferenceMaxAssimilationRate=g:"reference_leaf_area_index"==f?r.pc_ReferenceLeafAreaIndex=g:"maintenance_respiration_parameter_2"==f?r.pc_MaintenanceRespirationParameter2=g:"maintenance_respiration_parameter_1"==f?r.pc_MaintenanceRespirationParameter1=g:"minimum_n_concentration_root"==f?r.pc_MinimumNConcentrationRoot=g:"minimum_available_n"==f?r.pc_MinimumAvailableN=g:"reference_albedo"==f?r.pc_ReferenceAlbedo=g:"stomata_conductance_alpha"==f?r.pc_StomataConductanceAlpha=g:"saturation_beta"==f?r.pc_SaturationBeta=g:"growth_respiration_redux"==f?r.pc_GrowthRespirationRedux=g:"max_crop_n_demand"==f?r.pc_MaxCropNDemand=g:"growth_respiration_parameter_2"==f?r.pc_GrowthRespirationParameter2=g:"growth_respiration_parameter_1"==f?r.pc_GrowthRespirationParameter1=g:"use_automatic_irrigation"==f?o.p_UseAutomaticIrrigation=1==g:"use_nmin_mineral_fertilising_method"==f?o.p_UseNMinMineralFertilisingMethod=1==g:"layer_thickness"==f?o.p_LayerThickness=g:"number_of_layers"==f?o.p_NumberOfLayers=g:"start_pv_index"==f?o.p_StartPVIndex=g:"albedo"==f?o.p_Albedo=g:"athmospheric_co2"==f?o.p_AthmosphericCO2=g:"wind_speed_height"==f?o.p_WindSpeedHeight=g:"use_secondary_yields"==f?o.p_UseSecondaryYields=1==g:"julian_day_automatic_fertilising"==f?o.p_JulianDayAutomaticFertilising=g:"critical_moisture_depth"==f?n.pm_CriticalMoistureDepth=g:"saturated_hydraulic_conductivity"==f?n.pm_SaturatedHydraulicConductivity=g:"surface_roughness"==f?n.pm_SurfaceRoughness=g:"hydraulic_conductivity_redux"==f?n.pm_HydraulicConductivityRedux=g:"snow_accumulation_treshold_temperature"==f?n.pm_SnowAccumulationTresholdTemperature=g:"kc_factor"==f?n.pm_KcFactor=g:"time_step"==f?o.p_timeStep=g:"temperature_limit_for_liquid_water"==f?n.pm_TemperatureLimitForLiquidWater=g:"correction_snow"==f?n.pm_CorrectionSnow=g:"correction_rain"==f?n.pm_CorrectionRain=g:"snow_max_additional_density"==f?n.pm_SnowMaxAdditionalDensity=g:"new_snow_density_min"==f?n.pm_NewSnowDensityMin=g:"snow_retention_capacity_min"==f?n.pm_SnowRetentionCapacityMin=g:"refreeze_parameter_2"==f?n.pm_RefreezeParameter2=g:"refreeze_parameter_1"==f?n.pm_RefreezeParameter1=g:"refreeze_temperature"==f?n.pm_RefreezeTemperature=g:"snowmelt_temperature"==f?n.pm_SnowMeltTemperature=g:"snow_packing"==f?n.pm_SnowPacking=g:"snow_retention_capacity_max"==f?n.pm_SnowRetentionCapacityMax=g:"evaporation_zeta"==f?n.pm_EvaporationZeta=g:"xsa_critical_soil_moisture"==f?n.pm_XSACriticalSoilMoisture=g:"maximum_evaporation_impact_depth"==f?n.pm_MaximumEvaporationImpactDepth=g:"ntau"==f?_.pt_NTau=g:"initial_surface_temperature"==f?_.pt_InitialSurfaceTemperature=g:"base_temperature"==f?_.pt_BaseTemperature=g:"quartz_raw_density"==f?_.pt_QuartzRawDensity=g:"density_air"==f?_.pt_DensityAir=g:"density_water"==f?_.pt_DensityWater=g:"specific_heat_capacity_air"==f?_.pt_SpecificHeatCapacityAir=g:"specific_heat_capacity_quartz"==f?_.pt_SpecificHeatCapacityQuartz=g:"specific_heat_capacity_water"==f?_.pt_SpecificHeatCapacityWater=g:"soil_albedo"==f?_.pt_SoilAlbedo=g:"dispersion_length"==f?s.pq_DispersionLength=g:"AD"==f?s.pq_AD=g:"diffusion_coefficient_standard"==f?s.pq_DiffusionCoefficientStandard=g:"leaching_depth"==f?o.p_LeachingDepth=g:"groundwater_discharge"==f?n.pm_GroundwaterDischarge=g:"density_humus"==f?_.pt_DensityHumus=g:"specific_heat_capacity_humus"==f?_.pt_SpecificHeatCapacityHumus=g:"max_percolation_rate"==f?n.pm_MaxPercolationRate=g:"max_groundwater_depth"==f?o.p_MaxGroundwaterDepth=g:"min_groundwater_depth"==f?o.p_MinGroundwaterDepth=g:"min_groundwater_depth_month"==f?o.p_MinGroundwaterDepthMonth=g:"SOM_SlowDecCoeffStandard"==f?l.po_SOM_SlowDecCoeffStandard=g:"SOM_FastDecCoeffStandard"==f?l.po_SOM_FastDecCoeffStandard=g:"SMB_SlowMaintRateStandard"==f?l.po_SMB_SlowMaintRateStandard=g:"SMB_FastMaintRateStandard"==f?l.po_SMB_FastMaintRateStandard=g:"SMB_SlowDeathRateStandard"==f?l.po_SMB_SlowDeathRateStandard=g:"SMB_FastDeathRateStandard"==f?l.po_SMB_FastDeathRateStandard=g:"SMB_UtilizationEfficiency"==f?l.po_SMB_UtilizationEfficiency=g:"SOM_SlowUtilizationEfficiency"==f?l.po_SOM_SlowUtilizationEfficiency=g:"SOM_FastUtilizationEfficiency"==f?l.po_SOM_FastUtilizationEfficiency=g:"AOM_SlowUtilizationEfficiency"==f?l.po_AOM_SlowUtilizationEfficiency=g:"AOM_FastUtilizationEfficiency"==f?l.po_AOM_FastUtilizationEfficiency=g:"AOM_FastMaxC_to_N"==f?l.po_AOM_FastMaxC_to_N=g:"PartSOM_Fast_to_SOM_Slow"==f?l.po_PartSOM_Fast_to_SOM_Slow=g:"PartSMB_Slow_to_SOM_Fast"==f?l.po_PartSMB_Slow_to_SOM_Fast=g:"PartSMB_Fast_to_SOM_Fast"==f?l.po_PartSMB_Fast_to_SOM_Fast=g:"PartSOM_to_SMB_Slow"==f?l.po_PartSOM_to_SMB_Slow=g:"PartSOM_to_SMB_Fast"==f?l.po_PartSOM_to_SMB_Fast=g:"CN_Ratio_SMB"==f?l.po_CN_Ratio_SMB=g:"LimitClayEffect"==f?l.po_LimitClayEffect=g:"AmmoniaOxidationRateCoeffStandard"==f?l.po_AmmoniaOxidationRateCoeffStandard=g:"NitriteOxidationRateCoeffStandard"==f?l.po_NitriteOxidationRateCoeffStandard=g:"TransportRateCoeff"==f?l.po_TransportRateCoeff=g:"SpecAnaerobDenitrification"==f?l.po_SpecAnaerobDenitrification=g:"ImmobilisationRateCoeffNO3"==f?l.po_ImmobilisationRateCoeffNO3=g:"ImmobilisationRateCoeffNH4"==f?l.po_ImmobilisationRateCoeffNH4=g:"Denit1"==f?l.po_Denit1=g:"Denit2"==f?l.po_Denit2=g:"Denit3"==f?l.po_Denit3=g:"HydrolysisKM"==f?l.po_HydrolysisKM=g:"ActivationEnergy"==f?l.po_ActivationEnergy=g:"HydrolysisP1"==f?l.po_HydrolysisP1=g:"HydrolysisP2"==f?l.po_HydrolysisP2=g:"AtmosphericResistance"==f?l.po_AtmosphericResistance=g:"N2OProductionRate"==f?l.po_N2OProductionRate=g:"Inhibitor_NH3"==f&&(l.po_Inhibitor_NH3=g),i.capillaryRiseRates=readCapillaryRiseRates()}return i},soilCharacteristicsKA5=function(e){logger(MSG.INFO,"soilCharacteristicsKA5");var a=e.vs_SoilTexture,t=e.vs_SoilStoneContent,i=0,r=0,o=0;if(""!=a){var n=e.vs_SoilRawDensity()/1e3,_=100*e.vs_SoilOrganicMatter(),s=0,l=0;1.1>n?(s=1.1,l=1.1):n>=1.1&&1.3>n?(s=1.1,l=1.3):n>=1.3&&1.5>n?(s=1.3,l=1.5):n>=1.5&&1.7>n?(s=1.5,l=1.7):n>=1.7&&1.9>n?(s=1.7,l=1.9):n>=1.9&&(s=1.9,l=1.9),("Hh"==a||"Hn"==a)&&(s=-1,l=-1);var d=readPrincipalSoilCharacteristicData(a,s),c=d.sat,p=d.fc,f=d.pwp,g=readPrincipalSoilCharacteristicData(a,l),m=g.sat,u=g.fc,S=g.pwp;if(d.initialized&&g.initialized){var h=0,x=0;_>=0&&1>_?(h=0,x=0):_>=1&&1.5>_?(h=0,x=1.5):_>=1.5&&3>_?(h=1.5,x=3):_>=3&&6>_?(h=3,x=6):_>=6&&11.5>_?(h=6,x=11.5):_>=11.5&&(h=11.5,x=11.5),("Hh"==a||"Hn"==a)&&(h=0,x=0);var O=0,M=0,y=0;if(0!=h){var d=readSoilCharacteristicModifier(a,h);M=d.sat,O=d.fc,y=d.pwp}var v=0,C=0,N=0;if(0!=x){var g=readSoilCharacteristicModifier(a,x);C=g.sat,v=g.fc,N=g.pwp}var P=p;.5>u&&p>=1?P=p:.5>p&&u>=1?P=u:l!=s&&(P=(n-s)/(l-s)*(u-p)+p);var R=c;.5>m&&c>=1?R=c:.5>c&&m>=1?R=m:l!=s&&(R=(n-s)/(l-s)*(m-c)+c);var w=f;.5>S&&f>=1?w=f:.5>f&&S>=1?w=S:l!=s&&(w=(n-s)/(l-s)*(S-f)+f);var D=O,F=M,A=y;x!=h&&(D=(_-h)/(x-h)*(v-O)+O,F=(_-h)/(x-h)*(C-M)+M,A=(_-h)/(x-h)*(N-y)+y),i=(P+D)/100,r=(R+F)/100,o=(w+A)/100,i*=1-t,r*=1-t,o*=1-t}}e.vs_FieldCapacity=i,e.vs_Saturation=r,e.vs_PermanentWiltingPoint=o},readPrincipalSoilCharacteristicData=function(e,a){var t=db.exec("SELECT soil_type, soil_raw_density*10 AS soil_raw_density, air_capacity, field_capacity, n_field_capacity     FROM soil_characteristic_data     WHERE air_capacity != 0 AND field_capacity != 0 AND n_field_capacity != 0     ORDER BY soil_type, soil_raw_density");if(t[0].values.length<1)throw"soil_characteristic_data not available in monica.sqlite";for(var i=t[0].columns,r=t[0].values,o={},n=0,_=r.length;_>n;n++){var s=r[n];if(s[i.indexOf("soil_type")]===e){var l=s[i.indexOf("air_capacity")],d=s[i.indexOf("field_capacity")],c=s[i.indexOf("n_field_capacity")],p=new RPSCDRes(!0);p.sat=l+d,p.fc=d,p.pwp=d-c,void 0===o[e]&&(o[e]={}),o[e][int(s[i.indexOf("soil_raw_density")])]=p}}var f=int(10*a);if(o[e][f])return o[e][f];for(;!o[e][f]&&f>=11&&19>=f;)f+=15>f?1:-1;return o[e][f]?o[e][f]:new RPSCDRes},readSoilCharacteristicModifier=function(e,a){var t=db.exec("SELECT soil_type, organic_matter*10 AS organic_matter, air_capacity, field_capacity, n_field_capacity     FROM soil_aggregation_values     ORDER BY soil_type, organic_matter");if(t[0].values.length<1)throw"soil_aggregation_values not available in monica.sqlite";for(var i=t[0].columns,r=t[0].values,o={},n=0,_=r.length;_>n;n++){var s=r[n];if(s[i.indexOf("soil_type")]===e){var l=s[i.indexOf("air_capacity")],d=s[i.indexOf("field_capacity")],c=s[i.indexOf("n_field_capacity")],p=new RPSCDRes(!0);p.sat=l+d,p.fc=d,p.pwp=d-c,void 0===o[e]&&(o[e]={}),o[e][int(s[i.indexOf("organic_matter")])]=p}}var f=int(10*a);return o[e][f]?o[e][f]:new RPSCDRes},runMonica=function(e,a){var t={crops:[]};if(ResultId.forEach(function(e){-1===perCropResults.indexOf(e)&&(t[e]=[])}),0===e.cropRotation.length)return logger(MSG.ERROR,"rotation is empty"),t;logger(MSG.INFO,"starting monica");var i=null!=e.pathToOutputDir&&!!fs,r=e.pathToOutputDir+"/rmout.dat",o=e.pathToOutputDir+"/smout.dat",n=e.pathToOutputDir+"/monica_parameters.txt";i&&(initializeFoutHeader(r),initializeGoutHeader(o),dumpMonicaParametersIntoFile(n,e.centralParameterProvider));var _=new Model(e,e.da),s=e.da.startDate(),l=e.da.noOfStepsPossible(),d=s.getMonth(),c=0,p=0,f=0,g=0,m=0,u=0,S=0,h=0,x=0,O=0,M=0,y=0,v=e.cropRotation[y],C=!1,N=v.start(),P=C?N.toAbsoluteDate(s.year()+1):N;if(logger(MSG.INFO,"next app-date: "+N.toString()+" next abs app-date: "+P.toString()),!P.isValid())return logger(MSG.ERROR,"start of production-process: "+v.toString()+" is not valid"),t;for(var R=0;l>R;++R,s=new Date(s.getFullYear(),s.getMonth(),s.getDate()+1),++c){if(logger(MSG.INFO,"currentDate: "+s.getDate()+"."+(s.getMonth()+1)+"."+s.getFullYear()),_.resetDailyCounter(),_.cropGrowth()&&_.cropGrowth().isDying()&&_.incorporateCurrentCrop(),P.setHours(0,0,0,0)==s.setHours(0,0,0,0)){logger(MSG.INFO," applying at: "+N.toString()+" absolute-at: "+P.toString()),v.apply(N,_);var w=N;N=v.nextDate(N),P=C?N.toAbsoluteDate(s.year()+(N.dayOfYear()>w.dayOfYear()?0:1),!0):N,logger(MSG.INFO," next app-date: "+N.toString()+" next abs app-date: "+P.toString()),P.isValid()||(t.crops.push(v.cropResult()),_.resetFertiliserCounter(),v.crop().reset(),y++,y==e.cropRotation.length&&(y=0),v=e.cropRotation[y],N=v.start(),P=C?N.toAbsoluteDate(s.year()+(N.dayOfYear()>w.dayOfYear()?0:1),!0):N,logger(MSG.INFO," new valid next app-date: "+N.toString()+" next abs app-date: "+P.toString())),C&&s>P&&P.addYears(1)}i&&(fs.appendFileSync(o,s.toLocaleDateString(),{encoding:"utf8"}),fs.appendFileSync(r,s.toLocaleDateString(),{encoding:"utf8"})),_.isCropPlanted()&&_.cropStep(R),i&&writeCropResults(_.cropGrowth(),r,o,_.isCropPlanted()),a&&a(s,_),_.generalStep(R),31==s.getDate()&&3==s.getMonth()&&(t.sum90cmYearlyNatDay.push(fixed(10,_.sumNmin(.9))),t.sum30cmSoilTemperature.push(fixed(10,_.sumSoilTemperature(3))),t.sum90cmYearlyNO3AtDay.push(fixed(10,_.sumNO3AtDay(.9))),t.avg30cmSoilTemperature.push(fixed(10,_.avg30cmSoilTemperature())),t.avg0_30cmSoilMoisture.push(fixed(10,_.avgSoilMoisture(0,3))),t.avg30_60cmSoilMoisture.push(fixed(10,_.avgSoilMoisture(3,6))),t.avg60_90cmSoilMoisture.push(fixed(10,_.avgSoilMoisture(6,9))),t.waterFluxAtLowerBoundary.push(fixed(10,_.groundWaterRecharge())),t.avg0_30cmCapillaryRise.push(fixed(10,_.avgCapillaryRise(0,3))),t.avg30_60cmCapillaryRise.push(fixed(10,_.avgCapillaryRise(3,6))),t.avg60_90cmCapillaryRise.push(fixed(10,_.avgCapillaryRise(6,9))),t.avg0_30cmPercolationRate.push(fixed(10,_.avgPercolationRate(0,3))),t.avg30_60cmPercolationRate.push(fixed(10,_.avgPercolationRate(3,6))),t.avg60_90cmPercolationRate.push(fixed(10,_.avgPercolationRate(6,9))),t.evapotranspiration.push(fixed(10,_.getEvapotranspiration())),t.transpiration.push(fixed(10,_.getTranspiration())),t.evaporation.push(fixed(10,_.getEvaporation())),t.sum30cmSMB_CO2EvolutionRate.push(fixed(10,_.get_sum30cmSMB_CO2EvolutionRate())),t.NH3Volatilised.push(fixed(10,_.getNH3Volatilised())),t.sum30cmActDenitrificationRate.push(fixed(10,_.getsum30cmActDenitrificationRate())),t.leachingNAtBoundary.push(fixed(10,_.nLeaching()))),s.getMonth()!=d||R==l-1?(d=s.getMonth(),t.avg10cmMonthlyAvgCorg.push(fixed(10,p/c)),t.avg30cmMonthlyAvgCorg.push(fixed(10,f/c)),t.mean90cmMonthlyAvgWaterContent.push(fixed(10,_.mean90cmWaterContent())),t.monthlySumGroundWaterRecharge.push(fixed(10,m)),t.monthlySumNLeaching.push(fixed(10,u)),t.maxSnowDepth.push(fixed(10,_.maxSnowDepth())),t.sumSnowDepth.push(fixed(10,_.accumulatedSnowDepth())),t.sumFrostDepth.push(fixed(10,_.accumulatedFrostDepth())),t.sumSurfaceRunOff.push(fixed(10,_.sumSurfaceRunOff())),t.sumNH3Volatilised.push(fixed(10,_.getSumNH3Volatilised())),t.monthlySurfaceRunoff.push(fixed(10,x)),t.monthlyPrecip.push(fixed(10,O)),t.monthlyETa.push(fixed(10,M)),t.monthlySoilMoistureL0.push(fixed(10,100*_.avgSoilMoisture(0,1))),t.monthlySoilMoistureL1.push(fixed(10,100*_.avgSoilMoisture(1,2))),t.monthlySoilMoistureL2.push(fixed(10,100*_.avgSoilMoisture(2,3))),t.monthlySoilMoistureL3.push(fixed(10,100*_.avgSoilMoisture(3,4))),t.monthlySoilMoistureL4.push(fixed(10,100*_.avgSoilMoisture(4,5))),t.monthlySoilMoistureL5.push(fixed(10,100*_.avgSoilMoisture(5,6))),t.monthlySoilMoistureL6.push(fixed(10,100*_.avgSoilMoisture(6,7))),t.monthlySoilMoistureL7.push(fixed(10,100*_.avgSoilMoisture(7,8))),t.monthlySoilMoistureL8.push(fixed(10,100*_.avgSoilMoisture(8,9))),t.monthlySoilMoistureL9.push(fixed(10,100*_.avgSoilMoisture(9,10))),t.monthlySoilMoistureL10.push(fixed(10,100*_.avgSoilMoisture(10,11))),t.monthlySoilMoistureL11.push(fixed(10,100*_.avgSoilMoisture(11,12))),t.monthlySoilMoistureL12.push(fixed(10,100*_.avgSoilMoisture(12,13))),t.monthlySoilMoistureL13.push(fixed(10,100*_.avgSoilMoisture(13,14))),t.monthlySoilMoistureL14.push(fixed(10,100*_.avgSoilMoisture(14,15))),t.monthlySoilMoistureL15.push(fixed(10,100*_.avgSoilMoisture(15,16))),t.monthlySoilMoistureL16.push(fixed(10,100*_.avgSoilMoisture(16,17))),t.monthlySoilMoistureL17.push(fixed(10,100*_.avgSoilMoisture(17,18))),t.monthlySoilMoistureL18.push(fixed(10,100*_.avgSoilMoisture(18,19))),p=f=g=m=u=x=0,O=0,M=0,c=0,logger(MSG.INFO,"stored monthly values for month: "+d)):(p+=_.avgCorg(.1),f+=_.avgCorg(.3),g+=_.mean90cmWaterContent(),m+=_.groundWaterRecharge(),u+=_.nLeaching(),x+=_.surfaceRunoff(),O+=e.da.dataForTimestep(Climate.precip,R),M+=_.getETa()),s.getFullYear()!=new Date(s.getFullYear(),s.getMonth(),s.getDate()-1).getFullYear()&&s.getFullYear()!=e.da.startDate().getFullYear()?(t.yearlySumGroundWaterRecharge.push(S),t.yearlySumNLeaching.push(h),S=0,h=0):(S+=_.groundWaterRecharge(),h+=_.nLeaching()),t.dev_stage.push(_.isCropPlanted()?_.cropGrowth().get_DevelopmentalStage()+1:0),i&&writeGeneralResults(r,o,e,_,R)}return logger(MSG.INFO,"returning from runMonica"),a&&a(null,null),t},initializeFoutHeader=function(e){var a=20,t="",i="\n";t+="Datum     ",t+="	Crop",t+="	TraDef",t+="	Tra",t+="	NDef",t+="	HeatRed",t+="	OxRed",t+="	Stage",t+="	TempSum",t+="	VernF",t+="	DaylF",t+="	IncRoot",t+="	IncLeaf",t+="	IncShoot",t+="	IncFruit",t+="	RelDev",t+="	AbBiom",t+="	Root",t+="	Leaf",t+="	Shoot",t+="	Fruit",t+="	Struct",t+="	Sugar",t+="	Yield",t+="	SumYield",t+="	GroPhot",t+="	NetPhot",t+="	MaintR",t+="	GrowthR",t+="	StomRes",t+="	Height",t+="	LAI",t+="	RootDep",t+="	EffRootDep",t+="	NBiom",t+="	SumNUp",t+="	ActNup",t+="	PotNup",t+="	NFixed",t+="	Target",t+="	CritN",t+="	AbBiomN",t+="	YieldN",t+="	Protein",t+="	NPP",t+="	NPPRoot",t+="	NPPLeaf",t+="	NPPShoot",t+="	NPPFruit",t+="	NPPStruct",t+="	NPPSugar",t+="	GPP",t+="	Ra",t+="	RaRoot",t+="	RaLeaf",t+="	RaShoot",t+="	RaFruit",t+="	RaStruct",t+="	RaSugar";for(var r=0;a>r;r++)t+="	Mois"+r;t+="	Precip",t+="	Irrig",t+="	Infilt",t+="	Surface",t+="	RunOff",t+="	SnowD",t+="	FrostD",t+="	ThawD";for(var r=0;a>r;r++)t+="	PASW-"+r;t+="	SurfTemp",t+="	STemp0",t+="	STemp1",t+="	STemp2",t+="	STemp3",t+="	STemp4",t+="	act_Ev",t+="	act_ET",t+="	ET0",t+="	Kc",t+="	atmCO2",t+="	Groundw",t+="	Recharge",t+="	NLeach";for(var r=0;a>r;r++)t+="	NO3-"+r;t+="	Carb";for(var r=0;a>r;r++)t+="	NH4-"+r;for(var r=0;4>r;r++)t+="	NO2-"+r;for(var r=0;6>r;r++)t+="	SOC-"+r;t+="	SOC-0-30",t+="	SOC-0-200";for(var r=0;1>r;r++)t+="	AOMf-"+r;for(var r=0;1>r;r++)t+="	AOMs-"+r;for(var r=0;1>r;r++)t+="	SMBf-"+r;for(var r=0;1>r;r++)t+="	SMBs-"+r;for(var r=0;1>r;r++)t+="	SOMf-"+r;for(var r=0;1>r;r++)t+="	SOMs-"+r;for(var r=0;1>r;r++)t+="	CBal-"+r;for(var r=0;3>r;r++)t+="	Nmin-"+r;t+="	NetNmin",t+="	Denit",t+="	N2O",t+="	SoilpH",t+="	NEP",t+="	NEE",t+="	Rh",t+="	tmin",t+="	tavg",t+="	tmax",t+="	wind",t+="	globrad",t+="	relhumid",t+="	sunhours",t+=i,t+="TTMMYYY",t+="	[ ]",t+="	[0;1]",t+="	[mm]",t+="	[0;1]",t+="	[0;1]",t+="	[0;1]",t+="	[ ]",t+="	[°Cd]",t+="	[0;1]",t+="	[0;1]",t+="	[kg/ha]",t+="	[kg/ha]",t+="	[kg/ha]",t+="	[kg/ha]",t+="	[0;1]",t+="	[kg/ha]";for(var o=0;6>o;o++)t+="	[kgDM/ha]";t+="	[kgDM/ha]",t+="	[kgDM/ha]",t+="	[kgCH2O/ha]",t+="	[kgCH2O/ha]",t+="	[kgCH2O/ha]",t+="	[kgCH2O/ha]",t+="	[s/m]",t+="	[m]",t+="	[m2/m2]",t+="	[layer]",t+="	[m]",t+="	[kgN/ha]",t+="	[kgN/ha]",t+="	[kgN/ha]",t+="	[kgN/ha]",t+="	[kgN/ha]",t+="	[kgN/kg]",t+="	[kgN/kg]",t+="	[kgN/kg]",t+="	[kgN/kg]",t+="	[kg/kg]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]",t+="	[kg C ha-1]";for(var r=0;a>r;r++)t+="	[m3/m3]";t+="	[mm]",t+="	[mm]",t+="	[mm]",t+="	[mm]",t+="	[mm]",t+="	[mm]",t+="	[m]",t+="	[m]";for(var r=0;a>r;r++)t+="	[m3/m3]";t+="	[°C]",t+="	[°C]",t+="	[°C]",t+="	[°C]",t+="	[°C]",t+="	[°C]",t+="	[mm]",t+="	[mm]",t+="	[mm]",t+="	[ ]",t+="	[ppm]",t+="	[m]",t+="	[mm]",t+="	[kgN/ha]";for(var r=0;a>r;r++)t+="	[kgN/m3]";t+="	[kgN/m3]";for(var r=0;a>r;r++)t+="	[kgN/m3]";for(var r=0;4>r;r++)t+="	[kgN/m3]";for(var r=0;6>r;r++)t+="	[kgC/kg]";t+="	[gC m-2]",t+="	[gC m-2]";for(var r=0;1>r;r++)t+="	[kgC/m3]";for(var r=0;1>r;r++)t+="	[kgC/m3]";for(var r=0;1>r;r++)t+="	[kgC/m3]";for(var r=0;1>r;r++)t+="	[kgC/m3]";for(var r=0;1>r;r++)t+="	[kgC/m3]";for(var r=0;1>r;r++)t+="	[kgC/m3]";for(var r=0;1>r;r++)t+="	[kgC/m3]";for(var r=0;3>r;r++)t+="	[kgN/ha]";t+="	[kgN/ha]",t+="	[kgN/ha]",t+="	[kgN/ha]",t+="	[ ]",t+="	[kgC/ha]",t+="	[kgC/ha]",t+="	[kgC/ha]",t+="	[°C]",t+="	[°C]",t+="	[°C]",t+="	[m/s]",t+="	globrad",t+="	[m3/m3]",t+="	[h]",t+=i,fs.writeFileSync(e,t,{encoding:"utf8"})},initializeGoutHeader=function(e){var a="",t="\n";a+="Datum     ",a+="	Crop",a+="	Stage",a+="	Height",a+="	Root",a+="	Root10",a+="	Leaf",a+="	Shoot",a+="	Fruit",a+="	AbBiom",a+="	AbGBiom",a+="	Yield",a+="	EarNo",a+="	GrainNo",a+="	LAI",a+="	AbBiomNc",a+="	YieldNc",a+="	AbBiomN",a+="	YieldN",a+="	TotNup",a+="	NGrain",a+="	Protein",a+="	BedGrad",a+="	M0-10",a+="	M10-20",a+="	M20-30",a+="	M30-40",a+="	M40-50",a+="	M50-60",a+="	M60-70",a+="	M70-80",a+="	M80-90",a+="	M0-30",a+="	M30-60",a+="	M60-90",a+="	M0-60",a+="	M0-90",a+="	PAW0-200",a+="	PAW0-130",a+="	PAW0-150",a+="	N0-30",a+="	N30-60",a+="	N60-90",a+="	N90-120",a+="	N0-60",a+="	N0-90",a+="	N0-200",a+="	N0-130",a+="	N0-150",a+="	NH430",a+="	NH460",a+="	NH490",a+="	Co0-10",a+="	Co0-30",a+="	T0-10",a+="	T20-30",a+="	T50-60",a+="	CO2",a+="	NH3",a+="	N2O",a+="	N2",a+="	Ngas",a+="	NFert",a+="	Irrig",a+=t,a+="TTMMYYYY",a+="	[ ]",a+="	[ ]",a+="	[m]",a+="	[kgDM/ha]",a+="	[kgDM/ha]",a+="	[kgDM/ha]",a+="	[kgDM/ha]",a+="	[kgDM/ha]",a+="	[kgDM/ha]",a+="	[kgDM/ha]",a+="	[kgDM/ha]",a+="	[ ]",a+="	[ ]",a+="	[m2/m2]",a+="	[kgN/kgDM",a+="	[kgN/kgDM]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[-]",a+="	[kg/kgDM]",a+="	[0;1]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[m3/m3]",a+="	[mm]",a+="	[mm]",a+="	[mm]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgN/ha]",a+="	[kgC/ha]",a+="	[kgC/ha]",a+="	[°C]",a+="	[°C]",a+="	[°C]",a+="	[kgC/ha]",a+="	[kgN/ha]",a+="	[-]",a+="	[-]",a+="	[-]",a+="	[kgN/ha]",a+="	[mm]",a+=t,fs.writeFileSync(e,a,{encoding:"utf8"})},writeCropResults=function(e,a,t,i){var r="",o="";if(i){r+="	"+e.get_CropName(),r+="	"+fixed(10,e.get_TranspirationDeficit()),r+="	"+fixed(10,e.get_ActualTranspiration()),r+="	"+fixed(10,e.get_CropNRedux()),r+="	"+fixed(10,e.get_HeatStressRedux()),r+="	"+fixed(10,e.get_OxygenDeficit()),r+="	"+fixed(10,e.get_DevelopmentalStage()+1),r+="	"+fixed(10,e.get_CurrentTemperatureSum()),r+="	"+fixed(10,e.get_VernalisationFactor()),r+="	"+fixed(10,e.get_DaylengthFactor()),r+="	"+fixed(10,e.get_OrganGrowthIncrement(0)),r+="	"+fixed(10,e.get_OrganGrowthIncrement(1)),r+="	"+fixed(10,e.get_OrganGrowthIncrement(2)),r+="	"+fixed(10,e.get_OrganGrowthIncrement(3)),r+="	"+fixed(10,e.get_RelativeTotalDevelopment()),r+="	"+fixed(10,e.get_AbovegroundBiomass());for(var n=0,_=e.get_NumberOfOrgans();_>n;n++)r+="	"+fixed(10,e.get_OrganBiomass(n));for(var n=0,_=6-e.get_NumberOfOrgans();_>n;n++)r+="	0";r+="	"+fixed(10,e.get_PrimaryCropYield()),r+="	0",r+="	"+fixed(10,e.get_GrossPhotosynthesisHaRate()),r+="	"+fixed(10,e.get_NetPhotosynthesis()),r+="	"+fixed(10,e.get_MaintenanceRespirationAS()),r+="	"+fixed(10,e.get_GrowthRespirationAS()),r+="	"+fixed(10,e.get_StomataResistance()),r+="	"+fixed(10,e.get_CropHeight()),r+="	"+fixed(10,e.get_LeafAreaIndex()),r+="	"+fixed(10,e.get_RootingDepth()),r+="	"+fixed(10,e.getEffectiveRootingDepth()),r+="	"+fixed(10,e.get_TotalBiomassNContent()),r+="	"+fixed(10,e.get_SumTotalNUptake()),r+="	"+fixed(10,e.get_ActNUptake()),r+="	"+fixed(10,e.get_PotNUptake()),r+="	0",r+="	"+fixed(10,e.get_TargetNConcentration()),r+="	"+fixed(10,e.get_CriticalNConcentration()),r+="	"+fixed(10,e.get_AbovegroundBiomassNConcentration()),r+="	"+fixed(10,e.get_PrimaryYieldNConcentration()),r+="	"+fixed(10,e.get_RawProteinConcentration()),r+="	"+fixed(10,e.get_NetPrimaryProduction());
for(var n=0;n<e.get_NumberOfOrgans();n++)r+="	"+fixed(10,e.get_OrganSpecificNPP(n));for(var n=e.get_NumberOfOrgans();6>n;n++)r+="	0.0";r+="	"+fixed(10,e.get_GrossPrimaryProduction()),r+="	"+fixed(10,e.get_AutotrophicRespiration());for(var n=0;n<e.get_NumberOfOrgans();n++)r+="	"+fixed(10,e.get_OrganSpecificTotalRespired(n));for(var n=e.get_NumberOfOrgans();6>n;n++)r+="	0.0";o+="	"+e.get_CropName(),o+="	"+fixed(10,e.get_DevelopmentalStage()+1),o+="	"+fixed(10,e.get_CropHeight()),o+="	"+fixed(10,e.get_OrganBiomass(0)),o+="	"+fixed(10,e.get_OrganBiomass(0)),o+="	"+fixed(10,e.get_OrganBiomass(1)),o+="	"+fixed(10,e.get_OrganBiomass(2)),o+="	"+fixed(10,e.get_OrganBiomass(3)),o+="	"+fixed(10,e.get_AbovegroundBiomass()),o+="	"+fixed(10,e.get_AbovegroundBiomass()),o+="	"+fixed(10,e.get_PrimaryCropYield()),o+="	0",o+="	0",o+="	"+fixed(10,e.get_LeafAreaIndex()),o+="	"+fixed(10,e.get_AbovegroundBiomassNConcentration()),o+="	"+fixed(10,e.get_PrimaryYieldNConcentration()),o+="	"+fixed(10,e.get_AbovegroundBiomassNContent()),o+="	"+fixed(10,e.get_PrimaryYieldNContent()),o+="	"+fixed(10,e.get_TotalBiomassNContent()),o+="	0",o+="	"+fixed(10,e.get_RawProteinConcentration())}else r+="	",r+="	1.00",r+="	0.00",r+="	1.00",r+="	1.00",r+="	1.00",r+="	0",r+="	0.0",r+="	0.00",r+="	0.00",r+="	0.00",r+="	0.00",r+="	0.00",r+="	0.00",r+="	0.00",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.000",r+="	0.00",r+="	0.000",r+="	0.000",r+="	0.00",r+="	0.00",r+="	0.00",r+="	0",r+="	0.0",r+="	0.0",r+="	0.00",r+="	0.00",r+="	0.00",r+="	0.00",r+="	0.000",r+="	0.000",r+="	0.000",r+="	0.000",r+="	0.000",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",r+="	0.0",o+="	",o+="	0",o+="	0.00",o+="	0.0",o+="	0.0",o+="	0.0",o+="	0.0",o+="	0.0",o+="	0.0",o+="	0.0",o+="	0.0",o+="	0",o+="	0",o+="	0.00",o+="	0.000",o+="	0.0",o+="	0.00",o+="	0.0",o+="	0.0",o+="	0",o+="	0.00";fs.appendFileSync(t,o,{encoding:"utf8"}),fs.appendFileSync(a,r,{encoding:"utf8"})},writeGeneralResults=function(e,a,t,i,r){for(var o="",n="",_="\n",s=i.soilTemperature(),l=i.soilMoisture(),d=i.soilOrganic(),c=i.soilColumn(),p=i.soilColumnNC(),f=i.soilTransport(),g=20,m=0;g>m;m++)o+="	"+fixed(10,l.get_SoilMoisture(m));o+="	"+fixed(10,t.da.dataForTimestep(Climate.precip,r)),o+="	"+fixed(10,i.dailySumIrrigationWater()),o+="	"+fixed(10,l.get_Infiltration()),o+="	"+fixed(10,l.get_SurfaceWaterStorage()),o+="	"+fixed(10,l.get_SurfaceRunOff()),o+="	"+fixed(10,l.get_SnowDepth()),o+="	"+fixed(10,l.get_FrostDepth()),o+="	"+fixed(10,l.get_ThawDepth());for(var m=0;g>m;m++)o+="	"+fixed(10,l.get_SoilMoisture(m)-p[m].get_PermanentWiltingPoint());o+="	"+fixed(10,s.get_SoilSurfaceTemperature());for(var m=0;5>m;m++)o+="	"+fixed(10,s.get_SoilTemperature(m));o+="	"+fixed(10,l.get_ActualEvaporation()),o+="	"+fixed(10,l.get_Evapotranspiration()),o+="	"+fixed(10,l.get_ET0()),o+="	"+fixed(10,l.get_KcFactor()),o+="	"+fixed(10,i.get_AtmosphericCO2Concentration()),o+="	"+fixed(10,i.get_GroundwaterDepth()),o+="	"+fixed(10,l.get_GroundwaterRecharge()),o+="	"+fixed(10,f.get_NLeaching());for(var m=0;g>m;m++)o+="	"+fixed(10,c.soilLayer(m).get_SoilNO3());o+="	"+fixed(10,c.soilLayer(0).get_SoilCarbamid());for(var m=0;g>m;m++)o+="	"+fixed(10,c.soilLayer(m).get_SoilNH4());for(var m=0;4>m;m++)o+="	"+fixed(10,c.soilLayer(m).get_SoilNO2());for(var m=0;6>m;m++)o+="	"+fixed(10,c.soilLayer(m).vs_SoilOrganicCarbon());for(var u=0,m=0;3>m;m++)u+=c.soilLayer(m).vs_SoilOrganicCarbon()*c.soilLayer(m).vs_SoilBulkDensity()*c.soilLayer(m).vs_LayerThickness*1e3;o+="	"+fixed(10,u);for(var S=0,m=0;g>m;m++)S+=c.soilLayer(m).vs_SoilOrganicCarbon()*c.soilLayer(m).vs_SoilBulkDensity()*c.soilLayer(m).vs_LayerThickness*1e3;o+="	"+fixed(10,S);for(var m=0;1>m;m++)o+="	"+fixed(10,d.get_AOM_FastSum(m));for(var m=0;1>m;m++)o+="	"+fixed(10,d.get_AOM_SlowSum(m));for(var m=0;1>m;m++)o+="	"+fixed(10,d.get_SMB_Fast(m));for(var m=0;1>m;m++)o+="	"+fixed(10,d.get_SMB_Slow(m));for(var m=0;1>m;m++)o+="	"+fixed(10,d.get_SOM_Fast(m));for(var m=0;1>m;m++)o+="	"+fixed(10,d.get_SOM_Slow(m));for(var m=0;1>m;m++)o+="	"+fixed(10,d.get_CBalance(m));for(var m=0;3>m;m++)o+="	"+fixed(10,d.get_NetNMineralisationRate(m));o+="	"+fixed(10,d.get_NetNMineralisation()),o+="	"+fixed(10,d.get_Denitrification()),o+="	"+fixed(10,d.get_N2O_Produced()),o+="	"+fixed(10,c.soilLayer(0).get_SoilpH()),o+="	"+fixed(10,d.get_NetEcosystemProduction()),o+="	"+fixed(10,d.get_NetEcosystemExchange()),o+="	"+fixed(10,d.get_DecomposerRespiration()),o+="	"+fixed(10,t.da.dataForTimestep(Climate.tmin,r)),o+="	"+fixed(10,t.da.dataForTimestep(Climate.tavg,r)),o+="	"+fixed(10,t.da.dataForTimestep(Climate.tmax,r)),o+="	"+fixed(10,t.da.dataForTimestep(Climate.wind,r)),o+="	"+fixed(10,t.da.dataForTimestep(Climate.globrad,r)),o+="	"+fixed(10,t.da.dataForTimestep(Climate.relhumid,r)),o+="	"+fixed(10,t.da.dataForTimestep(Climate.sunhours,r)),o+=_,n+="	"+fixed(10,l.get_PercentageSoilCoverage());for(var m=0;9>m;m++)n+="	"+fixed(10,l.get_SoilMoisture(m));n+="	"+fixed(10,(l.get_SoilMoisture(0)+l.get_SoilMoisture(1)+l.get_SoilMoisture(2))/3),n+="	"+fixed(10,(l.get_SoilMoisture(3)+l.get_SoilMoisture(4)+l.get_SoilMoisture(5))/3),n+="	"+fixed(10,(l.get_SoilMoisture(6)+l.get_SoilMoisture(7)+l.get_SoilMoisture(8))/3);for(var h=0,m=0;6>m;m++)h+=l.get_SoilMoisture(m);n+="	"+fixed(10,h/6);for(var x=0,m=0;9>m;m++)x+=l.get_SoilMoisture(m);n+="	"+fixed(10,x/9);for(var O=0,m=0;20>m;m++)O+=l.get_SoilMoisture(m)-p[m].get_PermanentWiltingPoint();n+="	"+fixed(10,.1*O*1e3);for(var M=0,m=0;13>m;m++)M+=l.get_SoilMoisture(m)-p[m].get_PermanentWiltingPoint();n+="	"+fixed(10,.1*M*1e3);for(var y=0,m=0;15>m;m++)y+=l.get_SoilMoisture(m)-p[m].get_PermanentWiltingPoint();n+="	"+fixed(10,.1*y*1e3),n+="	"+fixed(10,(c.soilLayer(0).get_SoilNmin()+c.soilLayer(1).get_SoilNmin()+c.soilLayer(2).get_SoilNmin())/3*.3*1e4),n+="	"+fixed(10,(c.soilLayer(3).get_SoilNmin()+c.soilLayer(4).get_SoilNmin()+c.soilLayer(5).get_SoilNmin())/3*.3*1e4),n+="	"+fixed(10,(c.soilLayer(6).get_SoilNmin()+c.soilLayer(7).get_SoilNmin()+c.soilLayer(8).get_SoilNmin())/3*.3*1e4),n+="	"+fixed(10,(c.soilLayer(9).get_SoilNmin()+c.soilLayer(10).get_SoilNmin()+c.soilLayer(11).get_SoilNmin())/3*.3*1e4);for(var v=0,m=0;6>m;m++)v+=c.soilLayer(m).get_SoilNmin();n+="	"+fixed(10,.1*v*1e4);for(var C=0,m=0;9>m;m++)C+=c.soilLayer(m).get_SoilNmin();n+="	"+fixed(10,.1*C*1e4);for(var N=0,m=0;20>m;m++)N+=c.soilLayer(m).get_SoilNmin();n+="	"+fixed(10,.1*N*1e4);for(var P=0,m=0;13>m;m++)P+=c.soilLayer(m).get_SoilNmin();n+="	"+fixed(10,.1*P*1e4);for(var R=0,m=0;15>m;m++)R+=c.soilLayer(m).get_SoilNmin();n+="	"+fixed(10,.1*R*1e4),n+="	"+fixed(10,(c.soilLayer(0).get_SoilNH4()+c.soilLayer(1).get_SoilNH4()+c.soilLayer(2).get_SoilNH4())/3*.3*1e4),n+="	"+fixed(10,(c.soilLayer(3).get_SoilNH4()+c.soilLayer(4).get_SoilNH4()+c.soilLayer(5).get_SoilNH4())/3*.3*1e4),n+="	"+fixed(10,(c.soilLayer(6).get_SoilNH4()+c.soilLayer(7).get_SoilNH4()+c.soilLayer(8).get_SoilNH4())/3*.3*1e4),n+="	"+fixed(10,.1*d.get_SoilOrganicC(0)*1e4),n+="	"+fixed(10,(d.get_SoilOrganicC(0)+d.get_SoilOrganicC(1)+d.get_SoilOrganicC(2))/3*.3*1e4),n+="	"+fixed(10,s.get_SoilTemperature(0)),n+="	"+fixed(10,s.get_SoilTemperature(2)),n+="	"+fixed(10,s.get_SoilTemperature(5)),n+="	"+fixed(10,d.get_DecomposerRespiration()),n+="	"+fixed(10,d.get_NH3_Volatilised()),n+="	0",n+="	0",n+="	0",n+="	"+fixed(10,i.dailySumFertiliser()),n+="	"+fixed(10,i.dailySumIrrigationWater()),n+=_,fs.appendFileSync(a,n,{encoding:"utf8"}),fs.appendFileSync(e,o,{encoding:"utf8"})},dumpMonicaParametersIntoFile=function(e,a){var t="",i="\n";t+="userSoilOrganicParameters	po_SOM_SlowDecCoeffStandard	"+a.userSoilOrganicParameters.po_SOM_SlowDecCoeffStandard+i,t+="userSoilOrganicParameters	po_SOM_FastDecCoeffStandard	"+a.userSoilOrganicParameters.po_SOM_FastDecCoeffStandard+i,t+="userSoilOrganicParameters	po_SMB_SlowMaintRateStandard	"+a.userSoilOrganicParameters.po_SMB_SlowMaintRateStandard+i,t+="userSoilOrganicParameters	po_SMB_FastMaintRateStandard	"+a.userSoilOrganicParameters.po_SMB_FastMaintRateStandard+i,t+="userSoilOrganicParameters	po_SMB_SlowDeathRateStandard	"+a.userSoilOrganicParameters.po_SMB_SlowDeathRateStandard+i,t+="userSoilOrganicParameters	po_SMB_FastDeathRateStandard	"+a.userSoilOrganicParameters.po_SMB_FastDeathRateStandard+i,t+="userSoilOrganicParameters	po_SMB_UtilizationEfficiency	"+a.userSoilOrganicParameters.po_SMB_UtilizationEfficiency+i,t+="userSoilOrganicParameters	po_SOM_SlowUtilizationEfficiency	"+a.userSoilOrganicParameters.po_SOM_SlowUtilizationEfficiency+i,t+="userSoilOrganicParameters	po_SOM_FastUtilizationEfficiency	"+a.userSoilOrganicParameters.po_SOM_FastUtilizationEfficiency+i,t+="userSoilOrganicParameters	po_AOM_SlowUtilizationEfficiency	"+a.userSoilOrganicParameters.po_AOM_SlowUtilizationEfficiency+i,t+="userSoilOrganicParameters	po_AOM_FastUtilizationEfficiency	"+a.userSoilOrganicParameters.po_AOM_FastUtilizationEfficiency+i,t+="userSoilOrganicParameters	po_AOM_FastMaxC_to_N	"+a.userSoilOrganicParameters.po_AOM_FastMaxC_to_N+i,t+="userSoilOrganicParameters	po_PartSOM_Fast_to_SOM_Slow	"+a.userSoilOrganicParameters.po_PartSOM_Fast_to_SOM_Slow+i,t+="userSoilOrganicParameters	po_PartSMB_Slow_to_SOM_Fast	"+a.userSoilOrganicParameters.po_PartSMB_Slow_to_SOM_Fast+i,t+="userSoilOrganicParameters	po_PartSMB_Fast_to_SOM_Fast	"+a.userSoilOrganicParameters.po_PartSMB_Fast_to_SOM_Fast+i,t+="userSoilOrganicParameters	po_PartSOM_to_SMB_Slow	"+a.userSoilOrganicParameters.po_PartSOM_to_SMB_Slow+i,t+="userSoilOrganicParameters	po_PartSOM_to_SMB_Fast	"+a.userSoilOrganicParameters.po_PartSOM_to_SMB_Fast+i,t+="userSoilOrganicParameters	po_CN_Ratio_SMB	"+a.userSoilOrganicParameters.po_CN_Ratio_SMB+i,t+="userSoilOrganicParameters	po_LimitClayEffect	"+a.userSoilOrganicParameters.po_LimitClayEffect+i,t+="userSoilOrganicParameters	po_AmmoniaOxidationRateCoeffStandard	"+a.userSoilOrganicParameters.po_AmmoniaOxidationRateCoeffStandard+i,t+="userSoilOrganicParameters	po_NitriteOxidationRateCoeffStandard	"+a.userSoilOrganicParameters.po_NitriteOxidationRateCoeffStandard+i,t+="userSoilOrganicParameters	po_TransportRateCoeff	"+a.userSoilOrganicParameters.po_TransportRateCoeff+i,t+="userSoilOrganicParameters	po_SpecAnaerobDenitrification	"+a.userSoilOrganicParameters.po_SpecAnaerobDenitrification+i,t+="userSoilOrganicParameters	po_ImmobilisationRateCoeffNO3	"+a.userSoilOrganicParameters.po_ImmobilisationRateCoeffNO3+i,t+="userSoilOrganicParameters	po_ImmobilisationRateCoeffNH4	"+a.userSoilOrganicParameters.po_ImmobilisationRateCoeffNH4+i,t+="userSoilOrganicParameters	po_Denit1	"+a.userSoilOrganicParameters.po_Denit1+i,t+="userSoilOrganicParameters	po_Denit2	"+a.userSoilOrganicParameters.po_Denit2+i,t+="userSoilOrganicParameters	po_Denit3	"+a.userSoilOrganicParameters.po_Denit3+i,t+="userSoilOrganicParameters	po_HydrolysisKM	"+a.userSoilOrganicParameters.po_HydrolysisKM+i,t+="userSoilOrganicParameters	po_ActivationEnergy	"+a.userSoilOrganicParameters.po_ActivationEnergy+i,t+="userSoilOrganicParameters	po_HydrolysisP1	"+a.userSoilOrganicParameters.po_HydrolysisP1+i,t+="userSoilOrganicParameters	po_HydrolysisP2	"+a.userSoilOrganicParameters.po_HydrolysisP2+i,t+="userSoilOrganicParameters	po_AtmosphericResistance	"+a.userSoilOrganicParameters.po_AtmosphericResistance+i,t+="userSoilOrganicParameters	po_N2OProductionRate	"+a.userSoilOrganicParameters.po_N2OProductionRate+i,t+="userSoilOrganicParameters	po_Inhibitor_NH3	"+a.userSoilOrganicParameters.po_Inhibitor_NH3+i,t+=i,fs.writeFileSync(e,t,{encoding:"utf8"})};

var SoilLayer=function(t,i,n){DEBUG&&debug(arguments);var s=this;if(0===arguments.length){this.vs_SoilSandContent=.9,this.vs_SoilClayContent=.05,this.vs_SoilStoneContent=0,this.vs_SoilTexture="Ss",this.vs_SoilpH=7,this.vs_SoilMoistureOld_m3=.25,this.vs_SoilWaterFlux=0,this.vs_Lambda=.5,this.vs_FieldCapacity=.21,this.vs_Saturation=.43,this.vs_PermanentWiltingPoint=.08,this.vs_SOM_Slow=0,this.vs_SOM_Fast=0,this.vs_SMB_Slow=0,this.vs_SMB_Fast=0,this.vs_SoilCarbamid=0,this.vs_SoilNH4=1e-4,this.vs_SoilNO2=.001,this.vs_SoilNO3=.001,this.vs_SoilFrozen=!1;var o=-1,e=-1,_=0,l=-1,a=.25,S=0;this.vo_AOM_Pool=[];var v=new CentralParameterProvider;this.vs_SoilMoisture_m3=this.vs_FieldCapacity*v.userInitValues.p_initPercentageFC,this.vs_SoilMoistureOld_m3=this.vs_FieldCapacity*v.userInitValues.p_initPercentageFC,this.vs_SoilNO3=v.userInitValues.p_initSoilNitrate,this.vs_SoilNH4=v.userInitValues.p_initSoilAmmonium}else{if(3!==arguments.length||!(arguments[2]instanceof CentralParameterProvider))throw arguments;this.vs_LayerThickness=t,this.vs_SoilSandContent=i.vs_SoilSandContent,this.vs_SoilClayContent=i.vs_SoilClayContent,this.vs_SoilStoneContent=i.vs_SoilStoneContent,this.vs_SoilTexture=i.vs_SoilTexture,this.vs_SoilpH=i.vs_SoilpH,this.vs_SoilMoistureOld_m3=.25,this.vs_SoilWaterFlux=0,this.vs_Lambda=i.vs_Lambda,this.vs_FieldCapacity=i.vs_FieldCapacity,this.vs_Saturation=i.vs_Saturation,this.vs_PermanentWiltingPoint=i.vs_PermanentWiltingPoint,this.vs_SOM_Slow=0,this.vs_SOM_Fast=0,this.vs_SMB_Slow=0,this.vs_SMB_Fast=0,this.vs_SoilCarbamid=0,this.vs_SoilNH4=1e-4,this.vs_SoilNO2=.001,this.vs_SoilNO3=.005,this.vs_SoilFrozen=!1,this.centralParameterProvider=n;var o=i.vs_SoilOrganicCarbon(),e=i.vs_SoilOrganicMatter(),_=i.vs_SoilBulkDensity(),l=0,a=.25,S=0;if(this.vo_AOM_Pool=[],!(o-e*organicConstants.po_SOM_to_C<1e-5))throw"_vs_SoilOrganicCarbon - (_vs_SoilOrganicMatter * organicConstants.po_SOM_to_C)) < 0.00001)";a=this.vs_FieldCapacity*n.userInitValues.p_initPercentageFC,this.vs_SoilMoistureOld_m3=this.vs_FieldCapacity*n.userInitValues.p_initPercentageFC,this.vs_SoilNH4=i.vs_SoilAmmonium<0?n.userInitValues.p_initSoilAmmonium:i.vs_SoilAmmonium,this.vs_SoilNO3=i.vs_SoilNitrate<0?n.userInitValues.p_initSoilNitrate:i.vs_SoilNitrate}var r=function(){return o>=0?o:e*organicConstants.po_SOM_to_C},C=function(){return e>=0?e:o/organicConstants.po_SOM_to_C},u=function(){return 1-s.vs_SoilSandContent-s.vs_SoilClayContent},h=function(){var t,i;t=s.vs_PermanentWiltingPoint>0?s.vs_PermanentWiltingPoint:m(),i=s.vs_Saturation>0?s.vs_Saturation:d();var n,o=exp(-2.486+2.5*s.vs_SoilSandContent-35.1*r()-2.617*(g()/1e3)-2.3*s.vs_SoilClayContent),e=1,_=exp(.053-.9*s.vs_SoilSandContent-1.3*s.vs_SoilClayContent+1.5*pow(s.vs_SoilSandContent,2));n=b()<=t?5e7:1/o*pow(pow((i-t)/(b()-t),1/e)-1,1/_),l=log10(n),l=0>l?5e-7:l},c=function(){if(""==s.vs_SoilTexture){var t,i;t=s.vs_PermanentWiltingPoint>0?s.vs_PermanentWiltingPoint:m(),i=s.vs_Saturation>0?s.vs_Saturation:d();var n=exp(-2.486+2.5*s.vs_SoilSandContent-35.1*r()-2.617*(g()/1e3)-2.3*s.vs_SoilClayContent),o=1,e=exp(.053-.9*s.vs_SoilSandContent-1.3*s.vs_SoilClayContent+1.5*pow(s.vs_SoilSandContent,2)),_=2.1;s.vs_SoilSandContent>.48&&s.vs_SoilSandContent<=.9&&s.vs_SoilClayContent<=.12?_=2.1-.476*(s.vs_SoilSandContent-.48):s.vs_SoilSandContent>.9&&s.vs_SoilClayContent<=.05?_=1.9:s.vs_SoilClayContent>.45?_=2.5:s.vs_SoilClayContent>.3&&s.vs_SoilSandContent<.2?_=2.4:s.vs_SoilClayContent>.35?_=2.3:s.vs_SoilClayContent>.25&&s.vs_SoilSandContent<.1?_=2.3:s.vs_SoilClayContent>.17&&s.vs_SoilSandContent>.68?_=2.2:s.vs_SoilClayContent>.17&&s.vs_SoilSandContent<.33?_=2.2:s.vs_SoilClayContent>.08&&s.vs_SoilSandContent<.27?_=2.2:s.vs_SoilClayContent>.25&&s.vs_SoilSandContent<.25&&(_=2.2);var l=pow(10,_);s.vs_FieldCapacity=t+(i-t)/pow(1+pow(n*l,e),o),s.vs_FieldCapacity*=1-s.vs_SoilStoneContent}return s.vs_FieldCapacity},d=function(){return""==s.vs_SoilTexture&&(s.vs_Saturation=.81-.283*(g()/1e3)+.1*s.vs_SoilClayContent,s.vs_Saturation*=1-s.vs_SoilStoneContent),s.vs_Saturation},m=function(){return""==s.vs_SoilTexture&&(s.vs_PermanentWiltingPoint=.015+.5*s.vs_SoilClayContent+1.4*s.vs_SoilOrganicCarbon(),s.vs_PermanentWiltingPoint*=1-s.vs_SoilStoneContent),s.vs_PermanentWiltingPoint},g=function(){return _},p=function(t){e=t},O=function(t){o=t},P=function(){return s.vs_SoilpH},y=function(){return h(),l},M=function(){return this.vs_SoilNH4},F=function(){return this.vs_SoilNO2},f=function(){return this.vs_SoilNO3},N=function(){return this.vs_SoilCarbamid},w=function(){return this.vs_SoilNO3+this.vs_SoilNO2+this.vs_SoilNH4},b=function(){return a},W=function(t){a=t},x=function(){return S},H=function(t){S=t},r=function(){return o},C=function(){return e},u=function(){return this.vs_SoilSiltContent};return{calc_vs_SoilMoisture_pF:h,centralParameterProvider:this.centralParameterProvider,get_FieldCapacity:c,get_PermanentWiltingPoint:m,get_Saturation:d,get_SoilCarbamid:N,get_SoilNH4:M,get_SoilNmin:w,get_SoilNO2:F,get_SoilNO3:f,get_SoilpH:P,get_Vs_SoilMoisture_m3:b,get_Vs_SoilTemperature:x,set_SoilOrganicCarbon:O,set_SoilOrganicMatter:p,set_Vs_SoilMoisture_m3:W,set_Vs_SoilTemperature:H,vo_AOM_Pool:this.vo_AOM_Pool,vs_FieldCapacity:this.vs_FieldCapacity,vs_Lambda:this.vs_Lambda,vs_LayerThickness:this.vs_LayerThickness,vs_PermanentWiltingPoint:this.vs_PermanentWiltingPoint,vs_Saturation:this.vs_Saturation,vs_SMB_Fast:this.vs_SMB_Fast,vs_SMB_Slow:this.vs_SMB_Slow,vs_SoilBulkDensity:g,vs_SoilCarbamid:this.vs_SoilCarbamid,vs_SoilClayContent:this.vs_SoilClayContent,vs_SoilFrozen:this.vs_SoilFrozen,vs_SoilMoisture_pF:y,vs_SoilMoistureOld_m3:this.vs_SoilMoistureOld_m3,vs_SoilNH4:this.vs_SoilNH4,vs_SoilNO2:this.vs_SoilNO2,vs_SoilNO3:this.vs_SoilNO3,vs_SoilOrganicCarbon:r,vs_SoilOrganicMatter:C,vs_SoilpH:this.vs_SoilpH,vs_SoilSandContent:this.vs_SoilSandContent,vs_SoilSiltContent:u,vs_SoilStoneContent:this.vs_SoilStoneContent,vs_SoilTexture:this.vs_SoilTexture,vs_SoilWaterFlux:this.vs_SoilWaterFlux,vs_SOM_Fast:this.vs_SOM_Fast,vs_SOM_Slow:this.vs_SOM_Slow}};

var SoilColumn=function(i,s,r){var e=this;this.generalParams=i,this.soilParams=s,this.centralParameterProvider=r,this.cropGrowth=null,this._delayedNMinApplications=[],this._vf_TopDressing=0,this._vf_TopDressingDelay=0,this._vs_NumberOfOrganicLayers=0;var t=[];t.vs_SurfaceWaterStorage=0,t.vs_InterceptionStorage=0,t.vm_GroundwaterTable=0,t.vs_FluxAtLowerBoundary=0,t.vq_CropNUptake=0,t.vs_SoilLayers=[],logger(MSG.INFO,"Constructor: SoilColumn "+s.length);for(var o=0;o<this.soilParams.length;o++){var a=new SoilLayer(i.ps_LayerThickness[0],s[o],r);t.vs_SoilLayers.push(a),t[o]=a}t.applyMineralFertiliser=function(i,s){if(this[0].vs_SoilNO3+=s*i.getNO3()/1e4/this[0].vs_LayerThickness,this[0].vs_SoilNH4+=s*i.getNH4()/1e4/this[0].vs_LayerThickness,this[0].vs_SoilCarbamid+=s*i.getCarbamid()/1e4/this[0].vs_LayerThickness,this[0].vs_SoilNH4<0)throw this[0].vs_SoilNH4},t.applyPossibleTopDressing=function(){if(e._vf_TopDressingDelay>0&&(e._vf_TopDressingDelay--,0==e._vf_TopDressingDelay)){var i=e._vf_TopDressing;return this.applyMineralFertiliser(e._vf_TopDressingPartition,i),e._vf_TopDressing=0,i}return 0},t.applyPossibleDelayedFerilizer=function(){for(var i=e._delayedNMinApplications,s=0;0===!i.length;)if(s+=i[0].func.apply(this,i[0].args),i.shift(),DEBUG&&i!=_delayedNMinApplications)throw i;return s},t.applyMineralFertiliserViaNMinMethod=function(i,s,r,t,o,a,n){if(this[0].get_Vs_SoilMoisture_m3()>this[0].get_FieldCapacity())return e._delayedNMinApplications.push({func:this.applyMineralFertiliserViaNMinMethod,args:[i,s,r,t,o,a,n]}),logger(MSG.WARN,"Soil too wet for fertilisation. Fertiliser event adjourned to next day."),0;for(var _=0,l=0,h=0,v=0,u=this.getLayerNumberForDepth(.3),p=ceil(s/this[f].vs_LayerThickness),f=0;p>f;f++)_+=this[f].vs_SoilNO3,h+=this[f].vs_SoilNH4;for(var f=0;u>f;f++)l+=this[f].vs_SoilNO3,v+=this[f].vs_SoilNH4;var g=r/1e4/this[0].vs_LayerThickness,S=t/1e4/this[0].vs_LayerThickness,c=g-(_+h),y=S-(l+v),O=1e4*c*this[0].vs_LayerThickness,m=1e4*y*this[0].vs_LayerThickness,N=max(O,m);return o>N&&(N=0,logger(MSG.WARN,"Fertiliser demand below minimum application value. No fertiliser applied.")),N>a&&(e._vf_TopDressing=N-a,e._vf_TopDressingPartition=i,e._vf_TopDressingDelay=n,N=a,logger(MSG.WARN,"Fertiliser demand above maximum application value. A top dressing of "+_vf_TopDressing+" will be applied from now on day"+n+".")),this.applyMineralFertiliser(i,N),logger(MSG.INFO,"SoilColumn::applyMineralFertiliserViaNMinMethod:	"+N),N},t.soilColumnArrayapplyIrrigationViaTrigger=function(i,s,r){null===e.cropGrowth&&logger(MSG.ERROR,"crop is null");var t=e.cropGrowth.get_HeatSumIrrigationStart(),o=e.cropGrowth.get_HeatSumIrrigationEnd(),a=e.cropGrowth.get_CurrentTemperatureSum();if(t>a||a>o)return!1;for(var n=e.centralParameterProvider.userSoilMoistureParameters.pm_CriticalMoistureDepth,_=0,l=0,h=0,v=int(ceil(n/e[0].vs_LayerThickness)),u=0;v>u;u++)_+=(this[u].get_Vs_SoilMoisture_m3()-this[u].get_PermanentWiltingPoint())*this.vs_LayerThickness()*1e3,l+=(this[u].get_FieldCapacity()-this[u].get_PermanentWiltingPoint())*this.vs_LayerThickness()*1e3,h=_/l;return i>=h?(this.applyIrrigation(s,r),logger(MSG.INFO,"applying automatic irrigation treshold: "+i+" amount: "+s+" N concentration: "+r),!0):!1},t.applyIrrigation=function(i,s){var r=0;this.vs_SurfaceWaterStorage+=i,r=s*i/this[0].vs_LayerThickness/1e6,this[0].vs_SoilNO3+=r},t.deleteAOMPool=function(){for(var i=0;i<this[0].vo_AOM_Pool.length;){for(var s=0,r=0,t=0;t<e._vs_NumberOfOrganicLayers;t++)s+=this[t].vo_AOM_Pool[i].vo_AOM_Slow,r+=this[t].vo_AOM_Pool[i].vo_AOM_Fast;if(1e-5>s+r)for(var t=0;t<e._vs_NumberOfOrganicLayers;t++){var o=0;o+=i,this[t].vo_AOM_Pool.splice(o,1)}else i++}},t.vs_NumberOfLayers=function(){return this.length},t.applyTillage=function(i){for(var s=this.getLayerNumberForDepth(i)+1,r=0,e=0,t=0,o=0,a=0,n=0,_=0,l=0,h=0,v=0,u=0,p=0,f=0,g=0;s>g;g++)r+=this[g].vs_SoilOrganicCarbon(),e+=this[g].vs_SoilOrganicMatter(),t+=this[g].get_Vs_SoilTemperature(),o+=this[g].get_Vs_SoilMoisture_m3(),a+=this[g].vs_SoilMoistureOld_m3,n+=this[g].vs_SOM_Slow,_+=this[g].vs_SOM_Fast,l+=this[g].vs_SMB_Slow,h+=this[g].vs_SMB_Fast,v+=this[g].vs_SoilCarbamid,u+=this[g].vs_SoilNH4,p+=this[g].vs_SoilNO2,f+=this[g].vs_SoilNO3;if(this[0].vs_SoilNH4<0)throw this[0].vs_SoilNH4;if(this[0].vs_SoilNO2<0)throw this[0].vs_SoilNO2;if(this[0].vs_SoilNO3<0)throw this[0].vs_SoilNO3;r/=s,e/=s,t/=s,o/=s,a/=s,n/=s,_/=s,l/=s,h/=s,v/=s,u/=s,p/=s,f/=s;for(var g=0;s>g;g++){if(this[g].set_SoilOrganicCarbon(r),this[g].set_SoilOrganicMatter(e),this[g].set_Vs_SoilTemperature(t),this[g].set_Vs_SoilMoisture_m3(o),this[g].vs_SoilMoistureOld_m3=a,this[g].vs_SOM_Slow=n,this[g].vs_SOM_Fast=_,this[g].vs_SMB_Slow=l,this[g].vs_SMB_Fast=h,this[g].vs_SoilCarbamid=v,this[g].vs_SoilNH4=u,this[g].vs_SoilNO2=p,this[g].vs_SoilNO3=f,this[g].vs_SoilNH4<0)throw this[g].vs_SoilNH4;if(this[g].vs_SoilNO2<0)throw this[g].vs_SoilNO2;if(this[g].vs_SoilNO3<0)throw this[g].vs_SoilNO3}var S=this[0].vo_AOM_Pool.length;if(S>0){for(var c=new Array(S),y=new Array(S),O=0;S>O;O++)c[O]=0,y[O]=0;s=min(s,this.vs_NumberOfOrganicLayers());for(var m=0;s>m;m++){var N=this[m],O=0;N.vo_AOM_Pool.forEach(function(i){c[O]+=i.vo_AOM_Slow,y[O]+=i.vo_AOM_Fast,O++})}for(var O=0;S>O;O++)c[O]=c[O]/s,y[O]=y[O]/s;for(var m=0;s>m;m++){N=this[m];var O=0;N.vo_AOM_Pool.forEach(function(i){i.vo_AOM_Slow=c[O],i.vo_AOM_Fast=y[O],O++})}}},t.vs_NumberOfOrganicLayers=function(){return e._vs_NumberOfOrganicLayers},t.soilLayer=function(i){return this[i]},t.vs_LayerThickness=function(){return this[0].vs_LayerThickness},t.get_DailyCropNUptake=function(){return 1e4*this.vq_CropNUptake},t.getLayerNumberForDepth=function(i){for(var s=0,r=this.length,e=0,t=this[0].vs_LayerThickness,o=0;r>o&&(e+=t,!(e>=i));o++)s++;return s},t.put_Crop=function(i){e.cropGrowth=i},t.remove_Crop=function(){e.cropGrowth=null},t.sumSoilTemperature=function(i){for(var s=0,r=0;i>r;r++)s+=this[r].get_Vs_SoilTemperature();return s},t.vs_NumberOfLayers=function(){return this.length};var n=function(){for(var i=0,s=0,r=0;r<t.vs_NumberOfLayers()&&(s++,i+=t.vs_SoilLayers[r].vs_LayerThickness,!(i>=e.generalParams.ps_MaxMineralisationDepth));r++);e._vs_NumberOfOrganicLayers=s};return n(),t};

var SoilOrganic=function(o,_,r,a){for(var e=o,t=r,i=a,s=(o.vs_NumberOfLayers(),o.vs_NumberOfOrganicLayers()),n=!1,l=0,v=new Float64Array(o.vs_NumberOfOrganicLayers()),S=new Float64Array(o.vs_NumberOfOrganicLayers()),O=0,M=new Float64Array(o.vs_NumberOfOrganicLayers()),c=new Float64Array(o.vs_NumberOfOrganicLayers()),u=0,f=new Float64Array(o.vs_NumberOfOrganicLayers()),g=new Float64Array(o.vs_NumberOfOrganicLayers()),A=0,N=new Float64Array(o.vs_NumberOfOrganicLayers()),p=0,w=0,m=0,y=0,C=new Float64Array(o.vs_NumberOfOrganicLayers()),d=0,F=0,P=new Float64Array(o.vs_NumberOfOrganicLayers()),b=new Float64Array(o.vs_NumberOfOrganicLayers()),D=new Float64Array(o.vs_NumberOfOrganicLayers()),h=new Float64Array(o.vs_NumberOfOrganicLayers()),H=new Float64Array(o.vs_NumberOfOrganicLayers()),B=0,L=new Float64Array(o.vs_NumberOfOrganicLayers()),R=0,T=0,k=0,E=0,V=0,U=!1,x=null,z=i.userSoilOrganicParameters.po_SOM_SlowUtilizationEfficiency,W=i.userSoilOrganicParameters.po_PartSOM_to_SMB_Slow,I=i.userSoilOrganicParameters.po_SOM_FastUtilizationEfficiency,K=i.userSoilOrganicParameters.po_PartSOM_to_SMB_Fast,G=i.userSoilOrganicParameters.po_SOM_SlowDecCoeffStandard,j=i.userSoilOrganicParameters.po_SOM_FastDecCoeffStandard,q=i.userSoilOrganicParameters.po_PartSOM_Fast_to_SOM_Slow,J=0;s>J;J++)h[J]=e[J].vs_SoilOrganicCarbon()*e[J].vs_SoilBulkDensity(),N[J]=.049*pow(h[J]*e[J].vs_LayerThickness/1e3*1e4,1.139)/1e4*1e3/e[J].vs_LayerThickness,h[J]-=N[J],e[J].vs_SMB_Slow=z*W*h[J],e[J].vs_SMB_Fast=I*K*h[J],e[J].vs_SOM_Slow=h[J]/(1+G/(j*q)),e[J].vs_SOM_Fast=h[J]-e[J].vs_SOM_Slow,h[J]-=e[J].vs_SMB_Slow+e[J].vs_SMB_Fast,e[J].set_SoilOrganicCarbon((h[J]+N[J])/e[J].vs_SoilBulkDensity()),e[J].set_SoilOrganicMatter((h[J]+N[J])/organicConstants.po_SOM_to_C/e[J].vs_SoilBulkDensity()),v[J]=0;var Q=function(o,_,r){var a=0;a=x?x.get_NetPrimaryProduction():0,debug("vc_NetPrimaryProduction: "+a),debug("crop: "+x),Z(_+l),$(),o_(n,o,r),__(),r_(),a_(),e_(),m=M_(a,A),w=c_(a,A),E+=F,k+=p,l=0,u=0,O=0,B=0,n=!1},X=function(o,_,r){debug("SoilOrganic: addOrganicMatter: "+o.toString());var a=_,t=r,s=o.vo_AOM_DryMatterContent,l=o.vo_AOM_NH4Content,v=o.vo_AOM_NO3Content,S=o.vo_AOM_CarbamidContent,M=o.vo_PartAOM_to_AOM_Slow,c=o.vo_PartAOM_to_AOM_Fast,f=o.vo_CN_Ratio_AOM_Slow,g=o.vo_CN_Ratio_AOM_Fast,A=i.userSoilOrganicParameters.po_AOM_FastMaxC_to_N;e.vs_NumberOfOrganicLayers()>0&&(e[0].vs_SoilCarbamid+=a*s*S/1e4/e[0].vs_LayerThickness);for(var N=0,p=0,w=e.vs_NumberOfOrganicLayers(),m=0;w>m;m++)if(0==m){var y=new AOM_Properties;y.vo_DaysAfterApplication=0,y.vo_AOM_DryMatterContent=s,y.vo_AOM_NH4Content=l,y.vo_AOM_Slow=0,y.vo_AOM_Fast=0,y.vo_AOM_SlowDecCoeffStandard=o.vo_AOM_SlowDecCoeffStandard,y.vo_AOM_FastDecCoeffStandard=o.vo_AOM_FastDecCoeffStandard,y.vo_CN_Ratio_AOM_Slow=f,y.incorporation=U,N=a*s*organicConstants.po_AOM_to_C/1e4/e[0].vs_LayerThickness,1e-7>=g?(p=a*s*t/1e4/e[0].vs_LayerThickness,debug("Added organic matter N amount: "+p),0>=t&&(p=.01),g=p>N*M/f?N*c/(p-N*M/f):A,g>A&&(g=A),y.vo_CN_Ratio_AOM_Fast=g):y.vo_CN_Ratio_AOM_Fast=o.vo_CN_Ratio_AOM_Fast,y.vo_PartAOM_Slow_to_SMB_Slow=o.vo_PartAOM_Slow_to_SMB_Slow,y.vo_PartAOM_Slow_to_SMB_Fast=o.vo_PartAOM_Slow_to_SMB_Fast,e[0].vo_AOM_Pool.push(y)}else{var y=new AOM_Properties;y.vo_DaysAfterApplication=0,y.vo_AOM_DryMatterContent=0,y.vo_AOM_NH4Content=0,y.vo_AOM_Slow=0,y.vo_AOM_Fast=0,y.vo_AOM_SlowDecCoeffStandard=o.vo_AOM_SlowDecCoeffStandard,y.vo_AOM_FastDecCoeffStandard=o.vo_AOM_FastDecCoeffStandard,y.vo_CN_Ratio_AOM_Slow=f,y.vo_CN_Ratio_AOM_Fast=0===!e[0].vo_AOM_Pool.length?e[0].vo_AOM_Pool[e[0].vo_AOM_Pool.length-1].vo_CN_Ratio_AOM_Fast:g,y.vo_PartAOM_Slow_to_SMB_Slow=o.vo_PartAOM_Slow_to_SMB_Slow,y.vo_PartAOM_Slow_to_SMB_Fast=o.vo_PartAOM_Slow_to_SMB_Fast,y.incorporation=U,e[m].vo_AOM_Pool.push(y)}var C=M*N,d=c*N,F=l*a*s/1e4/e[0].vs_LayerThickness,P=v*a*s/1e4/e[0].vs_LayerThickness,b=(1-(M+c))*N;if(e[0].vo_AOM_Pool[e[0].vo_AOM_Pool.length-1].vo_AOM_Slow+=C,e[0].vo_AOM_Pool[e[0].vo_AOM_Pool.length-1].vo_AOM_Fast+=d,e[0].vs_SoilNH4+=F,e[0].vs_SoilNO3+=P,e[0].vs_SOM_Fast+=b,e[0].vs_SoilNO3<0||e[0].vs_SoilNH4<0)throw debug("vo_AddedOrganicCarbonAmount",N),debug("vo_AOM_NO3Content",v),debug("vo_PartAOM_to_AOM_Slow",M),debug("vo_PartAOM_to_AOM_Fast",c),debug("vo_AOM_DryMatterContent",s),debug("vo_AddedOrganicMatterAmount",a),debug("vs_LayerThickness",e[0].vs_LayerThickness),debug("oilColumn.that[0].vs_SoilNO3",oilColumn.that[0].vs_SoilNO3),debug("soilColumn[0].vs_SoilNH4",e[0].vs_SoilNH4),"N < 0";u+=C,O+=d,B+=b,n=!0},Y=function(o){l+=o},Z=function(){var o=(e.vs_NumberOfOrganicLayers(),[]),_=[],r=[],a=[],t=[],s=[],l=[],v=0,S=0,O=0,M=0,c=0,u=0,f=0,g=i.userSoilOrganicParameters.po_HydrolysisKM,A=i.userSoilOrganicParameters.po_HydrolysisP1,N=i.userSoilOrganicParameters.po_HydrolysisP2,p=i.userSoilOrganicParameters.po_ActivationEnergy;F=0;for(var w=0;w<e.vs_NumberOfOrganicLayers();w++)if(o[w]=e[w].vs_SoilCarbamid/organicConstants.po_UreaMolecularWeight/organicConstants.po_Urea_to_N/1e3,_[w]=-1258.9+13.2843*(e[w].get_Vs_SoilTemperature()+273.15)-.047381*(e[w].get_Vs_SoilTemperature()+273.15)*(e[w].get_Vs_SoilTemperature()+273.15)+577264e-10*pow(e[w].get_Vs_SoilTemperature()+273.15,3),_[w]=_[w]/(1+.0453*_[w])*e[w].get_Vs_SoilMoisture_m3(),_[w]>=o[w]?(_[w]=o[w],o[w]=0):o[w]-=_[w],r[w]=(100*A*e[w].vs_SoilOrganicMatter()*organicConstants.po_SOM_to_C+N)/organicConstants.po_UreaMolecularWeight,a[w]=r[w]/exp(-p/2577.34),t[w]=a[w]*exp(-p/(8.314*(e[w].get_Vs_SoilTemperature()+273.15))),s[w]=exp(-.064*(e[w].vs_SoilpH-6.5)*(e[w].vs_SoilpH-6.5)),l[w]=t[w]*n_(e[w].vs_SoilMoisture_pF())*s[w]*_[w]/(g+_[w]),l[w]=86400*l[w]*e[w].vs_SoilBulkDensity(),l[w]>=_[w]?(e[w].vs_SoilNH4+=e[w].vs_SoilCarbamid,e[w].vs_SoilCarbamid=0):(e[w].vs_SoilCarbamid-=l[w]*organicConstants.po_UreaMolecularWeight*organicConstants.po_Urea_to_N*1e3,e[w].vs_SoilNH4+=l[w]*organicConstants.po_UreaMolecularWeight*organicConstants.po_Urea_to_N*1e3),0==w&&(v=pow(10,-e[0].vs_SoilpH),S=pow(10,-2728.3/(e[0].get_Vs_SoilTemperature()+273.15)-.094219),O=pow(10,1630.5/(e[0].get_Vs_SoilTemperature()+273.15)-2.301),M=e[0].vs_SoilNH4/(1e3*organicConstants.po_NH4MolecularWeight),c=M/(1+v/S),u=c,f=u*organicConstants.po_NH3MolecularWeight*1e3,f>=e[0].vs_SoilNH4?(f=e[0].vs_SoilNH4,e[0].vs_SoilNH4=0):e[0].vs_SoilNH4-=f,F=f*e[0].vs_LayerThickness,e[0].vs_SoilNH4<0))throw e[0].vs_SoilNH4;_[0]<.001&&!n&&(U=!1)},$=function(){for(var o=e.vs_NumberOfOrganicLayers(),_=i.userSoilOrganicParameters.po_SOM_SlowDecCoeffStandard,r=i.userSoilOrganicParameters.po_SOM_FastDecCoeffStandard,a=i.userSoilOrganicParameters.po_SMB_SlowDeathRateStandard,s=i.userSoilOrganicParameters.po_SMB_SlowMaintRateStandard,n=i.userSoilOrganicParameters.po_SMB_FastDeathRateStandard,l=i.userSoilOrganicParameters.po_SMB_FastMaintRateStandard,v=i.userSoilOrganicParameters.po_LimitClayEffect,S=i.userSoilOrganicParameters.po_SOM_SlowUtilizationEfficiency,O=i.userSoilOrganicParameters.po_SOM_FastUtilizationEfficiency,M=i.userSoilOrganicParameters.po_PartSOM_Fast_to_SOM_Slow,c=i.userSoilOrganicParameters.po_PartSMB_Slow_to_SOM_Fast,u=i.userSoilOrganicParameters.po_SMB_UtilizationEfficiency,f=i.userSoilOrganicParameters.po_CN_Ratio_SMB,N=i.userSoilOrganicParameters.po_AOM_SlowUtilizationEfficiency,p=i.userSoilOrganicParameters.po_AOM_FastUtilizationEfficiency,w=i.userSoilOrganicParameters.po_ImmobilisationRateCoeffNH4,m=i.userSoilOrganicParameters.po_ImmobilisationRateCoeffNO3,d=[],F=[],h=[],B=[],R=0,k=g.length;k>R;R++)g[R]=0;for(var E,V,U=[],x=[],z=[],W=[],I=[],R=0,k=b.length;k>R;R++)b[R]=0;for(var K=[],G=[],j=[],q=[],R=0,k=D.length;k>R;R++)D[R]=0;for(var J=[],R=0,k=H.length;k>R;R++)H[R]=0;for(var Q=[],R=0,k=L.length;k>R;R++)L[R]=0;for(var X,Y,Z=0;o>Z;Z++){var $=i_(e[Z].get_Vs_SoilTemperature()),o_=s_(e[Z].vs_SoilMoisture_pF());Q[Z]=_*$*o_,J[Z]=r*$*o_,q[Z]=(a+s)*t_(e[Z].vs_SoilClayContent,v)*$*o_,I[Z]=(n+l)*$*o_,j[Z]=a*$*o_,W[Z]=n*$*o_,G[Z]=j[Z]*e[Z].vs_SMB_Slow,z[Z]=W[Z]*e[Z].vs_SMB_Fast;for(var __=0,r_=e[Z].vo_AOM_Pool.length;r_>__;__++)X=e[Z].vo_AOM_Pool[__],X.vo_AOM_SlowDecCoeff=X.vo_AOM_SlowDecCoeffStandard*$*o_,X.vo_AOM_FastDecCoeff=X.vo_AOM_FastDecCoeffStandard*$*o_}for(var Z=0;o>Z;Z++){for(var __=0,r_=e[Z].vo_AOM_Pool.length;r_>__;__++)X=e[Z].vo_AOM_Pool[__],X.vo_AOM_SlowDelta=-(X.vo_AOM_SlowDecCoeff*X.vo_AOM_Slow),-X.vo_AOM_SlowDelta>X.vo_AOM_Slow&&(X.vo_AOM_SlowDelta=-X.vo_AOM_Slow),X.vo_AOM_FastDelta=-(X.vo_AOM_FastDecCoeff*X.vo_AOM_Fast),-X.vo_AOM_FastDelta>X.vo_AOM_Fast&&(X.vo_AOM_FastDelta=-X.vo_AOM_Fast);h[Z]=0;for(var __=0,r_=e[Z].vo_AOM_Pool.length;r_>__;__++)X=e[Z].vo_AOM_Pool[__],X.vo_AOM_SlowDecRate=X.vo_AOM_SlowDecCoeff*X.vo_AOM_Slow,h[Z]+=X.vo_AOM_SlowDecRate;D[Z]=S*Q[Z]*e[Z].vs_SOM_Slow+O*(1-M)*J[Z]*e[Z].vs_SOM_Fast+N*h[Z]-(q[Z]*e[Z].vs_SMB_Slow+G[Z]),d[Z]=0;for(var __=0,r_=e[Z].vo_AOM_Pool.length;r_>__;__++)X=e[Z].vo_AOM_Pool[__],X.vo_AOM_FastDecRate=X.vo_AOM_FastDecCoeff*X.vo_AOM_Fast,d[Z]+=X.vo_AOM_FastDecRate;b[Z]=u*(1-c)*(G[Z]+z[Z])+p*d[Z]-(I[Z]*e[Z].vs_SMB_Fast+z[Z]),L[Z]=M*J[Z]*e[Z].vs_SOM_Fast-Q[Z]*e[Z].vs_SOM_Slow,H[Z]=c*(G[Z]+z[Z])-J[Z]*e[Z].vs_SOM_Fast,B[Z]=0,F[Z]=0;for(var __=0,r_=e[Z].vo_AOM_Pool.length;r_>__;__++)X=e[Z].vo_AOM_Pool[__],B[Z]+=X.vo_AOM_SlowDelta,F[Z]+=X.vo_AOM_FastDelta}A=0;for(var Z=0;o>Z;Z++)K[Z]=(1-S)*Q[Z]*e[Z].vs_SOM_Slow+(1-O)*(1-M)*J[Z]*e[Z].vs_SOM_Fast+(1-N)*h[Z]+u*q[Z]*e[Z].vs_SMB_Slow,x[Z]=(1-u)*(1-c)*(G[Z]+z[Z])+(1-p)*d[Z]+I[Z]*e[Z].vs_SMB_Fast,P[Z]=K[Z]+x[Z],A+=P[Z]*e[Z].vs_LayerThickness;E=t.vs_Soil_CN_Ratio,V=t.vs_Soil_CN_Ratio;for(var Z=0;o>Z;Z++){U[Z]=-(D[Z]/f)-b[Z]/f-L[Z]/E-H[Z]/V,X=e[Z].vo_AOM_Pool;for(var __=0,r_=X.length;r_>__;__++)Y=X[__],abs(Y.vo_CN_Ratio_AOM_Fast)>=1e-7&&(U[Z]-=Y.vo_AOM_FastDelta/Y.vo_CN_Ratio_AOM_Fast),abs(Y.vo_CN_Ratio_AOM_Slow)>=1e-7&&(U[Z]-=Y.vo_AOM_SlowDelta/Y.vo_CN_Ratio_AOM_Slow)}y=0;for(var Z=0;o>Z;Z++){if(U[Z]<0){if(abs(U[Z])>=e[Z].vs_SoilNH4*w+e[Z].vs_SoilNO3*m){B[Z]=0,F[Z]=0,X=e[Z].vo_AOM_Pool;for(var __=0,r_=X.length;r_>__;__++)Y=X[__],Y.vo_CN_Ratio_AOM_Slow>=f/N&&(Y.vo_AOM_SlowDelta=0),Y.vo_CN_Ratio_AOM_Fast>=f/p&&(Y.vo_AOM_FastDelta=0),B[Z]+=Y.vo_AOM_SlowDelta,F[Z]+=Y.vo_AOM_FastDelta;E>=f/S&&(L[Z]=0),V>=f/O&&(H[Z]=0),D[Z]=S*Q[Z]*e[Z].vs_SOM_Slow+O*(1-M)*J[Z]*e[Z].vs_SOM_Fast+N*-B[Z]-(q[Z]*e[Z].vs_SMB_Slow+G[Z]),b[Z]=u*(1-c)*(G[Z]+z[Z])+p*-F[Z]-(I[Z]*e[Z].vs_SMB_Fast+z[Z]),U[Z]=-(D[Z]/f)-b[Z]/f-L[Z]/E-H[Z]/V;for(var __=0,r_=X.length;r_>__;__++)Y=X[__],abs(Y.vo_CN_Ratio_AOM_Fast)>=1e-7&&(U[Z]-=Y.vo_AOM_FastDelta/Y.vo_CN_Ratio_AOM_Fast),abs(Y.vo_CN_Ratio_AOM_Slow)>=1e-7&&(U[Z]-=Y.vo_AOM_SlowDelta/Y.vo_CN_Ratio_AOM_Slow);e[Z].vs_SoilNH4+=abs(U[Z])}else if(abs(U[Z])>=e[Z].vs_SoilNH4*w)e[Z].vs_SoilNO3-=abs(U[Z])-e[Z].vs_SoilNH4*w,e[Z].vs_SoilNH4-=e[Z].vs_SoilNH4*w;else if(e[Z].vs_SoilNH4-=abs(U[Z]),e[Z].vs_SoilNH4<0)throw e[Z].vs_SoilNH4}else e[Z].vs_SoilNH4+=abs(U[Z]);C[Z]=abs(U[Z])*e[0].vs_LayerThickness,y+=abs(U[Z])*e[0].vs_LayerThickness,T+=abs(U[Z])*e[0].vs_LayerThickness}},o_=function(o,_,r){var a,t,i,s,n,l,v=0,S=0,O=0;a=e[0].vs_SoilMoisture_pF()>2.5?0:1;var M=e[0].vo_AOM_Pool;if(M.forEach(function(o){O+=o.vo_DaysAfterApplication}),O>0||o?(v=0,M.forEach(function(o){t=0,i=0,s=0,n=0,l=0,t=1e3*o.vo_AOM_NH4Content*o.vo_AOM_DryMatterContent,i=.0495*pow(1.102,a)*pow(1.0223,_)*pow(1.0417,r)*pow(1.108,o.vo_AOM_DryMatterContent)*pow(.828,t)*pow(11.3,Number(o.incorporation)),s=1.038*pow(1.102,a)*pow(.96,_)*pow(.95,r)*pow(1.175,o.vo_AOM_DryMatterContent)*pow(1.106,t)*pow(1,Number(o.incorporation))*(18869.3*exp(-e[0].vs_SoilpH/.63321)+.70165),n=i*(s/pow(o.vo_DaysAfterApplication+s,2)),l=n*t*(o.vo_AOM_Slow+o.vo_AOM_Fast)/1e4/1e3,v+=l}),S=e[0].vs_SoilNH4>v?v:e[0].vs_SoilNH4,e[0].vs_SoilNH4-=S/e[0].vs_LayerThickness):S=0,e[0].vs_SoilNH4<0)throw e[0].vs_SoilNH4;d=S+F,M.forEach(function(_){_.vo_DaysAfterApplication>0&&!o&&_.vo_DaysAfterApplication++})},__=function(){if(e[0].vs_SoilNO3<0)throw e[0].vs_SoilNO3;for(var o=e.vs_NumberOfOrganicLayers(),_=i.userSoilOrganicParameters.po_AmmoniaOxidationRateCoeffStandard,r=i.userSoilOrganicParameters.po_NitriteOxidationRateCoeffStandard,a=new Array(o),t=new Array(o),s=new Array(o),n=new Array(o),l=0;o>l;l++)a[l]=_*l_(e[l].get_Vs_SoilTemperature())*v_(e[l].vs_SoilMoisture_pF()),s[l]=a[l]*e[l].vs_SoilNH4,t[l]=r*l_(e[l].get_Vs_SoilTemperature())*v_(e[l].vs_SoilMoisture_pF())*O_(e[l].vs_SoilNH4,e[l].vs_SoilpH),n[l]=t[l]*e[l].vs_SoilNH4;if(e[0].vs_SoilNH4<0)throw e[0].vs_SoilNH4;if(e[0].vs_SoilNO2<0)throw e[0].vs_SoilNO2;if(e[0].vs_SoilNO3<0)throw e[0].vs_SoilNO3;for(var l=0;o>l;l++)e[l].vs_SoilNH4>s[l]?(e[l].vs_SoilNH4-=s[l],e[l].vs_SoilNO2+=s[l]):(e[l].vs_SoilNO2+=e[l].vs_SoilNH4,e[l].vs_SoilNH4=0),e[l].vs_SoilNO2>n[l]?(e[l].vs_SoilNO2-=n[l],e[l].vs_SoilNO3+=n[l]):(e[l].vs_SoilNO3+=e[l].vs_SoilNO2,e[l].vs_SoilNO2=0);if(e[0].vs_SoilNH4<0)throw e[0].vs_SoilNH4;if(e[0].vs_SoilNO2<0)throw e[0].vs_SoilNO2;if(e[0].vs_SoilNO3<0)throw e[0].vs_SoilNO3},r_=function(){var o=e.vs_NumberOfOrganicLayers(),_=new Array(o),r=i.userSoilOrganicParameters.po_SpecAnaerobDenitrification,a=i.userSoilOrganicParameters.po_TransportRateCoeff;V=0;for(var t=0;o>t;t++)_[t]=r*P[t]*l_(e[t].get_Vs_SoilTemperature()),v[t]=min(_[t]*S_(e[t].get_Vs_SoilMoisture_m3(),e[t].get_Saturation()),a*e[t].vs_SoilNO3);for(var t=0;o>t;t++)e[t].vs_SoilNO3>v[t]?e[t].vs_SoilNO3-=v[t]:(v[t]=e[t].vs_SoilNO3,e[t].vs_SoilNO3=0),V+=v[t]*e[0].vs_LayerThickness;if(R+=V,0>V)throw V},a_=function(){var o=e.vs_NumberOfOrganicLayers(),_=new Array(o),r=i.userSoilOrganicParameters.po_N2OProductionRate;p=0;for(var a=0;o>a;a++)_[a]=e[a].vs_SoilNO2*l_(e[a].get_Vs_SoilTemperature())*r*(1/(1+(pow(10,e[a].vs_SoilpH)-organicConstants.po_pKaHNO2))),p+=_[a]},e_=function(){for(var o=0;o<e.vs_NumberOfOrganicLayers();o++){var _=e[o].vo_AOM_Pool;c[o]=0,S[o]=0,f[o]=0,M[o]=0,_.forEach(function(_){_.vo_AOM_Slow+=_.vo_AOM_SlowDelta,_.vo_AOM_Fast+=_.vo_AOM_FastDelta,c[o]+=_.vo_AOM_SlowDelta,S[o]+=_.vo_AOM_FastDelta,f[o]+=_.vo_AOM_Slow,M[o]+=_.vo_AOM_Fast}),e[o].vs_SOM_Slow+=L[o],e[o].vs_SOM_Fast+=H[o],e[o].vs_SMB_Slow+=D[o],e[o].vs_SMB_Fast+=b[o],g[o]=0==o?u+O+c[o]+S[o]+D[o]+b[o]+L[o]+H[o]+B:c[o]+S[o]+D[o]+b[o]+L[o]+H[o],h[o]=e[o].vs_SoilOrganicCarbon()*e[o].vs_SoilBulkDensity()-N[o],h[o]+=g[o],e[o].set_SoilOrganicCarbon((h[o]+N[o])/e[o].vs_SoilBulkDensity()),e[o].set_SoilOrganicMatter((h[o]+N[o])/organicConstants.po_SOM_to_C/e[o].vs_SoilBulkDensity())}},t_=function(o,_){var r=0;return o>=0&&_>=o?r=1-2*o:o>_&&1>=o?r=1-2*_:debug("irregular clay content"),r},i_=function(o){var _=0;return 0>=o&&o>-40?_=0:o>0&&20>=o?_=.1*o:o>20&&70>=o?_=exp(.47-.027*o+.00193*o*o):debug("irregular soil temperature fo_TempOnDecompostion (d_SoilTemperature = "+o+")"),_},s_=function(o){var _=0;return abs(o)<=1e-7?_=.6:o>0&&1.5>=o?_=.6+.4*(o/1.5):o>1.5&&2.5>=o?_=1:o>2.5&&6.5>=o?_=1-(o-2.5)/4:o>6.5?_=0:o===-1/0?_=0:debug("fo_MoistOnDecompostion ( d_SoilMoisture_pF ) : irregular soil water content"),_},n_=function(o){DEBUG&&debug(arguments);var _=0;return o>0&&1.1>=o?_=.72:o>1.1&&2.4>=o?_=.2207*o+.4672:o>2.4&&3.4>=o?_=1:o>3.4&&4.6>=o?_=-.8659*o+3.9849:o>4.6?_=0:o===-1/0?_=0:debug("fo_MoistOnHydrolysis ( d_SoilMoisture_pF: "+o+" ) irregular soil water content"),_},l_=function(o){var _=0;return 2>=o&&o>-40?_=0:o>2&&6>=o?_=.15*(o-2):o>6&&20>=o?_=.1*o:o>20&&70>=o?_=exp(.47-.027*o+.00193*o*o):debug("irregular soil temperature"),_},v_=function(o){var _=0;return abs(o)<=1e-7?_=.6:o>0&&1.5>=o?_=.6+.4*(o/1.5):o>1.5&&2.5>=o?_=1:o>2.5&&5>=o?_=1-(o-2.5)/2.5:o>5?_=0:debug("irregular soil water content"),_},S_=function(o,_){var r=i.userSoilOrganicParameters.po_Denit1,a=i.userSoilOrganicParameters.po_Denit2,e=i.userSoilOrganicParameters.po_Denit3,t=0;return.8>=o/_?t=0:o/_>.8&&.9>=o/_?t=r*(o/_-a)/(e-a):o/_>.9&&1>=o/_?t=r+(1-r)*(o/_-e)/(1-e):debug("irregular soil water content"),t},O_=function(o,_){var r=i.userSoilOrganicParameters.po_Inhibitor_NH3,a=0;return a=r+o*(1-1/(1+pow(10,_-organicConstants.po_pKaNH3)))/r},M_=function(o,_){var r=0;return r=o-1e4*_},c_=function(o,_){var r=0;return r=-o+1e4*_},u_=function(o){return h[o]/e[o].vs_SoilBulkDensity()},f_=function(o){return M[o]},g_=function(o){return f[o]},A_=function(o){return e[o].vs_SMB_Fast},N_=function(o){return e[o].vs_SMB_Slow},p_=function(o){return e[o].vs_SOM_Fast},w_=function(o){return e[o].vs_SOM_Slow},m_=function(o){return g[o]},y_=function(o){return P[o]},C_=function(o){return v[o]},d_=function(o){return 1e4*C[o]},F_=function(){return 1e4*y},P_=function(){return 1e4*T},b_=function(){return 1e4*R},D_=function(){return 1e4*V},h_=function(){return 1e4*d},H_=function(){return 1e4*E},B_=function(){return 1e4*p},L_=function(){return 1e4*k},R_=function(){return 1e4*A},T_=function(){return m},k_=function(){return w},E_=function(o){x=o},V_=function(){x=null};return{step:Q,addOrganicMatter:X,addIrrigationWater:Y,setIncorporation:function(o){U=o},put_Crop:E_,remove_Crop:V_,get_SoilOrganicC:u_,get_AOM_FastSum:f_,get_AOM_SlowSum:g_,get_SMB_Fast:A_,get_SMB_Slow:N_,get_SOM_Fast:p_,get_SOM_Slow:w_,get_CBalance:m_,get_SMB_CO2EvolutionRate:y_,get_ActDenitrificationRate:C_,get_NetNMineralisationRate:d_,get_NH3_Volatilised:h_,get_SumNH3_Volatilised:H_,get_N2O_Produced:B_,get_SumN2O_Produced:L_,get_NetNMineralisation:F_,get_SumNetNMineralisation:P_,get_SumDenitrification:b_,get_Denitrification:D_,get_DecomposerRespiration:R_,get_NetEcosystemProduction:T_,get_NetEcosystemExchange:k_}};

var FrostComponent=function(r,e){for(var t=r,n=e,u=0,o=0,a=0,s=0,i=0,v=new Float64Array(r.vs_NumberOfLayers()+1),f=n.userEnvironmentParameters.p_timeStep,c=n.userSoilMoistureParameters.pm_HydraulicConductivityRedux,m=0,g=v.length;g>m;m++)v[m]=1;var l=function(r,e){DEBUG&&debug(arguments);var t=_(),n=d(),a=p(t),i=y(n,a),v=b(n,t),f=h(r,e);if(u=F(t,i,f),isNaN(u))throw u;o+=u,s=D(f,v,t),S()},d=function(){for(var r=t.vs_NumberOfLayers(),e=0,n=0;r>n;n++)e+=t[n].vs_SoilBulkDensity();return e/r/1e3},_=function(){for(var r=t.vs_NumberOfLayers(),e=0,n=0;r>n;n++)e+=t[n].get_FieldCapacity();return e/r},p=function(r){DEBUG&&debug(arguments);var e=13.05,t=1.06,n=100*(r+(1+e*pow(r,t)*r));return n},y=function(r,e){DEBUG&&debug(arguments);var t=.001*(3*r-1.7)/(1+(11.5-5*r)*exp(-50*pow(e/r,1.5)))*86400*f*4.184/1e6*100;return t},b=function(r,e){DEBUG&&debug(arguments);var t=.001*(3*r-1.7)/(1+(11.5-5*r)*exp(-50*pow(100*e/r,1.5)))*f*4.184*100;return t},D=function(r,e,t){DEBUG&&debug(arguments);var n=0,o=0,a=0,i=0,v=0;return n=0>r?-1*r:r,o=0==u?0:sqrt(2*e*n/(79e5*t/100)),a=0>r?-1*o:o,i=s+a,v=0>i?0:i},F=function(r,e,t){DEBUG&&debug(arguments);var n=0,o=1e5*r/100*.335;u>0&&i++;var s=.3*i/o;return 0>t&&(a-=t),n=.01>a?0:sqrt(s/2*(s/2)+2*e*a/o)-s/2,isNaN(n)?0:n},h=function(r,e){DEBUG&&debug(arguments);var t=0;return t=.01>e/100?r:.01>u?r:r/(1+10*e/100/u)},S=function(){for(var r=t.vs_NumberOfLayers(),e=0;r>e;e++)if(e<int(floor(u/t[e].vs_LayerThickness+.5))&&(t[e].vs_SoilFrozen=!0,v[e]=0,0==e&&(c=0)),e<int(floor(s/t[e].vs_LayerThickness+.5))&&(s<(e+1)*t[e].vs_LayerThickness&&u>s?(t[e].vs_SoilFrozen=!0,v[e]=0,0==e&&(c=0)):(t[e].vs_SoilFrozen=!1,v[e]=1,0==e&&(c=.1))),s>=u){s=0,u=0,a=0,i=0,c=n.userSoilMoistureParameters.pm_HydraulicConductivityRedux;for(var e=0;r>e;e++)t[e].vs_SoilFrozen=!1,v[e]=1}},B=function(r){return v[r]};return{calcSoilFrost:l,getFrostDepth:function(){return u},getThawDepth:function(){return s},getLambdaRedux:B,getAccumulatedFrostDepth:function(){return o}}};

var SnowComponent=function(e){var n=0,t=0,r=0,a=0,u=0,i=0,o=e,p=o.userSoilMoistureParameters,m=0,c=p.pm_SnowMeltTemperature,_=p.pm_SnowAccumulationTresholdTemperature,g=p.pm_TemperatureLimitForLiquidWater,w=p.pm_CorrectionRain,f=p.pm_CorrectionSnow,s=p.pm_RefreezeTemperature,d=p.pm_RefreezeParameter1,D=p.pm_RefreezeParameter2,S=p.pm_NewSnowDensityMin,v=p.pm_SnowMaxAdditionalDensity,b=p.pm_SnowPacking,B=p.pm_SnowRetentionCapacityMin,E=p.pm_SnowRetentionCapacityMax,G=function(e,u){DEBUG&&debug(arguments);var i=0,o=0,p=l(e,u,o,i);u=p.net_precipitation,i=p.net_precipitation_snow,o=p.net_precipitation_water;var c=U(e),_=M(e),g=R(e,i);n=T(i,g),r=r+i-c+_,a=a+o+c-_;var w=r+a,f=y(r,w),s=0;_>0?s=0:f>=a?s=0:(s=a-f,a-=s,w=r+a),h(w),m=C(u,s,t)},U=function(e){DEBUG&&debug(arguments);var t=1.4*(n/.1),a=0;return t>4.7&&(t=4.7),0>=r?a=0:c>e?a=0:(a=t*(e-c),a>r&&(a=r)),a},l=function(e,n,t,r){DEBUG&&debug(arguments);var a=0;return a=e>=_?1:g>=e?0:(e-g)/(_-g),t=a*w*n,r=(1-a)*f*n,n=r+t,{net_precipitation:n,net_precipitation_snow:r,net_precipitation_water:t}},M=function(e){DEBUG&&debug(arguments);var n=0,t=0;return t=e>0?0:e,s>t?(a>0&&(n=d*pow(s-t,D)),n>a&&(n=a)):n=0,n},R=function(e,n){DEBUG&&debug(arguments);var t=0,r=0;return 0>=n?t=0:(r=(e-g)/(_-g),r>1&&(r=1),0>r&&(r=0),t=S+v*r),t},T=function(e,r){DEBUG&&debug(arguments);var a=0;return 0>=t+e?a=0:(a=((1+b)*n*t+r*e)/(t+e),a>S+v&&(a=S+v)),a},y=function(e,t){DEBUG&&debug(arguments);var r,a;return 0>=e||0>=n?r=0:(r=E/10/n,B>r&&(r=B),r>E&&(r=E)),a=r*t},C=function(e,n,t){DEBUG&&debug(arguments);var r=e;return t>=.01&&(m=n),r},h=function(e){DEBUG&&debug(arguments);var o=1;0>=e?t=0:(t=e*o/n,t>u&&(u=t),.01>t&&(t=0)),0==t&&(n=0,r=0,a=0),i+=t};return{calcSnowLayer:G,getVm_SnowDepth:function(){return t},getWaterToInfiltrate:function(){return m},getMaxSnowDepth:function(){return u},accumulatedSnowDepth:function(){return i}}};

var SoilMoisture=function(t,e,r,a){var n=t,o=e,i=r,u=a,c=t.vs_NumberOfLayers()+1,s=t.vs_NumberOfLayers(),_=0,l=new Float64Array(c),p=0,v=(new Float64Array(c),new Float64Array(c)),g=new Float64Array(c),f=new Float64Array(c),m=new Float64Array(c),S=new Float64Array(c),w=0,h=new Float64Array(c),y=0,F=0,d=(new Float64Array(c),0),A=0,R=.6,C=new Float64Array(c),D=0,M=e.vs_Latitude,P=new Float64Array(c),T=0,E=0,G=new Float64Array(c),L=0,x=new Float64Array(c),b=6,W=(new Float64Array(c),new Float64Array(c)),k=0,V=new Float64Array(c),N=0,I=0,O=0,H=0,B=new Float64Array(c),K=0,q=new Float64Array(c),U=0,X=null;d=0,A=0,I=0,p=0,y=0,vm_ActualTranspiration=0,vm_ActualEvaporation=0,vm_PercolationFactor=0,D=0;for(var Z=0;c>Z;Z++)W[Z]=.2,P[Z]=.01;logger(MSG.INFO,"Constructor: SoilMoisture");for(var j=new SnowComponent(u),z=new FrostComponent(n,u),J=u.userSoilMoistureParameters,Q=u.userEnvironmentParameters,Y=J.pm_HydraulicConductivityRedux,$=(u.userEnvironmentParameters.p_timeStep,J.pm_SurfaceRoughness),te=J.pm_GroundwaterDischarge,ee=J.pm_MaxPercolationRate,re=Q.p_LeachingDepth,ae=Q.p_LayerThickness,ne=int(floor(.5+re/ae))-1,oe=new Array(c),Z=0;c>Z;Z++)oe[Z]=J.pm_SaturatedHydraulicConductivity;var ie=function(t,e,r,a,_,l,p,v,g,f){DEBUG&&debug(arguments);for(var m=0;s>m;m++)W[m]=n[m].get_Vs_SoilMoisture_m3(),q[m]=0,S[m]=n[m].get_FieldCapacity(),V[m]=n[m].get_Saturation(),G[m]=n[m].get_PermanentWiltingPoint(),P[m]=n[m].vs_LayerThickness,C[m]=n[m].vs_Lambda;W[c-1]=n[c-2].get_Vs_SoilMoisture_m3(),q[c-1]=0,S[c-1]=n[c-2].get_FieldCapacity(),V[c-1]=n[c-2].get_Saturation(),P[c-1]=n[c-2].vs_LayerThickness,C[c-1]=n[c-2].vs_Lambda,H=n.vs_SurfaceWaterStorage;var h=!1,y=0,d=0;i.cropGrowth()?(h=!0,L=i.cropGrowth().get_SoilCoverage(),R=i.cropGrowth().get_KcFactor(),y=i.cropGrowth().get_CropHeight(),d=i.cropGrowth().get_DevelopmentalStage(),T=d>0?i.cropGrowth().get_NetPrecipitation():e):(h=!1,R=u.userSoilMoistureParameters.pm_KcFactor,T=e,L=0),F=s+2;for(var A=s-1,m=s-1;m>=0;m--)W[m]==V[m]&&A==m&&(A--,F=m);F>int(t/n[0].vs_LayerThickness)&&s+2>F?F=int(t/n[0].vs_LayerThickness):F>=s+2&&(F=int(t/n[0].vs_LayerThickness)),n.vm_GroundwaterTable=F,j.calcSnowLayer(l,T);var D=j.getWaterToInfiltrate();z.calcSoilFrost(l,j.getVm_SnowDepth()),ue(D,L,F),10>=t&&t>0?(pe(t),ve()):(ge(),fe()),me(L,R,o.vs_HeightNN,r,a,_,l,p,v,g,d,f,M),le();for(var m=0;s>m;m++)n[m].set_Vs_SoilMoisture_m3(W[m]),n[m].vs_SoilWaterFlux=q[m],n[m].calc_vs_SoilMoisture_pF();n.vs_SurfaceWaterStorage=H,n.vs_FluxAtLowerBoundary=w},ue=function(t,e,r){var a,i,u,c,s;d=0,A=0,I=0,p=0,y=0,vm_ActualTranspiration=0,c=0,s=0;var _=H;if(H+=t,k=(V[0]-W[0])/V[0],u=oe[0]*Y,u>0?(i=.2*u*k*k,d=min(H,i),d=min(d,1e3*(V[0]-W[0])*n[0].vs_LayerThickness),d=max(0,d)):d=0,d>0&&(H-=d),H>10*$/(o.vs_Slope+.001)&&(a=.02+$/4+e/15,o.vs_Slope<0||o.vs_Slope>1?logger(MSG.WARN,"Slope value out ouf boundary"):0==o.vs_Slope?I=0:I+=o.vs_Slope>a?H:o.vs_Slope*a/(a*a)*H,H-=I),W[0]+=d/1e3/P[0],q[0]=d,W[0]>S[0]){if(h[0]=1e3*(W[0]-S[0])*P[0],s=C[0]*z.getLambdaRedux(0),c=1+s*h[0],x[0]=h[0]*h[0]*s/c,x[0]>ee&&(x[0]=ee),h[0]=h[0]-x[0],h[0]=max(0,h[0]),W[0]=S[0]+h[0]/1e3/P[0],1>=r&&(x[0]=0),0==r&&(x[0]=0,W[0]>V[0]))return I+=1e3*(W[0]-V[0])*P[0],void(W[0]=V[0])}else W[0]<=S[0]&&(x[0]=0,h[0]=0);abs(_+t-(I+d+H))>.01&&logger(MSG.WARN,"water balance wrong!"),q[1]=x[0],O+=I},ce=function(t){return n[t].get_Vs_SoilMoisture_m3()},se=function(t){return v[t]},_e=function(t){return x[t]},le=function(){var t,e,r;if(t=X?X.get_RootingDepth():0,e=F-t,1>e&&(e=1),e*P[0]<=2.7){for(var a=0;s>a;a++)v[a]=S[a]-G[a],l[a]=W[a]-G[a],l[a]<0&&(l[a]=0),g[a]=.7*v[a];for(var o=.01,i=.01,c=min(F,s-1),a=c;a>=0;a--){var _=n[a].vs_SoilTexture;if(i=u.capillaryRiseRates.getRate(_,e),o>i&&(o=i),l[a]<g[a]){r=o,W[a]+=r;for(var p=c;p>=a;p--)q[p]-=r;break}}}},pe=function(t){var e,r;y=0;for(var a=0;c-1>a;a++)F-1>a&&(W[a+1]+=x[a]/1e3/P[a],q[a+1]=x[a],W[a+1]>S[a+1]?(h[a+1]=1e3*(W[a+1]-S[a+1])*P[a+1],r=C[a+1]*z.getLambdaRedux(a+1),e=1+r*h[a+1],x[a+1]=h[a+1]*h[a+1]*r/e,h[a+1]=h[a+1]-x[a+1],h[a+1]<0&&(h[a+1]=0),W[a+1]=S[a+1]+h[a+1]/1e3/P[a+1],W[a+1]>V[a+1]&&(h[a+1]=1e3*(W[a+1]-V[a+1])*P[a+1],W[a+1]=V[a+1],x[a+1]+=h[a+1])):(x[a+1]=0,h[a+1]=0)),a==F-1&&(F>=int(t/P[a])?(W[a+1]+=x[a]/1e3/P[a],x[a+1]=te,q[a+1]=x[a]):(W[a+1]+=(x[a]-te)/1e3/P[a],x[a+1]=te,q[a+1]=te),W[a+1]>=V[a+1]&&(y=1e3*(W[a+1]-V[a+1])*P[a+1],W[a+1]=V[a+1],0>=y&&(y=0))),a>F-1&&(W[a+1]=V[a+1],F>=int(t/P[a])?(x[a+1]=x[a],q[a]=x[a+1]):(x[a+1]=te,q[a]=te));w=q[ne]},ve=function(){var t;if(!(F>s)){t=F,t>c-2&&(t=c-2);for(var e=t;e>=0;e--)W[e]+=y/1e3/P[e+1],e==t?x[e]=te:(x[e]-=y,q[e+1]=x[e]),W[e]>V[e]?(y=1e3*(W[e]-V[e])*P[e+1],W[e]=V[e],F--,0==e&&0==F&&(H+=y,y=0)):y=0}},ge=function(){for(var t,e,r=0;c-1>r;r++)W[r+1]+=x[r]/1e3/P[r],W[r+1]>S[r+1]?(h[r+1]=1e3*(W[r+1]-S[r+1])*P[0],e=C[r+1]*z.getLambdaRedux(r+1),t=1+e*h[r+1],x[r+1]=h[r+1]*h[r+1]*e/t,x[r+1]>ee&&(x[r+1]=ee),h[r+1]=h[r+1]-x[r+1],h[r+1]<0&&(h[r+1]=0),W[r+1]=S[r+1]+h[r+1]/1e3/P[r+1]):(x[r+1]=0,h[r+1]=0),q[r+1]=x[r],y=x[r+1];w=ne>0&&c-1>ne?q[ne]:q[c-2]},fe=function(){for(var t=c-1,e=c-1,r=0,a=0;c-1>a;a++)W[a]>V[a]&&(t=a,e=a);if(0!=e)for(var a=t;a>=0;a--)W[a]+=r/1e3/P[a],a>0&&(q[a-1]-=r),W[a]>V[a]?(r=1e3*(W[a]-V[a])*P[a],W[a]=V[a],e--,0==a&&0==e&&(H+=r,r=0)):r=0},me=function(t,e,r,a,n,o,c,l,p,v,g,S,w){var h=0,y=0,F=0,d=0,A=0,R=0,C=0,D=0,M=0,T=!1,E=j.getVm_SnowDepth(),G=u.userSoilMoistureParameters;if(d=G.pm_EvaporationZeta,U=G.pm_XSACriticalSoilMoisture,A=G.pm_MaximumEvaporationImpactDepth,g>0?(b=i.cropGrowth().get_ReferenceEvapotranspiration(),C=i.cropGrowth().get_RemainingEvapotranspiration(),D=i.cropGrowth().get_EvaporatedFromIntercept()):(b=Se(r,a,n,o,c,l,p,v,S,w),C=b*e),vm_ActualEvaporation=0,vm_ActualTranspiration=0,C>6.5&&(C=6.5),C>0&&(H>0&&(T=!0,C*=1.1/e,E>0?M=0:C>H?(C-=H,M=H,H=0):(H-=C,M=C,C=0),C*=e/1.1),C>0))for(var L=0;s>L;L++)h=we(L,t,C),y=L>=A?0:he(L+1,A,d,P[L]),F=L>0&&W[L]<W[L-1]?.1:1,R=h*y*F,g>0?(t>=0&&1>t?f[L]=(1-t)*R*C:t>=1&&(f[L]=0),E>0&&(f[L]=0),B[L]=i.cropGrowth().get_Transpiration(L),T&&(B[L]=t*R*C)):(f[L]=E>0?0:C*R,B[L]=0),m[L]=f[L]+B[L],W[L]-=m[L]/1e3/P[L],W[L]<.01&&(W[L]=.01),vm_ActualTranspiration+=B[L],vm_ActualEvaporation+=f[L];_=vm_ActualTranspiration+vm_ActualEvaporation+D+M,X&&X.accumulateEvapotranspiration(_)},Se=function(t,e,r,a,n,o,i,c,s,_){var l,p,v,g,f,m,S,w,h,y,F,d,A,R,C,D,M,P,T,G,L,x,b=u.userCropParameters.pc_ReferenceAlbedo,W=3.141592653589793;l=-23.4*cos(2*W*((s+10)/365)),p=sin(l*W/180)*sin(_*W/180),v=cos(l*W/180)*cos(_*W/180),g=12*(W+2*asin(p/v))/W,f=12*(W+2*asin((-sin(8*W/180)+p)/v))/W,m=12*(W+2*asin((-sin(-6*W/180)+p)/v))/W,S=3600*(p*g+24/W*v*sqrt(1-p/v*(p/v))),w=650*S*exp(-.14/(S/(3600*g))),h=.2*w;var k=1440/W*8.2*(1+.033*cos(2*W*s/365)),V=acos(-tan(_*W/180)*tan(l*W/180));L=k*(V*p+v*sin(V))/100,y=101.3*pow((293-.0065*t)/293,5.26),F=665e-6*y,d=.6108*exp(17.27*e/(237.3+e)),A=.6108*exp(17.27*r/(237.3+r)),R=(d+A)/2,C=0>=a?A:a*R,D=R-C,M=2503.0584*exp(17.27*n/(n+237.3))/((n+237.3)*(n+237.3)),P=o*(4.87/log(67.8*i-5.42)),T=208/P,N=100,G=N/1.44;var I=(.75+2e-5*t)*L,O=c/I;O>1&&(O=1);var H=4.9e-9,B=(1-b)*c,K=H*((pow(r+273.16,4)+pow(e+273.16,4))/2)*(1.35*O-.35)*(.34-.14*sqrt(C));return E=B-K,x=(.408*M*E+F*(900/(n+273))*P*D)/(M+F*(1+G/208*P)),0>x&&(x=0),x},we=function(t,e,r){var a,o,i,u,c,s=1,_=n[t].get_Vs_SoilMoisture_m3(),l=n[t].get_PermanentWiltingPoint(),p=n[t].get_FieldCapacity();return.33*l>_&&(_=.33*l),o=(_-.33*l)/(p-.33*l),o>1&&(o=1),0==s?(i=.65*p,e>0&&(r>2.5?(u=(.65*p-l)*(p-l),c=u+(1-u)/17.5*(r-2.5)):c=U/2.5*r,i=n[t].get_FieldCapacity()*c),a=_>i?1:_>.33*l?o:0):1==s&&(a=0,a=o>.33?1-.1*(1-o)/(1-.33):o>.22?.9-.625*(.33-o)/(.33-.22):o>.2?.275-.225*(.22-o)/(.22-.2):.05-.05*(.2-o)/.2),a},he=function(t,e,r,a){var n,o=e/(10*a);if(abs(r)<3e-4)return n=2/o-1/(o*o)*(2*t-1);var i=0,u=0;return i=log((o+r*t)/(o+r*(t-1))),u=r/(o*(r+1)),n=(i-u)/(log(r+1)-r/(r+1))},ye=function(t){if(1===arguments.length){for(var e=0,r=0,a=0,o=0;s>o;o++){a++;var i=n[o].get_Vs_SoilMoisture_m3(),u=n[o].get_FieldCapacity(),c=n[o].get_PermanentWiltingPoint();if(r+=i/(u-c),e+=n[o].vs_LayerThickness,e>=t)break}return r/a}var _=arguments[0],l=arguments[1],r=0,a=0;if(_+l>s)return-1;for(var o=_;_+l>o;o++){a++;var i=n[o].get_Vs_SoilMoisture_m3(),u=n[o].get_FieldCapacity(),c=n[o].get_PermanentWiltingPoint();r+=i/(u-c)}return r/a},Fe=function(){return j.getVm_SnowDepth()},de=function(){return j.getMaxSnowDepth()},Ae=function(){return j.accumulatedSnowDepth()},Re=function(){return z.getAccumulatedFrostDepth()},Ce=function(t){X=t},De=function(){X=null},Me=function(){return d},Pe=function(){return H},Te=function(){return I},Ee=function(){return _},Ge=function(){return vm_ActualEvaporation},Le=function(){return b},xe=function(){return L},be=function(){return N},We=function(){return z.getFrostDepth()},ke=function(){return z.getThawDepth()},Ve=function(){return w},Ne=function(){return O},Ie=function(){return R},Oe=function(){return K};return{step:ie,get_SnowDepth:Fe,get_SoilMoisture:ce,get_CapillaryRise:se,get_PercolationRate:_e,get_Infiltration:Me,get_SurfaceWaterStorage:Pe,get_SurfaceRunOff:Te,get_Evapotranspiration:Ee,get_ActualEvaporation:Ge,get_ET0:Le,get_PercentageSoilCoverage:xe,get_StomataResistance:be,get_FrostDepth:We,get_ThawDepth:ke,get_GroundwaterRecharge:Ve,get_SumSurfaceRunOff:Ne,get_KcFactor:Ie,get_TranspirationDeficit:Oe,get_CapillaryRise:se,getMaxSnowDepth:de,accumulatedSnowDepth:Ae,getAccumulatedFrostDepth:Re,get_EReducer_1:we,put_Crop:Ce,remove_Crop:De,fm_Infiltration:ue,get_DeprivationFactor:he,fm_CapillaryRise:le,fm_PercolationWithGroundwater:pe,fm_GroundwaterReplenishment:ve,fm_PercolationWithoutGroundwater:ge,fm_BackwaterReplenishment:fe,fm_Evapotranspiration:me,ReferenceEvapotranspiration:Se,meanWaterContent:ye}};

var SoilTransport=function(e,r,a){for(var o=e,s=a,n=e.vs_NumberOfLayers(),i=new Float64Array(n),t=new Float64Array(n),v=new Float64Array(n),l=new Float64Array(n),f=new Float64Array(n),_=new Float64Array(n),u=0,p=r.vq_NDeposition,y=new Float64Array(n),F=new Float64Array(n),c=new Float64Array(n),A=new Float64Array(n),w=new Float64Array(n),L=1,N=(new Float64Array(n),new Float64Array(n)),m=null,S=0;n>S;S++)l[S]=1,_[S]=.1,c[S]=.2;logger(MSG.INFO,"N deposition: "+p);var g=s.userEnvironmentParameters.p_LeachingDepth,L=s.userEnvironmentParameters.p_timeStep,h=function(){for(var e=1,r=0;n>r;r++)f[r]=o[r].get_FieldCapacity(),c[r]=o[r].get_Vs_SoilMoisture_m3(),A[r]=o[r].vs_SoilNO3,_[r]=o[0].vs_LayerThickness,y[r]=m?m.get_NUptakeFromLayer(r):0,N[r]=r==n-1?o.vs_FluxAtLowerBoundary:o[r+1].vs_SoilWaterFlux,N[r]<=5&&e>=1?e=1:N[r]>5&&N[r]<=10&&e>=1?e=.5:N[r]>10&&N[r]<=15&&e>=.5?e=.25:N[r]>15&&e>=.25&&(e=.125);k(p),T();for(var a=0;1/e>a;a++)b(g,e);for(var r=0;n>r;r++)A[r]=w[r]*c[r],A[r]<0&&(A[r]=0),o[r].vs_SoilNO3=A[r]},k=function(e){var r=e/365;A[0]+=r/(1e4*o[0].vs_LayerThickness)},T=function(){for(var e=0,r=s.userCropParameters.pc_MinimumAvailableN,a=0;n>a;a++)y[a]>A[a]*_[a]-r&&(y[a]=A[a]*_[a]-r),y[a]<0&&(y[a]=0),e+=y[a],A[a]-=y[a]/_[a],w[a]=A[a]/c[a],w[a]<0;o.vq_CropNUptake=e},b=function(e,r){var a=s.userSoilTransportParameters,p=a.pq_DiffusionCoefficientStandard,y=a.pq_AD,A=a.pq_DispersionLength,m=0,S=0;u=0;for(var g=new Array(n),h=0;n>h;h++)m+=_[h],e>m-.001&&(S=h);for(var h=0;n>h;h++){var k=o[0].vs_SoilWaterFlux,T=o[h].vs_LayerThickness,b=w[h];if(0==h){var q=N[h]/1e3*r,d=w[h+1];q>=0&&k>=0?i[h]=b*q/T:q>=0&&0>k?i[h]=b*q/T:0>q&&0>k?i[h]=d*q/T:0>q&&k>=0&&(i[h]=d*q/T)}else if(n-1>h){var x=N[h-1]/1e3*r,q=N[h]/1e3*r,d=w[h+1];if(q>=0&&x>=0){var C=w[h-1];i[h]=(b*q-C*x)/T}else if(q>=0&&0>x)i[h]=(b*q-b*x)/T;else if(0>q&&0>x)i[h]=(d*q-b*x)/T;else if(0>q&&x>=0){var C=w[h-1];i[h]=(d*q-C*x)/T}}else{var x=N[h-1]/1e3*r,q=o.vs_FluxAtLowerBoundary/1e3*r;if(q>=0&&x>=0){var C=w[h-1];i[h]=(b*q-C*x)/T}else if(q>=0&&0>x)i[h]=(b*q-b*x)/T;else if(0>q&&0>x)i[h]=-(b*x)/T;else if(0>q&&x>=0){var C=w[h-1];i[h]=-(C*x)/T}}}for(var h=0;n>h;h++){var q=N[h]/1e3*r,D=o[0].vs_SoilWaterFlux/1e3*r,T=o[h].vs_LayerThickness,b=w[h];if(h==n-1?(F[h]=abs(q/f[h]),g[h]=c[h]):(F[h]=abs(q/(.5*(f[h]+f[h+1]))),g[h]=.5*(c[h]+c[h+1])),t[h]=p*(y*exp(2*g[h]*5)/g[h])*r,0==h)l[h]=g[h]*(t[h]+A*F[h])-.5*T*abs(q)+.5*L*r*abs((q+D)/2)*F[h];else{var x=N[h-1]/1e3*r;l[h]=g[h]*(t[h]+A*F[h])-.5*T*abs(q)+.5*L*r*abs((q+x)/2)*F[h]}if(0==h){var d=w[h+1];v[h]=-l[h]*(b-d)/(T*T)}else if(n-1>h){var C=w[h-1],d=w[h+1];v[h]=l[h-1]*(C-b)/(T*T)-l[h]*(b-d)/(T*T)}else{var C=w[h-1];v[h]=l[h-1]*(C-b)/(T*T)}}for(var h=0;n>h;h++)w[h]+=(v[h]-i[h])/c[h];if(N[S]>0){var T=o[S].vs_LayerThickness,b=w[S];if(n-1>S){var O=N[S+1]/1e3*r,d=w[S+1];u+=O*b/T*1e4*T+l[S]*(b-d)/(T*T)*1e4*T}else{var O=o.vs_FluxAtLowerBoundary/1e3*r;u+=O*b/T*1e4*T}}else{var O=N[S]/1e3*r,T=o[S].vs_LayerThickness,b=w[S];if(n-1>S){var d=w[S+1];u+=O*d/(1e4*T*T)+l[S]*(b-d)/(T*T*1e4*T)}}},q=function(e){return A[e]},d=function(){return u},x=function(e){m=e},C=function(){m=null};return{step:h,fq_NDeposition:k,fq_NUptake:T,fq_NTransport:b,put_Crop:x,remove_Crop:C,get_SoilNO3:q,get_NLeaching:d}};

var SoilTemperature=function(r,e,a){for(var t=e,i=a,s=new SoilLayer,u=new SoilLayer,n={sc:r,gl:s,bl:u,vs_nols:r.vs_NumberOfLayers(),at:function(r){return r<this.vs_nols?this[r]:r<this.vs_nols+1?this.gl:this.bl}},o=0;o<r.vs_NumberOfLayers();o++)n[o]=r[o];n[r.vs_NumberOfLayers()]=n.gl,n[r.vs_NumberOfLayers()+1]=n.bl;for(var v=r.vs_NumberOfLayers()+2,_=r.vs_NumberOfLayers(),c=new Array(v),p=new Array(v),f=new Array(v),S=new Array(v),y=new Array(v),l=new Array(v),m=new Array(v),T=new Array(v+1),g=new Array(v),w=new Array(v),h=new Array(v),L=.8,A=0,o=0;v>o;o++)c[o]=0,p[o]=0,f[o]=0,S[o]=0,y[o]=0,l[o]=0,m[o]=0,T[o]=0,g[o]=0,w[o]=0,h[o]=0;m[o+1]=0,logger(MSG.INFO,"Constructor: SoilTemperature");for(var k=a.userSoilTemperatureParameters,b=k.pt_BaseTemperature,D=k.pt_InitialSurfaceTemperature,N=k.pt_NTau,O=i.userEnvironmentParameters.p_timeStep,C=k.pt_QuartzRawDensity,H=k.pt_SpecificHeatCapacityWater,G=k.pt_SpecificHeatCapacityQuartz,B=k.pt_SpecificHeatCapacityAir,d=k.pt_SpecificHeatCapacityHumus,E=k.pt_DensityWater,F=k.pt_DensityAir,M=k.pt_DensityHumus,V=k.pt_SoilMoisture,z=0;_>z;z++)p[z]=(1-z/_)*D+z/_*b,c[z]=V;f[0]=n[0].vs_LayerThickness,l[0]=2/n[0].vs_LayerThickness;var I=v-2,P=v-1;n[I].vs_LayerThickness=2*n[I-1].vs_LayerThickness,n[P].vs_LayerThickness=1,p[I]=.5*(p[I-1]+b),p[P]=b;for(var Q=n[0].vs_LayerThickness,z=1;v>z;z++){var U=n[z].vs_LayerThickness;l[z]=2/(U+Q),f[z]=U*N,Q=U}for(var z=0;_>z;z++){var W=n.at(z).vs_SoilBulkDensity(),x=c[z];g[z]=.001*(3*(W/1e3)-1.7)/(1+(11.5-5*(W/1e3))*exp(-50*pow(x/(W/1e3),1.5)))*86400*O*100*4.184;var R=H,j=G,q=B,J=d,K=E,X=C,Y=F,Z=M,$=n[z].get_Saturation(),re=n.at(z).vs_SoilOrganicMatter()/Y*W;h[z]=x*K*R+($-x)*Y*q+re*Z*J+(1-$-re)*X*j}h[I]=h[I-1],h[P]=h[I],g[I]=g[I-1],g[P]=g[I],vt_SoilSurfaceTemperature=D,w[0]=g[0];for(var z=1;v>z;z++){var ee=n.at(z-1).vs_LayerThickness,ae=n.at(z).vs_LayerThickness,te=g[z-1],ie=g[z];w[z]=(ee*te+ae*ie)/(ae+ee)}for(var z=0;v>z;z++)S[z]=f[z]*h[z],y[z]=S[z],T[z]=-l[z]*w[z];T[P+1]=0;for(var z=0;v>z;z++)m[z]=S[z]-T[z]-T[z+1];var se=function(r,e,a){DEBUG&&debug(arguments);for(var t=v-2,i=v-1,s=new Array(v),u=new Array(v),o=new Array(v),c=0;v>c;c++)s[c]=0,u[c]=0,o[c]=0;A=ue(r,e,a)*l[0]*w[0],s[0]=(y[0]+(S[0]-y[0])/n[0].vs_LayerThickness)*p[0]+A;for(var f=1;v>f;f++)s[f]=(y[f]+(S[f]-y[f])/n[f].vs_LayerThickness)*p[f];u[0]=m[0];for(var f=1;v>f;f++)o[f]=T[f]/u[f-1],u[f]=m[f]-o[f]*T[f];for(var f=1;v>f;f++)s[f]=s[f]-o[f]*s[f-1];s[i]=s[i]/u[i];for(var f=0;i>f;f++){var g=i-1-f,h=g+1;s[g]=s[g]/u[g]-o[h]*s[h]}for(var f=0;v>f;f++)p[f]=s[f];for(var f=0;_>f;f++)y[f]=S[f],n[f].set_Vs_SoilTemperature(p[f]);y[t]=S[t],y[i]=S[i]},ue=function(r,e,a){DEBUG&&debug(arguments);var i=L,s=0;t.cropGrowth()&&(s=t.cropGrowth().get_SoilCoverage()),i=.1+(s*L+(1-s)*(1-L));var u=vt_SoilSurfaceTemperature;return 8.33>a&&(a=8.33),vt_SoilSurfaceTemperature=(1-i)*(r+(e-r)*pow(.03*a,.5))+i*u,0>vt_SoilSurfaceTemperature&&(vt_SoilSurfaceTemperature=.5*vt_SoilSurfaceTemperature),vt_SoilSurfaceTemperature},ne=function(){return vt_SoilSurfaceTemperature};get_SoilTemperature=function(r){return n[r].get_Vs_SoilTemperature()};var oe=function(r){return g[r]},ve=function(r){0===arguments.length&&(r=.3);for(var e=0,a=0,t=0,i=0;_>i&&(t++,a+=n[i].get_Vs_SoilTemperature(),e+=n[i].vs_LayerThickness,!(e>=r));i++);return 1>t?0:a/t};return{step:se,f_SoilSurfaceTemperature:ue,get_SoilSurfaceTemperature:ne,get_SoilTemperature:get_SoilTemperature,get_HeatConductivity:oe,get_AvgTopSoilTemperature:ve,getDampingFactor:function(){return L},setDampingFactor:function(r){L=r},vt_SoilSurfaceTemperature:vt_SoilSurfaceTemperature}};

var Configuration=function(e,t,a){function r(e,t){var a=!0,r=t.length;logger(MSG.INFO,"Fetching "+r+" crops.");for(var g=0;r>g;g++){var s=t[g],u=s.name.id;(!u||0>u||isNaN(u))&&(a=!1,logger(MSG.ERROR,"Invalid crop id: "+u+"."));var m=new Date(Date.parse(s.sowingDate)),d=new Date(Date.parse(s.finalHarvestDate));debug(m,"sd"),debug(d,"hd"),m.isValid()&&d.isValid()||(a=!1,logger(MSG.ERROR,"Invalid sowing or harvest date."));var v=new Crop(u,s.name.name+", "+s.name.gen_type);v.setSeedAndHarvestDate(m,d),v.setCropParameters(getCropParameters(v.id())),v.setResidueParameters(getResidueParameters(v.id())),e[g]=new ProductionProcess(s.name.name+", "+s.name.gen_type,v);var c=s.tillageOperations;c&&(i(e[g],c)||(a=!1,logger(MSG.ERROR,"Error adding tillages.")));var p=s.mineralFertilisers;p&&(n(e[g],p,!1)||(a=!1,logger(MSG.ERROR,"Error adding mineral fertilisers.")));var h=s.organicFertilisers;h&&(n(e[g],h,!0)||(a=!1,logger(MSG.ERROR,"Error adding organic fertilisers.")));var _=s.irrigations;_&&(o(e[g],_)||(a=!1,logger(MSG.ERROR,"Error adding irrigations.")));var S=s.cuttings;S&&(l(e[g],S)||(a=!1,logger(MSG.ERROR,"Error adding cuttings."))),logger(MSG.INFO,"Fetched crop "+g+", name: "+s.name.name+", id: "+u+".")}return a}function i(e,t){var a=!0,r=t.length;logger(MSG.INFO,"Fetching "+r+" tillages.");for(var i=0;r>i;++i){var n=t[i];if(null!==n.date&&null!==n.depth&&null!==n.method){{var o=new Date(Date.parse(n.date)),l=n.depth/100;n.method}o.isValid()||(a=!1,logger(MSG.ERROR,"Invalid tillage date in tillage no. "+i+".")),e.addApplication(new TillageApplication(o,l)),logger(MSG.INFO,"Fetched tillage "+i+".")}else logger(MSG.WARN,"At least one tillage parameter null: tillage "+i+" ignored.")}return a}function n(e,t,a){var r=!0,i=t.length;logger(MSG.INFO,"Fetching "+i+" "+(a?"organic":"mineral")+" fertilisers.");for(var n=0;i>n;++n){var o=t[n];if(null!==o.date&&null!==o.method&&null!==o.type&&null!==o.amount){var l=new Date(Date.parse(o.date)),g=(o.method,o.type),s=o.amount;if(l.isValid()||(r=!1,logger(MSG.ERROR,"Invalid fertilization date in "+n+".")),a){var u=g.id;0>u&&(logger(MSG.ERROR,"Organic fertilser "+g.id+" not found."),r=!1),e.addApplication(new OrganicFertiliserApplication(l,getOrganicFertiliserParameters(u),s,!0))}else{var m=g.id;0>m&&(logger(MSG.ERROR,"Mineral fertilser "+g.id+" not found."),r=!1),e.addApplication(new MineralFertiliserApplication(l,getMineralFertiliserParameters(m),s))}logger(MSG.INFO,"Fetched "+(a?"organic":"mineral")+" fertiliser "+n+".")}else logger(MSG.WARN,"At least one fertiliser parameter null: "+(a?"organic":"mineral")+" fertiliser "+n+"ignored.")}return r}function o(e,t){var a=!0,r=t.length;logger(MSG.INFO,"Fetching "+r+" irrigations.");for(var i=0;r>i;++i){var n=t[i];if(null!==n.date&&null!==n.method&&null!==n.eventType&&null!==n.threshold&&null!==n.amount&&null!==n.NConc){var o=(n.method,n.eventType,n.threshold,n.area,n.amount),l=n.NConc,g=new Date(Date.parse(n.date));g.isValid()||(a=!1,logger(MSG.ERROR,"Invalid irrigation date in "+i+".")),e.addApplication(new IrrigationApplication(g,o,new IrrigationParameters(l,0))),logger(MSG.INFO,"Fetched irrigation "+i+".")}else logger(MSG.WARN,"At least one irrigation parameter null: irrigation "+i+" ignored.")}return a}function l(e,t){var a=!0,r=t.length;logger(MSG.INFO,"Fetching "+r+" cuttings.");for(var i=0;r>i;++i){var n=t[i],o=new Date(Date.parse(n.date));e.addApplication(new Cutting(o,e.crop(),e.cropResult()))}return a}function g(e){var a=!1;return t&&(e.addClimateData(Climate.tmin,new Float64Array(t.tmin)),e.addClimateData(Climate.tmax,new Float64Array(t.tmax)),e.addClimateData(Climate.tavg,new Float64Array(t.tavg)),e.addClimateData(Climate.globrad,new Float64Array(t.globrad)),e.addClimateData(Climate.wind,new Float64Array(t.wind)),e.addClimateData(Climate.precip,new Float64Array(t.precip)),t.sunhours.length>0&&e.addClimateData(Climate.sunhours,new Float64Array(t.sunhours)),t.relhumid.length>0&&e.addClimateData(Climate.relhumid,new Float64Array(t.relhumid)),a=!0),a}DEBUG=a===!0?!0:!1;var s=e,u=function(e,t,a){logger(MSG.INFO,"Fetching parameters from database.");var i=new SiteParameters,n=readUserParameterFromDatabase(),o=new GeneralParameters(n.userEnvironmentParameters.p_LayerThickness,n.userEnvironmentParameters.p_LayerThickness*n.userEnvironmentParameters.p_NumberOfLayers),l=t.horizons,u=a.crops,v=new Date(Date.parse(e.time.startDate)).getFullYear(),c=new Date(Date.parse(e.time.endDate)).getFullYear();n.userEnvironmentParameters.p_UseSecondaryYields=e.switch.useSecondaryYieldOn===!0?!0:!1,o.pc_NitrogenResponseOn=e.switch.nitrogenResponseOn===!0?!0:!1,o.pc_WaterDeficitResponseOn=e.switch.waterDeficitResponseOn===!0?!0:!1,o.pc_EmergenceMoistureControlOn=e.switch.emergenceMoistureControlOn===!0?!0:!1,o.pc_EmergenceFloodingControlOn=e.switch.emergenceFloodingControlOn===!0?!0:!1,n.userInitValues.p_initPercentageFC=e.init.percentageFC,n.userInitValues.p_initSoilNitrate=e.init.soilNitrate,n.userInitValues.p_initSoilAmmonium=e.init.soilAmmonium,logger(MSG.INFO,"Fetched sim data."),i.vq_NDeposition=t.NDeposition,i.vs_Latitude=t.latitude,i.vs_Slope=t.slope,i.vs_HeightNN=t.heightNN,i.vs_Soil_CN_Ratio=10,i.vs_DrainageCoeff=-1,n.userEnvironmentParameters.p_AthmosphericCO2=t.atmosphericCO2,n.userEnvironmentParameters.p_WindSpeedHeight=t.windSpeedHeight,n.userEnvironmentParameters.p_LeachingDepth=t.leachingDepth,o.ps_MaxMineralisationDepth=.4,logger(MSG.INFO,"Fetched site data.");var p=100*n.userEnvironmentParameters.p_LayerThickness,h=200,_=int(h/p),S=[];if(!m(S,l,p,_))return void logger(MSG.ERROR,"Error fetching soil data.");logger(MSG.INFO,"Fetched soil data.");var C=new DataAccessor(new Date(v,0,1),new Date(c,11,31));if(!g(C,n,i.vs_Latitude))return void logger(MSG.ERROR,"Error fetching climate data.");logger(MSG.INFO,"Fetched climate data.");var O=[];if(!r(O,u))return void logger(MSG.ERROR,"Error fetching crop data.");logger(MSG.INFO,"Fetched crop data.");var R=new Environment(S,n);return R.general=o,R.pathToOutputDir=s,R.site=i,R.da=C,R.cropRotation=O,logger(MSG.INFO,"Start monica model."),runMonica(R,d)},m=function(e,t,a,r){var i=!0,n=t.length,o=0;logger(MSG.INFO,"Fetching "+n+" horizons.");for(var l=0;n>l;++l){debug("lThicknessCm",a),debug("maxNoOfLayers",r),debug("depth",o);var g=t[l],s=100*g.thickness,u=int(round(s/a));l==n-1&&int(e.length)+u<r&&(u+=r-e.length-u);for(var m=0;u>m;m++){if(o===r*a){logger(MSG.WARN,"Maximum soil layer depth ("+r*a+" cm) reached. Remaining layers in horizon "+l+" ignored.");break}o+=a;var d=new SoilParameters;d.set_vs_SoilOrganicCarbon(g.Corg),g.bulkDensity&&d.set_vs_SoilBulkDensity(g.bulkDensity),d.vs_SoilSandContent=g.sand,d.vs_SoilClayContent=g.clay,d.vs_SoilStoneContent=g.sceleton,d.vs_Lambda=Tools.texture2lambda(d.vs_SoilSandContent,d.vs_SoilClayContent),d.vs_SoilTexture=g.textureClass,d.vs_SoilpH=g.pH,d.vs_Lambda=Tools.texture2lambda(d.vs_SoilSandContent,d.vs_SoilClayContent),d.vs_FieldCapacity=g.fieldCapacity,d.vs_Saturation=g.poreVolume,d.vs_PermanentWiltingPoint=g.permanentWiltingPoint,d.isValid()||(i=!1,logger(MSG.ERROR,"Error in soil parameters.")),e.push(d),logger(MSG.INFO,"Fetched layer "+e.length+" in horizon "+l+".")}logger(MSG.INFO,"Fetched horizon "+l+".")}return i},d=function(e,t){var a={};if(e||t){var r=t.isCropPlanted(),i=t.cropGrowth(),n=t.soilTemperature(),o=t.soilMoisture(),l=(t.soilOrganic(),t.soilColumn()),g=t.soilColumnNC(),s=t.soilTransport();a={date:{value:e.toLocaleDateString(),unit:"[date]"},CropName:{value:r?i.get_CropName():"",unit:"-"},TranspirationDeficit:{value:r?i.get_TranspirationDeficit():0,unit:"[0;1]"},ActualTranspiration:{value:r?i.get_ActualTranspiration():0,unit:"[mm]"},CropNRedux:{value:r?i.get_CropNRedux():0,unit:"[0;1]"},HeatStressRedux:{value:r?i.get_HeatStressRedux():0,unit:"[0;1]"},OxygenDeficit:{value:r?i.get_OxygenDeficit():0,unit:"[0;1]"},DevelopmentalStage:{value:r?i.get_DevelopmentalStage()+1:0,unit:"[#]"},CurrentTemperatureSum:{value:r?i.get_CurrentTemperatureSum():0,unit:"°C"},VernalisationFactor:{value:r?i.get_VernalisationFactor():0,unit:"[0;1]"},DaylengthFactor:{value:r?i.get_DaylengthFactor():0,unit:"[0;1]"},OrganGrowthIncrementRoot:{value:r?i.get_OrganGrowthIncrement(0):0,unit:"[kg (DM) ha-1]"},OrganGrowthIncrementLeaf:{value:r?i.get_OrganGrowthIncrement(1):0,unit:"[kg (DM) ha-1]"},OrganGrowthIncrementShoot:{value:r?i.get_OrganGrowthIncrement(2):0,unit:"[kg (DM) ha-1]"},OrganGrowthIncrementFruit:{value:r?i.get_OrganGrowthIncrement(3):0,unit:"[kg (DM) ha-1]"},RelativeTotalDevelopment:{value:r?i.get_RelativeTotalDevelopment():0,unit:"[0;1]"},OrganBiomassRoot:{value:r?i.get_OrganBiomass(0):0,unit:"[kg (DM) ha-1]"},OrganBiomassLeaf:{value:r?i.get_OrganBiomass(1):0,unit:"[kg (DM) ha-1]"},OrganBiomassShoot:{value:r?i.get_OrganBiomass(2):0,unit:"[kg (DM) ha-1]"},OrganBiomassFruit:{value:r?i.get_OrganBiomass(3):0,unit:"[kg (DM) ha-1]"},PrimaryCropYield:{value:r?i.get_PrimaryCropYield():0,unit:"[kg (DM) ha-1]"},LeafAreaIndex:{value:r?i.get_LeafAreaIndex():0,unit:"[m-2 m-2]"},GrossPhotosynthesisHaRate:{value:r?i.get_GrossPhotosynthesisHaRate():0,unit:"[kg (CH2O) ha-1 d-1]"},NetPhotosynthesis:{value:r?i.get_NetPhotosynthesis():0,unit:"[kg (CH2O) ha-1 d-1]"},MaintenanceRespirationAS:{value:r?i.get_MaintenanceRespirationAS():0,unit:"[kg (CH2O) ha-1 d-1]"},GrowthRespirationAS:{value:r?i.get_GrowthRespirationAS():0,unit:"[kg (CH2O) ha-1 d-1]"},StomataResistance:{value:r?i.get_StomataResistance():0,unit:"[s m-1]"},CropHeight:{value:r?i.get_CropHeight():0,unit:"[m]"},LeafAreaIndex:{value:r?i.get_LeafAreaIndex():0,unit:"[m2 m-2]"},RootingDepth:{value:r?i.get_RootingDepth():0,unit:"[layer #]"},AbovegroundBiomass:{value:r?i.get_AbovegroundBiomass():0,unit:"[kg ha-1]"},TotalBiomassNContent:{value:r?i.get_TotalBiomassNContent():0,unit:"[?]"},SumTotalNUptake:{value:r?i.get_SumTotalNUptake():0,unit:"[kg (N) ha-1]"},ActNUptake:{value:r?i.get_ActNUptake():0,unit:"[kg (N) ha-1]"},PotNUptake:{value:r?i.get_PotNUptake():0,unit:"[kg (N) ha-1]"},TargetNConcentration:{value:r?i.get_TargetNConcentration():0,unit:"[kg (N) ha-1]"},CriticalNConcentration:{value:r?i.get_CriticalNConcentration():0,unit:"[kg (N) ha-1]"},AbovegroundBiomassNConcentration:{value:r?i.get_AbovegroundBiomassNConcentration():0,unit:"[kg (N) ha-1]"},NetPrimaryProduction:{value:r?i.get_NetPrimaryProduction():0,unit:"[kg (N) ha-1]"},GrossPrimaryProduction:{value:r?i.get_GrossPrimaryProduction():0,unit:"[kg (N) ha-1]"},AutotrophicRespiration:{value:r?i.get_AutotrophicRespiration():0,unit:"[kg (C) ha-1]"}};for(var u=20,m=0;u>m;m++)a["SoilMoisture_"+m]={value:o.get_SoilMoisture(m),unit:"[m-3 m-3]"};a.dailySumIrrigationWater={value:t.dailySumIrrigationWater(),unit:"[mm]"},a.Infiltration={value:o.get_Infiltration(),unit:"[mm]"},a.SurfaceWaterStorage={value:o.get_SurfaceWaterStorage(),unit:"[mm]"},a.SurfaceRunOff={value:o.get_SurfaceRunOff(),unit:"[mm]"},a.SnowDepth={value:o.get_SnowDepth(),unit:"[mm]"},a.FrostDepth={value:o.get_FrostDepth(),unit:"[mm]"},a.ThawDepth={value:o.get_ThawDepth(),unit:"[mm]"};for(var m=0;u>m;m++)a["PASW_"+m]={value:o.get_SoilMoisture(m)-g[m].get_PermanentWiltingPoint(),unit:"[m-3 m-3]"};a.SoilSurfaceTemperature={value:n.get_SoilSurfaceTemperature(),unit:"[°C]"};for(var m=0;5>m;m++)a["SoilTemperature_"+m]={value:n.get_SoilTemperature(m),unit:"[°C]"};a.ActualEvaporation={value:o.get_ActualEvaporation(),unit:"[mm]"},a.Evapotranspiration={value:o.get_Evapotranspiration(),unit:"[mm]"},a.ET0={value:o.get_ET0(),unit:"[mm]"},a.KcFactor={value:o.get_KcFactor(),unit:"[?]"},a.AtmosphericCO2Concentration={value:t.get_AtmosphericCO2Concentration(),unit:"[ppm]"},a.GroundwaterDepth={value:t.get_GroundwaterDepth(),unit:"[m]"},a.GroundwaterRecharge={value:o.get_GroundwaterRecharge(),unit:"[mm]"},a.NLeaching={value:s.get_NLeaching(),unit:"[kg (N) ha-1]"};for(var m=0;u>m;m++)a["SoilNO3_"+m]={value:l.soilLayer(m).get_SoilNO3(),unit:"[kg (N) m-3]"};a.SoilCarbamid={value:l.soilLayer(0).get_SoilCarbamid(),unit:"[kg (N) m-3]"};for(var m=0;u>m;m++)a["SoilNH4_"+m]={value:l.soilLayer(m).get_SoilNH4(),unit:"[kg (N) m-3]"};for(var m=0;4>m;m++)a["SoilNO2_"+m]={value:l.soilLayer(m).get_SoilNO2(),unit:"[kg (N) m-3]"};for(var m=0;6>m;m++)a["SoilOrganicCarbon_"+m]={value:l.soilLayer(m).vs_SoilOrganicCarbon(),unit:"[kg (C) kg-1]"}}else a=null;ENVIRONMENT_IS_WORKER?postMessage({progress:a}):logger(MSG.INFO,a?a.date.value:"done")};return{run:u}};

if (ENVIRONMENT_IS_NODE) {

  var fs = require('fs');
  var sql = require('./sql.js');
  var filebuffer = fs.readFileSync('./monica.sqlite');
  var db = new sql.Database(filebuffer);
  exports.Configuration = Configuration;
  exports.config = example_config;
  exports.db = db;

} else if (ENVIRONMENT_IS_WORKER) {

  importScripts('./sql.js');
  var db = null;
  var req = new XMLHttpRequest();
  req.open('GET', './monica.sqlite', true);
  req.responseType = "arraybuffer";
  req.onload = function (evt) {
    var arrayBuffer = req.response;
    if (arrayBuffer) {
      var byteArray = new Uint8Array(arrayBuffer);
      db = new SQL.Database(byteArray);  
      monica.db = db;
    }
  };
  req.send(null);

  monica.Configuration = Configuration;
  monica.config = example_config;
  var fs = null;

  onmessage = function (evt) {
    if (evt.data.hasOwnProperty('sql')) {
      postMessage(monica.db.exec(evt.data.sql));
    } else if (evt.data.hasOwnProperty('run')) {
      var config = evt.data.run;
      var cfg = new Configuration(null, config.weather, config.debug);
      postMessage(cfg.run(config.sim, config.site, config.crop));
    } else {
      postMessage(null);
    }
  };

} else {

  /* we expect that window.SQL is available */
  var db = null;
  var req = new XMLHttpRequest();
  req.open('GET', './monica.sqlite', true);
  req.responseType = "arraybuffer";
  req.onload = function (evt) {
    var arrayBuffer = req.response;
    if (arrayBuffer) {
      var byteArray = new Uint8Array(arrayBuffer);
      db = new SQL.Database(byteArray);  
      monica.db = db;
    }
  };
  req.send(null);

  monica.Configuration = Configuration;
  monica.config = example_config;
  var fs = null;

}

}());
